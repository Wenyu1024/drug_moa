---
title: "PRISM analysis"
author: "Wenyu"
date: "4/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggsci)
```

# 1
collect the screening drug and their target as well as additional annotation (clinical stage) for plotting

```{r}
prism_drugs <- read_csv("~/cluster_scratch/prism/screened_drugs.csv")
prism_sc_data <- read_csv("~/cluster_scratch/prism/secondary-screen-dose-response-curve-parameters.csv")
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
# load("~/cluster_scratch/forward_modelling/forwardmodelling_all_update.RData")
repurposinghub_drug <- read_csv("~/cluster_scratch/prism/drug_repurposing_hub_nobroadid.csv")
repurposinghub_sample <- read_csv("~/cluster_scratch/prism/drug_repurposing_hub_sample.csv")

sc_druglist <- unique(prism_sc_data$broad_id)
prism_drugs <- prism_drugs %>% 
  mutate(phase= case_when(
  broad_id %in% sc_druglist ~ 2,
    TRUE ~ 1
))

repurposinghub_drug <- repurposinghub_drug %>% 
  left_join(repurposinghub_sample) %>% distinct()
rm(repurposinghub_sample)
prism_drugs <- prism_drugs %>% 
  left_join(repurposinghub_drug) 

prism_sc_drug <-  prism_sc_data %>% 
  select(broad_id, target, phase,moa) %>% 
  left_join(prism_drugs %>% select(broad_id, drug_category)) %>% 
  distinct() %>% 
  separate(col = broad_id, 
           into=c("BRD","id", NA), 
           sep = "-", remove = T, extra= "drop" ) %>% 
  unite("broad_id", BRD:id, sep = "-") %>%
  filter(broad_id %in% prism_data$BROAD_ID) %>% 
  filter(!is.na(drug_category)) %>% 
  group_by(broad_id, phase, drug_category) %>% 
  summarize(target = paste(target, collapse = ","),
            moa= paste(moa, collapse = ",")) 
# write_csv(prism_sc_drug, "~/cluster_scratch/prism/drug_repurposing_scdrugsmeta.csv")
res_prism_long <- res_prism2
res_prism2 <- res_prism_long %>%
  select(BROAD_ID, .metric, input, estimate, name, drug_category, smiles,sample_size) %>% 
  filter(.metric== "spearman coef") %>% 
  pivot_wider(names_from = input, values_from= estimate) %>% 
  mutate(acc_sen= (ceres+ces+demeter2)/3) %>% 
  drop_na() %>% 
  distinct() 
```
Annotations proportions

Non-Cancer drugs is poorly studied 
even it is approved drugs

check specifically how many drug target pairs available for different target
```{r,fig.height=3.5, fig.width=3}
drug_by_category <-  prism_sc_data %>% 
  select(broad_id, target, phase) %>% 
  left_join(prism_drugs %>% select(broad_id, drug_category)) %>% 
  distinct() %>% 
  separate(col = broad_id, 
           into=c("BRD","id", NA), 
           sep = "-", remove = T, extra= "drop" ) %>% 
  unite("broad_id", BRD:id, sep = "-") %>%
  filter(broad_id %in% prism_data$BROAD_ID) %>% 
  filter(!is.na(drug_category)) %>% 
  group_by(broad_id, phase, drug_category) %>% 
  summarize(target = paste(target, collapse = ",")) 

# 1448 drugs including the withdrawn drugs. Could the withdrawn be due to the wrong target information that lead to unexpected result?
# there are too little of them to draw conclusions.

targetinfo_drug_by_category <- drug_by_category %>% 
  filter(phase!="Withdrawn") %>% 
  mutate(drug_phase= case_when(
    phase =="Launched" ~  "Launched",
    TRUE ~ "Under Development"
  )) %>%
  # mutate(drug_phase= case_when(
  #   phase %in%  c("Phase 1",  "Phase 1/Phase 2",  "Phase 2", "Phase 2/Phase 3", "Phase 3") ~  "In trail",
  #   TRUE ~ phase
  # )) %>% 
  select(-phase) %>% 
  mutate(target_missing= (target == "NA")) %>% 
  group_by(drug_phase, drug_category) %>% 
  summarize(na_count= sum(target_missing),
            total_count= n()) %>% 
  mutate(na_percentage= na_count/ total_count) %>% 
  mutate(drug_category= fct_relevel(drug_category, levels= c("targeted cancer", "chemo", "noncancer") )) %>% 
  mutate(drug_phase= fct_relevel(drug_phase, levels= c("Launched", "Under Development") )) %>%
  arrange(drug_category, drug_phase) %>% 
  select(drug_category, drug_phase,total_count,na_count,  na_percentage)

fig <- targetinfo_drug_by_category %>% 
   ggplot(aes(x=drug_category, y= na_count, fill=drug_category)) +
  # geom_col(position = "fill")
  geom_bar(stat="identity",position = position_dodge())+
  # geom_text(aes(label=na_count), size=3, nudge_y = 0.01) +
  ggsci::scale_fill_aaas()+
  theme_classic()+
  # ylim(c(0, 0.35))+
  # scale_y_continuous(labels = scales::percent)+
  facet_wrap(~drug_phase)+
  theme(axis.text.x   = element_blank(), axis.title.x = element_blank())+
  ylab("No. of drugs lacking target info")+
  guides(fill=guide_legend(title="Drug Category",nrow = 2,title.position = "top"))+
  theme(legend.position = "top")
  # theme(
  #   legend.position = c(0, 0.95),
  #   legend.justification = c("left", "top"),
  #   legend.box.just = "right"
  #   )
fig
ggsave(fig,filename = "~/cluster_wrk/drug_moa/predicting_prism/fig_res/fig6a.tiff",device = "tiff",width = 3,height = 3.5,units = "in",dpi = 300)
ggsave(fig,filename = "~/cluster_wrk/drug_moa/predicting_prism/fig_res/fig6a.pdf",device = "pdf",width = 3,height = 3)
```

# 2
Explaining the sensitivity fitting accuracy of PRISM
Bimodality coefficient and fitting accuracy 
```{r,fig.width=4,fig.height=4}
# bimodality <- read_csv("~/cluster_scratch/prism/biomodality.csv") %>% 
#   separate(col = broad_id, 
#            into=c("BRD","id", NA), 
#            sep = "-", remove = T, extra= "drop" ) %>% 
#   unite("drug", BRD:id, sep = "-") %>% 
#   group_by(drug) %>% 
#   summarise(bimodality_coefficient= median(bimodality_coefficient))

# bimodality_coefficient <- function(x, na.rm=FALSE) {
#   
#   # Remove missing values, if desired
#   if (na.rm) {
#     x <- x[!is.na(x)]
#   }
#   
#   n <- length(x)
#   if (n == 0) {
#     # The coefficient is not defined for
#     # empty data
#     return(NaN)  
#   } else {
#         
#     m3 <- psych::skew(x, type=2)
#     m4 <- psych::kurtosi(x, type=2)
#     
#     # Calculate the coefficient based on
#     # the above
#     bc <- (m3^2 + 1) /
#       (m4 + 3 * ((n - 1)^2 / ((n - 2) * (n - 3))))
#     
#     return(bc)
#   }
#   
# }
# 
# bimodality <- prism_data %>% 
#   mutate(bi_coef= map_dbl(sensitivity,
#                           .f =function(x){
#                             tmp <- bimodality_coefficient(x$auc)
#                           }  )) %>% 
#   select(BROAD_ID, bi_coef)
# write_csv(bimodality, "~/cluster_wrk/drug_moa/predicting_prism/bimodality_coef_auc.csv")
# 
#   
# tmp <- inner_join(x = res_prism2, y = bimodality,by= "BROAD_ID") %>% 
#   mutate(acc_sen= (ceres+ces+demeter2)/3) %>% 
#   filter(sample_size>100)
# 
# fig <- tmp %>% 
#   mutate(drug_category= fct_relevel(drug_category, levels= c("targeted cancer", "chemo", "noncancer") )) %>% 
#   ggplot(aes(y=acc_sen , x= bi_coef,color= drug_category)) + 
#   geom_point(size = 0.2)+
#   geom_smooth(method = "lm", se = FALSE)+
#   theme_classic()+
#   ylab("Sensitivity fitting accuracy")+
#   xlab("Bimodality coefficient")+
#   guides(color= guide_legend(title = "Drug Category"))+
#   theme(
#     legend.position = c(1, 0.00),
#     legend.justification = c("right", "bottom"),
#     legend.box.just = "right"
#     )+
#   scale_color_aaas()
# 
# 
# fig <- ggExtra::ggMarginal(fig,type= "boxplot",groupColour = T,groupFill = T) 
# fig
```


jing proposed that the mean/variance of drug sensitivities
may also impact sensitivity fitting accuracy

generate mean and variance based on the prism_data object

```{r,fig.width=3.5,fig.height=5}
get_auc_mean <- function(df){mean(df$auc, na.rm = T)}
get_auc_variance <- function(df){sd(df$auc, na.rm = T)}

sen_mean_var <- prism_data %>% 
  select(BROAD_ID, sensitivity) %>% 
  mutate(
    sen_mean=map_dbl(.x = sensitivity, .f = get_auc_mean),
    sen_sd=map_dbl(.x = sensitivity, .f = get_auc_variance)
         ) %>% 
  select(-sensitivity) %>% 
  inner_join(res_prism2)

fig <- sen_mean_var %>% 
  mutate(drug_category= fct_relevel(drug_category, levels= c( "chemo","targeted cancer", "noncancer") )) %>%
  ggplot(aes(y=acc_sen , x= sen_mean,color= drug_category)) + 
  geom_point(size = 0.2)+
  geom_smooth(method = "lm", se = FALSE)+
  theme_classic()+
  ylab("Sensitivity fitting accuracy")+
  xlab("Average sensitivity")+
  guides(color= guide_legend(title = "Drug Category",nrow = 3))+
  scale_color_aaas()+
  theme(legend.position="top")
fig

ggExtra::ggMarginal(fig, type= "boxplot",groupColour = T,groupFill = T) 
```


## 3 Imp correlation across different dataset
imp correlation across different dataset
get a shared list of drugs across three set
```{r,fig.width=10,fig.height=3}
cross_ref_tibble_gdsc <- read_csv("~/cluster_scratch/prior/drug_id_list/cross_ref_tibble_gdsc")
overlapping_drug_list <- sort(intersect(intersect(cross_ref_tibble_gdsc$BROAD_ID, ctrp_data$broad_cpd_id), prism_data$BROAD_ID)) # 44 drugs available (in nature cancer paper 84 compound and median 236 cell line)

imp_ctrp_shared <- feature_imp_ridge_ctrp_comb1 %>% filter(drug %in% overlapping_drug_list) %>% arrange(drug)

imp_prism_shared <- feature_imp_ridge_prism_comb1 %>% 
  filter(drug %in% overlapping_drug_list) %>% arrange(drug)

imp_gdsc_shared <- cross_ref_tibble_gdsc %>% 
  inner_join(  feature_imp_ridge_gdsc_comb1, by =c("DRUG_ID"= "drug")) %>% 
  select(-pubchem_cid, -DRUG_ID) %>% 
  rename(drug= BROAD_ID) %>% 
  filter(drug %in% overlapping_drug_list) %>% 
  arrange(drug)

get_cor_long_tibble <- function(df1,df2){ 
  cor_mat <- cor(
    x = t(df1[,-1]),
    y= t(df2[,-1]),
    method = "pearson"
    )
  cor_vec <- diag(cor_mat)
  }


cor_tibble <- tibble(
  drug= imp_ctrp_shared$drug, 
  ctrp_gdsc = get_cor_long_tibble(imp_ctrp_shared, imp_gdsc_shared), 
  ctrp_prism = get_cor_long_tibble(imp_ctrp_shared, imp_prism_shared), 
  gdsc_prism = get_cor_long_tibble(imp_prism_shared, imp_gdsc_shared)) %>% 
  inner_join(
    prism_data %>% select(BROAD_ID, name,drug_category), 
    by= c("drug"= "BROAD_ID")) %>% 
  # select(-drug) %>% 
  arrange(ctrp_gdsc)


cor_tibble %>% 
  select(-drug, -drug_category) %>% 
  pivot_longer(cols=-name, names_to= "across_dataset", values_to= "COR") %>%
  arrange(across_dataset, COR) %>% 
  mutate_at(1,factor,
            levels= cor_tibble$name) %>% 
  mutate_at(2,factor,
          levels=c("ctrp_gdsc", "ctrp_prism", "gdsc_prism"),
          labels = c("CTRP-GDSC", "CTRP-PRISM", "GDSC-PRISM")
          ) %>%
  ggplot(aes(x= name,  y= COR, fill= across_dataset))+
  geom_bar(stat = "identity", position = position_dodge())+
  scale_fill_npg()+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, colour = ))+
  theme(axis.title.x = element_blank()) +
  theme(legend.title = element_blank()) 
```


# 4
Explore the supervised prediction of PRISM with different fitting accuracy
```{r}
load("~/cluster_scratch/forward_modelling/targetpred_output_prismgoodbadexplore1.RData")

plot_two_group <- function(good_df, bad_df){
  df <- bind_rows(
    good_df %>% mutate(fitting_quality= "good"),
    bad_df %>% mutate(fitting_quality= "bad"),
    acc_df_prism_binary_fold_cv %>% mutate(fitting_quality= "general")
  ) %>% 
    mutate(fitting_quality= fct_relevel(fitting_quality, c("general", "good", "bad")) ) 
    # mutate(method= fct_relevel(method, c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS")) ) %>% 
    # mutate(method= fct_relabel(method, ... = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" )) )    
  
    df$method <-
     factor(df$method,
            levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"),
            labels = c("ess-sig", "exp-sig", "ECFP","MACCS" ))
  
  df %>% 
    ggplot(aes(x= method,y=acc, fill= method )) + 
    geom_violin()+
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
             colour = "black",position = position_dodge(width = 0.9),size=0.2)+
    ggsci::scale_fill_npg()+
    facet_wrap(~fitting_quality)+
    theme_classic()+
    ylab(label = "Supervised Target Prediction (AUC)")+
    theme(legend.position="top")+
    theme(axis.text.x = element_blank(), axis.title.x = element_blank())+
    # labs(fill= "Drug Representation")
    guides(fill= guide_legend(title = "Drug Representation", nrow = 2,title.position = "top"))
}
```


```{r,fig.height=4, fig.width=2.5}
plot_two_group(good_df = acc_df_prism_binary_fold_cv_good200,bad_df = acc_df_prism_binary_fold_cv_bad200)
  # theme(legend.position = c(.2, .2))
# plot_two_group(good_df = acc_df_prism_binary_fold_cv_good100,bad_df = acc_df_prism_binary_fold_cv_bad100)
# plot_two_group(good_df = acc_df_prism_binary_fold_cv_good300,bad_df = acc_df_prism_binary_fold_cv_bad300)
# plot_two_group(good_df = acc_df_prism_binary_fold_cv_goodhalf,bad_df = acc_df_prism_binary_fold_cv_badhalf)
```

Okay, lets further check unsupervised target prediction of PRISM
There are NA because now prediction is only available for genes with signature values.
It is possible the only target gene of a drug does not have prediction value hence the AUC is not available. 

check where the function is defined
```{r}
PRISM_binary_PPIold_data <- read_csv( "~/cluster_scratch/prior/PRISM_binary_PPIold_data.csv")

# load("~/cluster_scratch/unsupervised_target_pred/unsupervised_target_pred_method_comparison.RData")
# prism_auc_comparison <-  prism_unsupervised_auc %>% filter(drug %in% prism_drug_list_drh)
```


```{r,fig.width=4, fig.height=4}
source("~/cluster_wrk/drug_moa/unsupervised_target_exploration/function/plot_ave_roc.R")
plot_ave_roc(annotated_pred_df = PRISM_binary_PPIold_data %>% 
               filter(drug %in% prism_good_drug_list_200),
             title = "Best fitted drugs")

plot_ave_roc(annotated_pred_df = PRISM_binary_PPIold_data %>% 
               filter(drug %in% prism_bad_drug_list_200),
             title = "Worst fitted drugs")

plot_ave_roc(annotated_pred_df = PRISM_binary_PPIold_data %>% 
               filter(drug %in% prism_drug_list_drh),
             title = "All drugs")

```


ConSensig unsupervised prediction acc and sen fitting acc, by drug type
also use a scatter plot + marginal boxplot
fitting accuracy against unsupervised target prediction.
```{r,fig.width=5,fig.height=5}
# tmp <- inner_join(x = res_prism2, 
#                   y = prism_auc %>% filter(imptype== "ConSen-Sig"),
#                   by= c("BROAD_ID" = "drug")) %>% 
#   mutate(acc_sen= (ceres+ces+demeter2)/3) %>% 
#   filter(sample_size>100) %>% 
#   drop_na()

# # Does withdrawn dr has bad fitting acc (no use for the paper)
# tmp1 <-  prism_sc_data %>% 
#   select(broad_id, target, phase) %>% 
#   left_join(prism_drugs %>% select(broad_id, drug_category)) %>% 
#   distinct() %>% 
#   separate(col = broad_id, 
#            into=c("BRD","id", NA), 
#            sep = "-", remove = T, extra= "drop" ) %>% 
#   unite("broad_id", BRD:id, sep = "-") %>%
#   filter(broad_id %in% prism_data$BROAD_ID) %>% 
#   filter(!is.na(drug_category)) %>% 
#   group_by(broad_id, phase, drug_category) %>% 
#   summarize(target = paste(target, collapse = ",")) 
# 
# tmp2 <- tmp1 %>% 
#   filter(phase== "Withdrawn") %>% 
#   inner_join(tmp,by=c("broad_id"= "BROAD_ID"))

# fig <- tmp %>% 
#   mutate(drug_category= fct_relevel(drug_category, levels= c("targeted cancer", "chemo", "noncancer") )) %>% 
#   ggplot(aes(y= AUC, x= acc_sen,color= drug_category)) + 
#   geom_point(size = 0.5,position = "dodge")+
#   # geom_smooth(method = "lm", se = FALSE)+
#   theme_classic()+
#   ylab("Unsupervised target prediction")+
#   xlab("Sensitivity fitting accuracy")+
#   guides(color= guide_legend(title = "Drug Category"))+
#   theme(
#     legend.position = c(1, 0.00),
#     legend.justification = c("right", "bottom"),
#     legend.box.just = "right"
#     )+
#   scale_color_aaas()
#   # annotate("COR ", x = 4, y = 25, label = "Some text")+
# fig 
#   ggExtra::ggMarginal(fig,groupColour = T,groupFill = T,size = 5,position = "dodge") 
```


