---
title: "PRISM analysis"
author: "Wenyu"
date: "4/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggsci)
```

# 1
collect the screening drug and their target as well as additional annotation (clinical stage) for plotting

```{r}
prism_drugs <- read_csv("~/cluster_scratch/prism/screened_drugs.csv")
prism_sc_data <- read_csv("~/cluster_scratch/prism/secondary-screen-dose-response-curve-parameters.csv")

sc_druglist <- unique(prism_sc_data$broad_id)
prism_drugs <- prism_drugs %>% 
  mutate(phase= case_when(
  broad_id %in% sc_druglist ~ 2,
    TRUE ~ 1
))

repurposinghub_drug <- read_csv("~/cluster_scratch/prism/drug_repurposing_hub_nobroadid.csv")
repurposinghub_sample <- read_csv("~/cluster_scratch/prism/drug_repurposing_hub_sample.csv")
repurposinghub_drug <- repurposinghub_drug %>% 
  left_join(repurposinghub_sample) %>% distinct()
rm(repurposinghub_sample)
prism_drugs <- prism_drugs %>% 
  left_join(repurposinghub_drug) 

prism_sc_drug <-  prism_sc_data %>% 
  select(broad_id, target, phase,moa) %>% 
  left_join(prism_drugs %>% select(broad_id, drug_category)) %>% 
  distinct() %>% 
  separate(col = broad_id, 
           into=c("BRD","id", NA), 
           sep = "-", remove = T, extra= "drop" ) %>% 
  unite("broad_id", BRD:id, sep = "-") %>%
  filter(broad_id %in% prism_data$BROAD_ID) %>% 
  filter(!is.na(drug_category)) %>% 
  group_by(broad_id, phase, drug_category) %>% 
  summarize(target = paste(target, collapse = ","),
            moa= paste(moa, collapse = ",")) 
write_csv(prism_sc_drug, "~/cluster_scratch/prism/drug_repurposing_scdrugsmeta.csv")
```
Annotations proportions

Non-Cancer drugs is poorly studied 
even it is approved drugs

check specifically how many drug target pairs available for different target
```{r,fig.height=3.5, fig.width=3}
tmp <-  prism_sc_data %>% 
  select(broad_id, target, phase) %>% 
  left_join(prism_drugs %>% select(broad_id, drug_category)) %>% 
  distinct() %>% 
  separate(col = broad_id, 
           into=c("BRD","id", NA), 
           sep = "-", remove = T, extra= "drop" ) %>% 
  unite("broad_id", BRD:id, sep = "-") %>%
  filter(broad_id %in% prism_data$BROAD_ID) %>% 
  filter(!is.na(drug_category)) %>% 
  group_by(broad_id, phase, drug_category) %>% 
  summarize(target = paste(target, collapse = ",")) 

# 1448 drugs including the withdrawn drugs. Could the withdrawn be due to the wrong target information that lead to unexpected result?

tmp1 <- tmp %>% 
  filter(phase!="Withdrawn") %>% 
  mutate(drug_phase= case_when(
    phase =="Launched" ~  "Launched",
    TRUE ~ "Under Development"
  )) %>%
  # mutate(drug_phase= case_when(
  #   phase %in%  c("Phase 1",  "Phase 1/Phase 2",  "Phase 2", "Phase 2/Phase 3", "Phase 3") ~  "In trail",
  #   TRUE ~ phase
  # )) %>% 
  select(-phase) %>% 
  mutate(target_missing= (target == "NA")) %>% 
  group_by(drug_phase, drug_category) %>% 
  summarize(na_count= sum(target_missing),
            total_count= n()) %>% 
  mutate(na_percentage= na_count/ total_count) %>% 
  mutate(drug_category= fct_relevel(drug_category, levels= c("targeted cancer", "chemo", "noncancer") )) %>% 
  mutate(drug_phase= fct_relevel(drug_phase, levels= c("Launched", "Under Development") )) %>%
  arrange(drug_category, drug_phase) %>% 
  select(drug_category, drug_phase,total_count,na_count,  na_percentage)

tmp1 %>% 
   ggplot(aes(x=drug_category, y= na_count, fill=drug_category)) +
  # geom_col(position = "fill")
  geom_bar(stat="identity",position = position_dodge())+
  # geom_text(aes(label=na_count), size=3, nudge_y = 0.01) +
  ggsci::scale_fill_aaas()+
  theme_classic()+
  # ylim(c(0, 0.35))+
  # scale_y_continuous(labels = scales::percent)+
  facet_wrap(~drug_phase)+
  theme(axis.text.x   = element_blank(), axis.title.x = element_blank())+
  ylab("No. of drugs lacking target info")+
  guides(fill=guide_legend(title="Drug Category",nrow = 2,title.position = "top"))+
  theme(legend.position = "top")
  # theme(
  #   legend.position = c(0, 0.95),
  #   legend.justification = c("left", "top"),
  #   legend.box.just = "right"
  #   )
```

# 2
Explaining the sensitivity fitting accuracy of PRISM
Bimodality coefficient and fitting accuracy 
```{r,fig.width=4,fig.height=4}
bimodality <- read_csv("~/cluster_scratch/prism/biomodality.csv") %>% 
  separate(col = broad_id, 
           into=c("BRD","id", NA), 
           sep = "-", remove = T, extra= "drop" ) %>% 
  unite("drug", BRD:id, sep = "-") %>% 
  group_by(drug) %>% 
  summarise(bimodality_coefficient= median(bimodality_coefficient))
  
tmp <- inner_join(x = res_prism2, y = bimodality,by= c("BROAD_ID" = "drug")) %>% 
  mutate(acc_sen= (ceres+ces+demeter2)/3) %>% 
  filter(sample_size>100)
  # filter(BROAD_ID %in% prism_drug_list)

fig <- tmp %>% 
  mutate(drug_category= fct_relevel(drug_category, levels= c("targeted cancer", "chemo", "noncancer") )) %>% 
  ggplot(aes(y=acc_sen , x= bimodality_coefficient,color= drug_category)) + 
  geom_point(size = 0.2)+
  geom_smooth(method = "lm", se = FALSE)+
  theme_classic()+
  ylab("Sensitivity fitting accuracy")+
  xlab("Bimodality coefficient")+
  guides(color= guide_legend(title = "Drug Category"))+
  theme(
    legend.position = c(1, 0.00),
    legend.justification = c("right", "bottom"),
    legend.box.just = "right"
    )+
  scale_color_aaas()

ggExtra::ggMarginal(fig,type= "boxplot",groupColour = T,groupFill = T) 

# cor(tmp$acc_sen, tmp$bimodality_coefficient,use = "complete.obs")
# 
# pal_aaas(alpha = 1)(4)
```



## 3 Imp correlation across different dataset
imp correlation across different dataset
get a shared list of drugs across three set
```{r,fig.width=10,fig.height=3}
cross_ref_tibble_gdsc <- read_csv("~/cluster_scratch/prior/drug_id_list/cross_ref_tibble_gdsc")
overlapping_drug_list <- sort(intersect(intersect(cross_ref_tibble_gdsc$BROAD_ID, ctrp_data$broad_cpd_id), prism_data$BROAD_ID)) # 44 drugs available (in nature cancer paper 84 compound and median 236 cell line)

imp_ctrp_shared <- feature_imp_ridge_ctrp_comb1 %>% filter(drug %in% overlapping_drug_list) %>% arrange(drug)

imp_prism_shared <- feature_imp_ridge_prism_comb1 %>% 
  filter(drug %in% overlapping_drug_list) %>% arrange(drug)

imp_gdsc_shared <- cross_ref_tibble_gdsc %>% 
  inner_join(  feature_imp_ridge_gdsc_comb1, by =c("DRUG_ID"= "drug")) %>% 
  select(-pubchem_cid, -DRUG_ID) %>% 
  rename(drug= BROAD_ID) %>% 
  filter(drug %in% overlapping_drug_list) %>% 
  arrange(drug)

get_cor_long_tibble <- function(df1,df2){ 
  cor_mat <- cor(
    x = t(df1[,-1]),
    y= t(df2[,-1]),
    method = "pearson"
    )
  cor_vec <- diag(cor_mat)
  }


# I say we should not use this as the n is fixed and quite large. the ci is going to be quite small
# Just two bar plot with two points, similiar to the ones shown in  Extended Data Fig. 5

# get_ci_r <- function(x){
#   tmp <- DescTools::CorCI(rho=x, n=10623, conf.level = 0.95)
#   
# } 


cor_tibble <- tibble(drug= imp_ctrp_shared$drug, 
                     ctrp_gdsc = get_cor_long_tibble(imp_ctrp_shared, imp_gdsc_shared), 
                     ctrp_prism = get_cor_long_tibble(imp_ctrp_shared, imp_prism_shared), 
                     gdsc_prism = get_cor_long_tibble(imp_prism_shared, imp_gdsc_shared)) %>% 
  inner_join(ctrp_data %>% select(broad_cpd_id, cpd_name), by= c("drug"= "broad_cpd_id")) %>% 
  select(-drug) %>% 
  rename(drug=cpd_name) %>% 
  arrange(ctrp_gdsc)

cor_tibble %>% 
  pivot_longer(cols=-drug, names_to= "across_dataset", values_to= "COR") %>%
  arrange(across_dataset, COR) %>% 
  mutate_at(1,factor,
            levels= cor_tibble$drug) %>% 
  mutate_at(2,factor,
          levels=c("ctrp_gdsc", "ctrp_prism", "gdsc_prism"),
          labels = c("CTRP-GDSC", "CTRP-PRISM", "GDSC-PRISM")
          ) %>%
  ggplot(aes(x= drug,  y= COR, fill= across_dataset))+
  geom_bar(stat = "identity", position = position_dodge())+
  scale_fill_npg()+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(axis.title.x = element_blank()) +
  theme(legend.title = element_blank()) 
```


# 4
Explore the supervised prediction of PRISM with different fitting accuracy
```{r}
load("~/cluster_scratch/forward_modelling/targetpred_output_prismgoodbadexplore.RData")
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")

plot_two_group <- function(good_df, bad_df){
  df <- bind_rows(
    good_df %>% mutate(fitting_quality= "good"),
    bad_df %>% mutate(fitting_quality= "bad"),
    acc_df_prism_binary_fold_cv %>% mutate(fitting_quality= "general")
  ) %>% 
    mutate(fitting_quality= fct_relevel(fitting_quality, c("general", "good", "bad")) ) 
    # mutate(method= fct_relevel(method, c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS")) ) %>% 
    # mutate(method= fct_relabel(method, ... = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" )) )    
  
    df$method <-
     factor(df$method,
            levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"),
            labels = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))
  
  df %>% 
    ggplot(aes(x= method,y=acc, fill= method )) + 
    geom_violin()+
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
             colour = "black",position = position_dodge(width = 0.9))+
    ggsci::scale_fill_npg()+
    facet_wrap(~fitting_quality)+
    theme_classic()+
    ylab(label = "Supervised Target Prediction (AUC)")+
    theme(legend.position="right")+
    theme(axis.text.x = element_blank(), axis.title.x = element_blank())+
    labs(fill= "Drug Representation")
    # guides(fill= guide_legend(title = "aa", nrow = 4,title.position = "top"))
}
```


```{r,fig.height=3, fig.width=5}
plot_two_group(good_df = acc_df_prism_binary_fold_cv_good200,bad_df = acc_df_prism_binary_fold_cv_bad200)

# plot_two_group(good_df = acc_df_prism_binary_fold_cv_good100,bad_df = acc_df_prism_binary_fold_cv_bad100)
# plot_two_group(good_df = acc_df_prism_binary_fold_cv_good300,bad_df = acc_df_prism_binary_fold_cv_bad300)
# plot_two_group(good_df = acc_df_prism_binary_fold_cv_goodhalf,bad_df = acc_df_prism_binary_fold_cv_badhalf)
```

Okay, lets further check unsupervised target prediction of PRISM
There are NA because now prediction is only available for genes with signature values.
It is possible the only target gene of a drug does not have prediction value hence the AUC is not avaliable. 

```{r}
PRISM_binary_PPIold_data <- read_csv( "~/cluster_scratch/prior/PRISM_binary_PPIold_data.csv")

prism_auc_comparison <-  prism_auc %>% filter(drug %in% prism_drug_list_drh)
```


```{r,fig.width=4, fig.height=4}
get_ave_roc(sig_to_pred(annotated_sig_df=PRISM_binary_PPIold_data %>% filter(drug %in% prism_good_drug_list_200 )),title = "Best fitted drugs")

get_ave_roc(sig_to_pred(annotated_sig_df=PRISM_binary_PPIold_data %>% filter(drug %in% prism_bad_drug_list_200 )),title = "Worst fitted drugs")

get_ave_roc(sig_to_pred(annotated_sig_df=PRISM_binary_PPIold_data %>% filter(drug %in% prism_drug_list_drh )),title = "All drugs")
```


ConSensig unsupervised prediction acc and sen fitting acc, by drug type
also use a scatter plot + marginal boxplot
fitting accuracy against unsupervised target prediction.
```{r,fig.width=5,fig.height=5}
# tmp <- inner_join(x = res_prism2, 
#                   y = prism_auc %>% filter(imptype== "ConSen-Sig"),
#                   by= c("BROAD_ID" = "drug")) %>% 
#   mutate(acc_sen= (ceres+ces+demeter2)/3) %>% 
#   filter(sample_size>100) %>% 
#   drop_na()

# # Does withdrawn dr has bad fitting acc (no use for the paper)
# tmp1 <-  prism_sc_data %>% 
#   select(broad_id, target, phase) %>% 
#   left_join(prism_drugs %>% select(broad_id, drug_category)) %>% 
#   distinct() %>% 
#   separate(col = broad_id, 
#            into=c("BRD","id", NA), 
#            sep = "-", remove = T, extra= "drop" ) %>% 
#   unite("broad_id", BRD:id, sep = "-") %>%
#   filter(broad_id %in% prism_data$BROAD_ID) %>% 
#   filter(!is.na(drug_category)) %>% 
#   group_by(broad_id, phase, drug_category) %>% 
#   summarize(target = paste(target, collapse = ",")) 
# 
# tmp2 <- tmp1 %>% 
#   filter(phase== "Withdrawn") %>% 
#   inner_join(tmp,by=c("broad_id"= "BROAD_ID"))

# fig <- tmp %>% 
#   mutate(drug_category= fct_relevel(drug_category, levels= c("targeted cancer", "chemo", "noncancer") )) %>% 
#   ggplot(aes(y= AUC, x= acc_sen,color= drug_category)) + 
#   geom_point(size = 0.5,position = "dodge")+
#   # geom_smooth(method = "lm", se = FALSE)+
#   theme_classic()+
#   ylab("Unsupervised target prediction")+
#   xlab("Sensitivity fitting accuracy")+
#   guides(color= guide_legend(title = "Drug Category"))+
#   theme(
#     legend.position = c(1, 0.00),
#     legend.justification = c("right", "bottom"),
#     legend.box.just = "right"
#     )+
#   scale_color_aaas()
#   # annotate("COR ", x = 4, y = 25, label = "Some text")+
# fig 
#   ggExtra::ggMarginal(fig,groupColour = T,groupFill = T,size = 5,position = "dodge") 
```


