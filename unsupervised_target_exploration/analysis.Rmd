---
title: "Unsupervised target and network analysis for CTRP and GDSC data"
author: "Wenyu"
date: "5/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggsci)
library(ggpubr)
```




### 1 Global analysis of top genes and target

```{r}
CTRP_binary_PPIold_data <- read_csv( "~/cluster_scratch/prior/CTRP_binary_PPIold_data.csv") 
GDSC_binary_PPIold_data <- read_csv( "~/cluster_scratch/prior/GDSC_binary_PPIold_data.csv") 
```

check data correctness
```{r}

# #first check if sig value is correct here
# # BRD-K28360340	BCL2
# CTRP_binary_PPIold_data %>% 
#   filter(drug== "BRD-K28360340") %>% 
#   filter(gene=="BCL2")
# # Why the value is the same?? this is definately wrong
# CTRP_binary_PPIold_data %>% 
#   filter(drug== "BRD-K28392481") %>% 
#   filter(gene=="DDR1")
# 
# setwd("~/cluster_scratch//L1000/consensus_signatures_challenge/")
# drug_consensus_ctrp <- read_csv("feature_consensus_ctrp.csv")
# 
# drug_consensus_ctrp %>% 
#   filter(drug %in% c("BRD-K28392481","BRD-K28360340")) %>% 
#   select(drug,DDR1, BCL2)
```


2) pick top 50, 100, 200 genes and compare to what percentage of drug the target of which can be prioritized by the top genes

```{r,fig.width=4, fig.height=4}
source("~/cluster_wrk/drug_moa/unsupervised_target_exploration/get_drug_frac.R")
target_idf <- bind_rows(
  map_dfr(
    .x = c(50, 100, 200),
    .f = ~get_drug_frac(dataset= CTRP_binary_PPIold_data, top_num=.x)) %>%
    mutate(dataset= "CTRP"),
  map_dfr(.x = c(50, 100, 200),
          .f = ~get_drug_frac(dataset= GDSC_binary_PPIold_data, top_num=.x)) %>%
    mutate(dataset= "GDSC")
)

# Bar plot: pos/neg stack, top_n dodge, imptype x axis, dataset facet
# seems impossible to both stack and dodge

fig <- target_idf %>%
  ggplot(aes(x= factor(top_n),y = frac, fill= impdef)) +
  geom_bar(stat = "identity",position = "stack")+
  facet_grid(cols = vars(dataset), rows = vars(imptype))+
  xlab("top N genes ranked by signature value")+
  ylab("% drugs") +
  scale_fill_manual(values=c("#999999", "#56B4E9"))+
  theme_classic()+
  guides(fill=guide_legend(title="",nrow = 2,title.position = "top"))+
  theme(legend.position = "top")+
  theme(
    legend.position = c(0, 0.98),
    legend.justification = c("left", "top"),
    legend.box.just = "right"
    )
fig
ggsave(fig, filename = "~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig 4A.tiff",width = 4,height = 4)
ggsave(fig, filename = "~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig 4A.pdf",width = 4,height = 4)
```

lets still go back to drug percentage,
checking
```{r}
# get_drug_frac(CTRP_binary_PPIold_data,top_num = 100,res_type = "druglevel") %>% 
#   select(-drug) 
# 
# get_drug_frac(dataset= GDSC_binary_PPIold_data, top_num=100, res_type = "druglevel") %>% 
#     mutate(dataset= "GDSC")
# 
# get_drug_frac(dataset= PRISM_binary_PPIold_data, top_num=100, res_type = "druglevel") %>% 
#     mutate(dataset= "PRISM")
# 
# 
# CTRP_binary_PPIold_data %>% 
#   filter(!(anno_type1 %in% c("Unknown","Not_connected"))) %>% 
#   select(drug) %>% 
#   distinct() %>% 
#   nrow() #196
# 
# GDSC_binary_PPIold_data %>% 
#   filter(!(anno_type1 %in% c("Unknown","Not_connected"))) %>% 
#   select(drug) %>% 
#   distinct() %>% 
#   nrow() # 49
# 
# PRISM_binary_PPIold_data %>% 
#   filter(!(anno_type1 %in% c("Unknown","Not_connected"))) %>% 
#   select(drug) %>% 
#   distinct() %>% 
#   nrow() #805
# 
# 
# tmp <- get_drug_frac(dataset= PRISM_binary_PPIold_data, top_n=100, res_type = "toppair") %>% 
#     mutate(dataset= "PRISM") %>% select(drug) %>% distinct() #918
# 
# # there are 5 drugs the top genes are not 
# tmp <- get_drug_frac(dataset= PRISM_binary_PPIold_data, top_n=100, res_type = "toppair") %>% 
#     filter(!(anno_type1 %in% c("Unknown","Not_connected"))) %>% select(drug) %>% distinct() #918
# tmp1 <- PRISM_binary_PPIold_data %>% 
#   filter(!(anno_type1 %in% c("Unknown","Not_connected"))) %>% 
#   select(drug) %>% 
#   distinct() 
# tmp2 <- setdiff(tmp1,tmp)
# tmp3 <- PRISM_binary_PPIold_data %>% 
#   # filter(!(anno_type1 %in% c("Unknown","Not_connected"))) %>% 
#   filter(drug %in% tmp2$drug)
# # the reason that the 5 drugs are not avaliable is because their target is not among top genes,
# # and all the other genes are not in the network.
```

Supplementary figure 4
```{r, fig.width=4, fig.height=4}
network_idf <- bind_rows(
  get_drug_frac(dataset= CTRP_binary_PPIold_data, top_n=50, res_type = "druglevel") %>% 
    mutate(dataset= "CTRP") %>%  select(-drug) ,
  get_drug_frac(dataset= GDSC_binary_PPIold_data, top_n=50, res_type = "druglevel") %>% 
    mutate(dataset= "GDSC") %>%  select(-drug) 
)

fig <- network_idf %>% 
  group_by(dataset,imptype) %>% 
  mutate(num= n()) %>% 
  mutate(anno_type2 = 
           case_when(
             anno_type2 <1 ~ "Target",
             between(anno_type2,1,2) ~as.character(anno_type2),
             anno_type2>2 ~ "over 2")) %>%    
  ungroup() %>% 
  group_by(impdef, anno_type2,dataset, imptype) %>% 
  summarize(perc= n()/num) %>% 
  ungroup() %>% distinct() %>% 
  mutate(anno_type2= factor(anno_type2,c("Target", "1", "2", "over 2"))) %>% 
  ggplot(aes(x= anno_type2,y=perc, fill= impdef)) +
  geom_bar(stat = "identity",position = "stack")+
  facet_grid(cols = vars(dataset), rows = vars(imptype))+
  xlab("Gene category by PPI target network")+
  ylab("% drugs")  +
    scale_fill_manual(values=c("#999999", "#56B4E9"))+
  theme_classic()+
  guides(fill=guide_legend(title="",nrow = 2,title.position = "top"))+
  theme(legend.position = "none")

fig
ggsave(fig, filename = "~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig s4.tiff",width = 4,height = 4)
ggsave(fig, filename = "~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig s4.pdf",width = 4,height = 4)
```




For top genes, if the are not target then what are they (this plot is ugly)
```{r}
# get_drug_frac(CTRP_binary_PPIold_data,top_num = 100,res_type = "toppair") %>%
#   ggplot(aes(x= imptype, fill= anno_type)) +
#   geom_bar(stat = "count",position = "dodge")
# 
# table(CTRP_binary_PPIold_data1$imptype)
# 
# # for top 100 top and bottom genes how does them distribute in the target network?
# tmp <- CTRP_binary_PPIold_data1 %>% filter(imptype=="ConSen-Sig")
# table(tmp$impdef,tmp$anno_type1)
# tmp <- CTRP_binary_PPIold_data1 %>% filter(imptype=="ConExp-Sig")
# table(tmp$impdef,tmp$anno_type1)
# 
# 
# 
# CTRP_binary_PPIold_data1 %>% 
#   mutate(degree= as.numeric(anno_type)) %>% 
#   drop_na() %>% 
#   group_by(imptype) %>% 
#   summarise(cor= cor(degree, imp,method="spearman"))

```


3) ROC and AUC 



Lets just use abs(imp) to identify T, T+1 T+2 for different dataset
```{r}
# exploration
load("~/cluster_scratch/unsupervised_target_pred/unsupervised_target_pred_method_comparison.RData")
# ctrp_unsupervised_auc %>% ggplot(aes(x= imptype, y= AUC,fill=imptype)) + geom_boxplot()
# gdsc_unsupervised_auc %>% ggplot(aes(x= imptype, y= AUC,fill=imptype)) + geom_boxplot()
# prism_unsupervised_auc %>% ggplot(aes(x= imptype, y= AUC,fill=imptype)) + geom_boxplot()
# 
# ctrp_unsupervised_auc %>% filter(imptype=="ConSen-Sig") %>% pull(AUC) %>% summary()
# ctrp_unsupervised_auc %>% filter(imptype=="ConSen-Sig") %>% pull(AUC) %>% hist()
# tmp5 <- prism_unsupervised_auc %>% 
#   filter(imptype == "ConSen-Sig") %>% 
#   inner_join(acc_final1,by=c("drug"="BROAD_ID")) %>% 
#   filter(drug_category== "noncancer") %>% filter(phase=="Launched")

# tmp <- get_auc(dataset = PRISM_binary_PPIold_data, label_level= 1) 
# tmp %>% ggplot(aes(x= imptype, y= AUC,fill=imptype)) + geom_boxplot()
# 
# tmp <- get_auc(dataset = PRISM_binary_PPIold_data, label_level= 2) 
# tmp %>% ggplot(aes(x= imptype, y= AUC,fill=imptype)) + geom_boxplot()

# tmp5 %>% filter(drug_category== "noncancer") %>% filter(phase=="Launched") %>% pull(AUC) %>% summary()
# tmp5 %>% filter(drug_category== "noncancer") %>% filter(phase=="Launched") %>% pull(acc) %>% summary()
# 
# summary(acc_final2$acc)
```


figure 4B-4C
```{r,fig.height=4, fig.width=4}
source("~/cluster_wrk/drug_moa/unsupervised_target_exploration/plot_ave_roc.R")

tiff("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig 4b.tiff",width = 4.5,height = 4.5,units = "in",res = 300)
# par(mar=c(1,1,1,1))
# par("mar") 
plot_ave_roc(CTRP_binary_PPIold_data, title = "CTRP", addlegend = F)
dev.off() 

pdf("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig 4b.pdf",width = 5,height = 4)
plot_ave_roc(CTRP_binary_PPIold_data, title = "CTRP", addlegend = F)
dev.off() 

tiff("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig 4c.tiff",width = 4.5,height = 4.5,units = "in",res = 300)
plot_ave_roc(GDSC_binary_PPIold_data, title = "GDSC", addlegend = T)
dev.off() 

pdf("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/fig 4c.pdf",width = 3.5,height = 4)
plot_ave_roc(GDSC_binary_PPIold_data, title = "GDSC", addlegend = T)
dev.off() 

```


The drug level auc here should also correlate with the fitting accuracy (not really)
but lets check it later

So lets just show the AUC result for the CTRP and GDSC Target
Supplementary figure 3
```{r,fig.width=5,fig.height=3}
load("~/cluster_scratch/unsupervised_target_pred/unsupervised_target_pred_method_comparison.RData")
auc_df <- 
  bind_rows(
      ctrp_unsupervised_auc %>% select(-drug) %>% mutate(dataset= "CTRP"),
      gdsc_unsupervised_auc %>% select(-drug) %>% mutate(dataset= "GDSC")
)

auc_df %>% 
  drop_na() %>% 
  ggplot(aes(x=imptype, y=AUC,color= imptype)) + 
  geom_violin()+
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
           colour = "black")+
  facet_wrap(~dataset)+
  theme_classic()+
  theme(axis.text.x = element_blank())+
  xlab(label = "")+
  ylab(label = "AUC")+
  # scale_color_manual(name="Cylinders",
  #                  labels=c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))+
  scale_color_npg()
```

does the unsupervised prediction perform better in inhibitor? not really...
```{r}
# ctrp_function_type <- ctrp_data %>% 
#   select(target_or_activity_of_compound, broad_cpd_id) %>% 
#   filter(broad_cpd_id %in% ctrp_drug_list) %>% 
#   mutate(function_type= case_when(
#     str_detect(target_or_activity_of_compound,pattern = "inhibitor") ~ "inhibitor",
#     str_detect(target_or_activity_of_compound,pattern = "agonist") ~ "agonist", 
#     str_detect(target_or_activity_of_compound,pattern = "activator") ~ "activator",
#     str_detect(target_or_activity_of_compound,pattern = "antagonist") ~ "antagonist"
#   ))  
#   
# # group_by(function_type) %>% 
#   # summarize(N=n())
# 
# ctrp_unsupervised_auc %>% 
#   filter(imptype== "ConSen-Sig") %>% 
#   inner_join(ctrp_function_type, by= c("drug"= "broad_cpd_id")) %>% 
#   ggplot(aes(x= function_type, y= AUC)) + geom_point()
```


```{r,fig.width=5,fig.height=3}
# tmp <- auc_df %>% 
#   filter(AUC > 0.99) 
# 
# table(tmp$imptype)
# 
# tmp <- CTRP_binary_PPIold_data %>% 
#   filter(drug=="BRD-A41692738") %>% 
#   filter(imptype== "ConSen-Sig")
# 
# tmp <- CTRP_binary_PPIold_data %>% 
#   filter(drug=="BRD-A35588707") %>% 
#   filter(imptype== "ConExp-Sig")
# 
# tmp <- CTRP_binary_PPIold_data %>% 
#   filter(drug=="BRD-K09951645") %>% 
#   filter(imptype== "ConSen-Sig")

# load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
#does the auc coorelation with fitting accuracy
# tmp <- auc_df %>% 
#   filter(dataset=="CTRP") %>% 
#   filter(imptype=="ConSen-Sig") %>% 
#   inner_join(res_ctrp2,by=c("drug"="broad_cpd_id")) %>% 
#   mutate(acc= (ceres+ces+demeter2)/3)
# 
# tmp1 <- tmp %>% filter(AUC < 0.6) %>% 
#   filter(acc>0.45) %>% 
#   filter(sample_size >400) 
# 
# 
# tmp2 <- CTRP_binary_PPIold_data %>% 
#   filter(imptype=="ConSen-Sig") %>% 
#   filter(drug == "BRD-K15318909")
#   # filter(drug %in% HDAC_inhibitors$drug)
#   # filter(drug== "BRD-K77908580" )
#   # filter(drug== "BRD-K02130563" )
# 
# HDAC_inhibitors <- ctrp_target_binary %>% filter(str_detect(target,pattern = "HDAC")) 

# tmp2
```


```{r, fig.width=4, fig.height=4}
# library(ggrepel)
# tmp %>% 
#   ggplot(aes(y=AUC, x=acc)) + 
#   geom_point()+
#   geom_hline(yintercept = 0.6)+
#   geom_vline(xintercept = 0.45)+
#   geom_text(
#     aes(label=ifelse( cpd_name %in% c("PAC-1" ) ,cpd_name,''),hjust=0.5,vjust=0.5))+
#   xlab("Sensitivity fitting accuracy")+
#   ylab("Nominal target prioritization AUC")

```

fake target example: PAC-1

PAC-1 is perhaps not a good example for our method because we assume drugs to be inhibitors rather than activators of their target.
```{r}
# tmp1 <- tmp %>% filter(AUC < 0.6) %>% 
#   filter(acc>0.5) %>% 
#   filter(sample_size >400) #BRD-K49328571
# 
# tmp1 %>% 
#   ggplot(aes(x=acc, y= AUC)) + 
#   geom_point()+
#   geom_text(aes(label= cpd_name))
#   
# tmp2 <- CTRP_binary_PPIold_data %>% 
#   filter(drug %in% "BRD-K49328571" ) %>% 
#   filter(imptype=="ConSen-Sig")
# 
# feature_imp_ridge_ctrp_comb1 %>% 
#   # filter(drug %in% "BRD-K49328571") %>% 
#   filter(drug %in% "BRD-K92991072") %>%  ##(drug PAC-1)
#   pivot_longer(-drug, names_to="gene", values_to= "value") %>%
#   select(-drug) %>% 
#   arrange(desc(value)) %>% 
#   mutate(NominalT= (gene=="KIT"))
#   
# CTRP_PAC1_sen <- 
#   ctrp_data %>% 
#   filter(broad_cpd_id=="BRD-K92991072") %>% 
#   select(sensitivity) %>% unnest()
# perhaps a ranked dot plot showing where the nominal target is and where the true target is. 
# Is it worth to look back to individual level drug perturbation data and see what are the expression of this gene KIT after drug perturbation.
```

https://www.nature.com/articles/s41375-020-0978-7
HOw to prove the KIT are not a target of dasatinib
drug are still effective in KIT knockout cells.

BRD-K49328571


now considering only for drugs that have a good sensitivity fitting accuracy but bad 
target prediction accuracy, we check if this is due to lack of target label in the binary gold
standard dataset


```{r}
# tmp3 <- auc_df %>% 
#   filter(dataset=="CTRP") %>% 
#   filter(imptype=="ConSen-Sig") %>% 
#   inner_join(res_ctrp2,by=c("drug"="broad_cpd_id")) %>% 
#   mutate(acc= (ceres+ces+demeter2)/3) %>% filter(AUC < 0.60) %>% 
#   filter(acc>0.45) %>% 
#   filter(sample_size >400) %>% 
#   filter(drug %in% ctrp_target_dtc$drug)

# will these drugs, the top genes of which have a higher binding score
# examine the top ten positive gene for each drug
# tmp4 <- get_drug_frac(CTRP_binary_PPIold_data,top_num = 5,top_method = "top_both",res_type = "toppair" ) %>% 
#   filter(impdef %in% "toppos gene") %>% 
#   filter(imptype == "ConSen-Sig") %>% 
#   filter(drug %in% tmp3$drug) %>% 
#   inner_join(tmp3, by="drug")

# some experiment that true target is the top genes but not its original target


# DTC result is also limited!
# tmp5 <- tmp4 %>% inner_join(ctrp_target_dtc %>% rename(gene= target))

# tmp4 <- get_drug_frac(CTRP_binary_PPIold_data,top_num = 10,top_method = "top_both",res_type = "toppair" ) %>% 
#   filter(impdef %in% "toppos gene") %>% 
#   filter(imptype == "ConSen-Sig") %>% 
#   filter(drug == "BRD-K92991072") %>% 
#   select(gene, imp, anno_type1) %>% 
#   mutate(imp= round(imp, 3))
# 
# tmp5 <- CTRP_binary_PPIold_data %>% 
#    filter(anno_type1 %in% "Target") %>% 
#   filter(imptype == "ConSen-Sig") %>% 
#   filter(drug == "BRD-K92991072") %>% 
#   select(gene, imp, anno_type1) %>% 
#   mutate(imp= round(imp, 3)) %>% 
#   bind_rows(tmp4)
# 
# 
# tmp4 <- get_drug_frac(CTRP_binary_PPIold_data,top_num = 10,top_method = "top_both",res_type = "toppair" ) %>% 
#   filter(impdef %in% "toppos gene") %>% 
#   filter(imptype == "ConSen-Sig") %>% 
#   filter(drug == "BRD-K49328571") %>% 
#   select(gene, imp, anno_type1) %>% 
#   mutate(imp= round(imp, 3))
# 
# tmp5 <- CTRP_binary_PPIold_data %>% 
#    filter(anno_type1 %in% "Target") %>% 
#   filter(imptype == "ConSen-Sig") %>% 
#   filter(drug == "BRD-K49328571") %>% 
#   select(gene, imp, anno_type1) %>% 
#   mutate(imp= round(imp, 3)) %>% 
#   bind_rows(tmp4)

```



### 2 Find one drug for story telling
From CTRP and GDSC for a list of drugs where unsupervised AUC=1, output their nominal target, their 
top 5 positive and negative gene so that Huang and I and later check
```{r}
ctrp_bestranked_drugs <- ctrp_unsupervised_auc %>%  filter(imptype=="ConSen-Sig") %>% filter(AUC == 1) %>% pull(drug)
gdsc_bestranked_drugs <- gdsc_unsupervised_auc %>%  filter(imptype=="ConSen-Sig") %>% filter(AUC == 1) %>% pull(drug)

# get top gene table
tmp <- bind_rows(
  get_drug_frac(dataset= CTRP_binary_PPIold_data, top_n=5, res_type = "toppair",top_method ="top_both" ) %>% 
    mutate(dataset= "CTRP") %>%  filter(drug %in% ctrp_bestranked_drugs) ,
  get_drug_frac(dataset= GDSC_binary_PPIold_data, top_n=5, res_type = "toppair",top_method ="top_both") %>% 
    mutate(dataset= "GDSC") %>%  filter(drug %in% gdsc_bestranked_drugs) %>% mutate(drug= as.character(drug))
) %>% 
  filter(imptype== "ConSen-Sig") %>% 
  group_by(drug) %>% 
  arrange(desc(imp),.by_group=T )

# write_csv(tmp, "~/cluster_wrk/drug_moa/unsupervised_target_exploration/findacase_featureimp.csv")

# get meta table
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
tmp1 <- ctrp_data %>% select_at(c(1,4,5)) %>% filter(broad_cpd_id %in% ctrp_bestranked_drugs)
colnames(tmp1) <- c("MOA", "DRUG_NAME", "DRUG_ID") 
tmp2 <- gdsc_data %>% filter(DRUG_ID %in% gdsc_bestranked_drugs) %>% 
  rename(MOA= PATHWAY_NAME) %>% 
  mutate(DRUG_ID= as.character(DRUG_ID)) %>% 
  select(MOA, DRUG_NAME, DRUG_ID)
tmp3 <- bind_rows(tmp1, tmp2)
# write_csv(tmp3, "~/cluster_wrk/drug_moa/unsupervised_target_exploration/findacase_drugmeta.csv")

tmp4 <- inner_join(tmp, tmp3,by=c("drug"= "DRUG_ID"))
# write_csv(tmp4, "~/cluster_wrk/drug_moa/unsupervised_target_exploration/findacase_combined.csv")
```

Shan asked if I can give a gene-level summary
```{r}
tmp <- read_csv("~/cluster_wrk/drug_moa/unsupervised_target_exploration/findacase_combined.csv")

top_pos <- 
  inner_join(
      tmp %>% filter(impdef=="toppos gene") %>% 
        select(DRUG_NAME, gene) %>% 
        distinct() %>% 
        group_by(gene) %>% 
        summarize(drug_associated= paste(sort(DRUG_NAME), collapse = ";" ),
                  NO.associated_Drugs=n()) %>% 
        ungroup()
      ,  
      tmp %>% filter(impdef=="toppos gene") %>% 
        select(gene, MOA) %>%
        distinct() %>% 
        group_by(gene) %>% 
        summarize(MOA= paste(sort(MOA), collapse = ";" )) %>% 
        ungroup()         
      
      ) 
  
top_pos_target <- tmp %>% 
  filter(impdef=="toppos gene") %>% 
  filter(anno_type=="Target") %>% 
  select(gene, DRUG_NAME) %>% 
  group_by(gene) %>% 
  summarize(drug_targeted= paste(sort(DRUG_NAME), collapse = ";" ), NO.Targeted_Drugs=n()) %>% 
        ungroup()

top_pos_gene_df <- left_join(top_pos, top_pos_target)  %>% arrange(desc(NO.associated_Drugs))

top_neg_gene_df <- inner_join(
  tmp %>% filter(impdef=="topneg gene") %>% 
        select(DRUG_NAME, gene) %>% 
        distinct() %>% 
        group_by(gene) %>% 
        summarize(drug_associated= paste(sort(DRUG_NAME), collapse = ";" ),
                  NO.associated_Drugs=n()
                  )
        ,  
      tmp %>% filter(impdef=="topneg gene") %>% 
        select(gene, MOA) %>%
        distinct() %>% 
        group_by(gene) %>% 
        summarize(MOA= paste(sort(MOA), collapse = ";" )) %>% 
        ungroup()
) %>% 
  arrange(desc(NO.associated_Drugs))

# write_csv(top_pos_gene_df,"~/cluster_wrk/drug_moa/unsupervised_target_exploration/gene-level summary(top pos).csv")
# write_csv(top_neg_gene_df, "~/cluster_wrk/drug_moa/unsupervised_target_exploration/gene-level summary(top neg).csv")
```

one drug lapatinib seems to be a good example for story telling.
Get the top10 and bottom 10 genes for the drug.

1558 Lapatinib BRD-K19687926
```{r}
Lapatinib <- 
bind_rows(
GDSC_binary_PPIold_data %>% filter(drug == "1558") %>% filter(imptype=="ConSen-Sig" ) %>% arrange(desc(imp)) %>%  slice(1:10, 10614:10623)%>% mutate(drug=as.character(drug))
,
CTRP_binary_PPIold_data %>% filter(drug == "BRD-K19687926") %>% filter(imptype=="ConSen-Sig" ) %>% arrange(desc(imp))%>%  slice(1:10, 10614:10623) 

) %>% 
  mutate(direction= case_when(imp>0~"POS", imp<0~"NEG")) %>% 
  group_by(drug, direction) %>% 
  mutate(gene_rank= rank(desc(abs(imp))) ) %>% 
  ungroup() %>% 
  group_by(gene) %>% 
  mutate(freq=n()) %>%
  ungroup() %>% 
  select(gene, dataset, gene_rank, direction,freq)
  # pivot_wider(id_cols = gene, names_from= dataset, values_from= gene_rank) %>% 
  # arrange(CTRP)

# write_csv(Lapatinib, "Lapatinib.csv")
```



## 3 pathway analysis
```{r}
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
load("~/cluster_scratch/glmnet_modelling/target_pred_server/res_pathways_all.RData")

pathways_df_gdsc <- 
  tibble(drug=feature_imp_ridge_gdsc_comb1$drug, pathway=gdsc_kegg) %>% 
  unnest()%>% 
  arrange(padj) %>% 
  inner_join(y = gdsc_data %>% select_at(1:4),
             by= c("drug"= "DRUG_ID")) %>%
  select(-log2err, -ES, -pval, -leadingEdge,-NES, -size) %>%  
  # filter(pathway %in% c("KEGG_MAPK_SIGNALING_PATHWAY","KEGG_MISMATCH_REPAIR", "KEGG_ERBB_SIGNALING_PATHWAY")) %>%
  filter(padj<0.05) 
  # select(pathway, padj, DR)
  # filter(drug %in% gdsc_drug_list) #%>%
  # filter(DRUG_NAME %in% c("Axitinib")) #"Osimertinib"))#, "MK-1775") )

#
# options(scipen = 3)
example_gdsc_DDR <- pathways_df_gdsc %>% 
  filter(pathway %in% c("KEGG_MISMATCH_REPAIR")) %>% 
  select(-drug) %>% 
  rename(REPORTED_MECHANISM=PATHWAY_NAME) %>% 
  mutate(padj= formatC(padj, format = "e", digits = 2))

#ERK_6604 in GDSC

# doxorubicin <- pathways_df %>% filter(cpd_name=="doxorubicin") #topoisomerase II
# # Trametinib <- pathways_df %>% filter(cpd_name=="trametinib")
# dinaciclib <- pathways_df %>% filter(cpd_name=="dinaciclib")
# alvocidib <- pathways_df %>% filter(cpd_name=="alvocidib")

# check which pathway are enriched in a category of drug
# tmp <- pathways_df %>% 
#   filter(target_or_activity_of_compound== "inhibitor of cyclin-dependent kinases") %>%
#   group_by(pathway) %>% 
#   summarise(mean_p =mean(padj))

# tmp <- pathways_df %>% 
#   filter(target_or_activity_of_compound== "inhibitor of cyclin-dependent kinases") %>%
#   # filter(broad_cpd_id == "BRD-K64800655") %>% 
#   filter(pathway== "GOCC_CHROMOSOME_CENTROMERIC_REGION")
# 
# 
# # https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4156313/
# tmp <- res2 %>% 
#   filter(target_or_activity_of_compound== "inhibitor of cyclin-dependent kinases") 
# 
# top_5drugs <- pathways_df %>% select(broad_cpd_id) %>% distinct() %>% slice(1:5)
# 
# tmp  <- pathways_df %>% 
#   filter(broad_cpd_id %in% top_5drugs$broad_cpd_id) 


pathways_df_ctrp <- 
  tibble(drug=feature_imp_ridge_ctrp_comb1$drug, pathway=ctrp_kegg) %>% 
  unnest()%>% 
  arrange(padj) %>% 
  inner_join(y = ctrp_data %>% filter(drug_type== "single drug") %>% select_at(c(1,4,5)),
             by= c("drug"= "broad_cpd_id")) %>%
  select(-log2err, -ES, -pval, -leadingEdge, -NES, -size) %>%  
  # filter(pathway %in% c("KEGG_MAPK_SIGNALING_PATHWAY","KEGG_MISMATCH_REPAIR", "KEGG_ERBB_SIGNALING_PATHWAY")) %>%
  # filter(pathway %in% c("KEGG_MISMATCH_REPAIR")) %>%
  filter(padj<0.05) 


pathways_df_prism <- 
  tibble(drug=feature_imp_ridge_prism_comb1$drug, pathway=prism_kegg) %>% 
  unnest()%>% 
  arrange(padj) %>% 
  inner_join(y = prism_data %>% select_at(1:4),
             by= c("drug"= "BROAD_ID")) %>%
  select(-log2err, -ES, -pval, -leadingEdge, -NES, -size) %>%  
  # filter(pathway %in% c("KEGG_MAPK_SIGNALING_PATHWAY","KEGG_MISMATCH_REPAIR", "KEGG_ERBB_SIGNALING_PATHWAY")) %>%
  # filter(pathway %in% c("KEGG_MISMATCH_REPAIR")) %>%
  filter(padj<0.05) 

write_csv(pathways_df_gdsc, "pathways_df_gdsc.csv")
write_csv(example_gdsc_DDR, "pathway_example_gdsc_DDR.csv")
write_csv(pathways_df_prism, "pathways_df_prism.csv")
write_csv(pathways_df_ctrp, "pathways_df_ctrp.csv")
```

## 4
What is the expectation of MDR1 and ABCB1?
I suppose they ranked highly irrespecive of drug identity.
WEll not really..

```{r}
# tmp <- feature_imp_ridge_ctrp_comb1 %>% 
#   filter(drug %in% ctrp_drug_list) %>% 
#   pivot_longer(-drug,names_to="gene", values_to="imp") %>% 
#   group_by(drug) %>% 
#   mutate(gene_rank= rank(imp)) %>% 
#   ungroup() %>% 
#   group_by(gene) %>% 
#   summarize(meanrank= mean(gene_rank))
# 
# tmp <- feature_imp_ridge_ctrp_comb1 %>% 
#   filter(drug %in% ctrp_drug_list) %>% 
#   pivot_longer(-drug,names_to="gene", values_to="imp") %>% 
#   group_by(drug) %>% 
#   mutate(gene_rank= rank(imp)) %>% 
#   ungroup() %>% 
#   filter(gene=="ABCB1")
# 
# 
# tmp2 <- apply(feature_imp_ridge_gdsc_comb1[,-1],MARGIN = 1, rank) 
# summary(tmp[rownames(tmp)=="ABCB1","ZZZ3"])
# tmp3 <- apply(tmp2, 1, mean) 
# 
# tmp4 <- 
#   bind_cols(
# as.data.frame(tmp1) %>% rownames_to_column(var = "gene") %>% arrange(gene),
# as.data.frame(tmp3) %>% rownames_to_column(var = "gene") %>% arrange(gene)
# )
# 


```



