---
title: "analysis_new"
author: "Wenyu"
date: "5/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


```{r}
feature_imp_ridge_ctrp_ces1 <- read_csv("~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ces1.csv")

kegg_tibble <- read_csv("~/cluster_scratch/prior/kegg_tibble.csv")

load("~/cluster_scratch/glmnet_modelling/target_pred_server/targetpred_serverinput.RData")

source('~/cluster_wrk/drug_moa/unsupervised_target_exploration/get_target_matrix_from_long_target_tibble.R')
source('~/cluster_wrk/drug_moa/unsupervised_target_exploration/annotate_feature_matrix.R')

target_tibble_drugbank= ctrp_target_tibble %>%
  ungroup() %>%
  select(broad_cpd_id, gene_symbol_of_protein_target) %>%
  rename(drug=broad_cpd_id, target_gene=gene_symbol_of_protein_target) %>% 
  mutate(binding_score= 1)

target_tibble_dtc <- ctrp_target_dtc %>% 
  select(standard_inchi_key, gene_name, interaction_strength) %>%
  filter(interaction_strength!= 0) %>% 
  drop_na() %>% 
  group_by(standard_inchi_key, gene_name) %>% 
  summarize(interaction_strength= median(interaction_strength,na.rm = T)) %>% 
  ungroup() %>% 
  inner_join(ctrpv2_list_to_zia,by= c("standard_inchi_key"= "InChIKey")) %>% 
  select(broad_cpd_id, gene_name, interaction_strength) %>% 
  group_by(broad_cpd_id, gene_name) %>% 
  summarize(interaction_strength= max(interaction_strength,na.rm = T)) %>% 
  ungroup() %>%   rename(drug=broad_cpd_id, target_gene=gene_name, binding_score= interaction_strength) 

# length(unique(target_tibble$drug))
```



Plotting feature_imp vs dtc target binding plot
use dtc target as a base to join drugbank and feature importance
```{r}
res <- target_tibble_dtc %>% 
  left_join(target_tibble_drugbank %>% rename(drug_bank_target= binding_score)) %>% 
  inner_join(
    y=feature_imp_ridge_ctrp_ces1 %>% 
      pivot_longer(cols= -broad_cpd_id, names_to= "gene", values_to= "feature_imp"),
    by= c("drug" = "broad_cpd_id", "target_gene" = "gene")) %>% 
  mutate(drug_bank_target= replace_na(drug_bank_target, 0) )
    
    
```


```{r}
res %>% 
  # filter(drug_bank_target ==1) %>% 
  ggplot(aes(y= log10(abs(feature_imp)), x=binding_score)) + 
  geom_point(aes(shape= factor(drug_bank_target)),size= 0.01)+
  theme_classic()
```





```{r}
load("~/cluster_scratch/ctrp/ctrpv2_data.RData")
load("~/cluster_scratch/glmnet_modelling/target_pred_server/res_pathway_go.RData")
feature_imp_ridge_ctrp_ces1 <- read_csv("~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ces1.csv")

pathways_df <- 
  tibble(
    broad_cpd_id=feature_imp_ridge_ctrp_ces1$broad_cpd_id,res_pathway) %>% 
  unnest()%>% 
  arrange(padj) %>% 
  inner_join(y = ctrpv2_data %>% select_at(1:5),
             by= "broad_cpd_id")
  
doxorubicin <- pathways_df %>% filter(cpd_name=="doxorubicin") #topoisomerase II
# Trametinib <- pathways_df %>% filter(cpd_name=="trametinib")
dinaciclib <- pathways_df %>% filter(cpd_name=="dinaciclib")
alvocidib <- pathways_df %>% filter(cpd_name=="alvocidib")

# check which pathway are enriched in a category of drug
# tmp <- pathways_df %>% 
#   filter(target_or_activity_of_compound== "inhibitor of cyclin-dependent kinases") %>%
#   group_by(pathway) %>% 
#   summarise(mean_p =mean(padj))

tmp <- pathways_df %>% 
  filter(target_or_activity_of_compound== "inhibitor of cyclin-dependent kinases") %>%
  # filter(broad_cpd_id == "BRD-K64800655") %>% 
  filter(pathway== "GOCC_CHROMOSOME_CENTROMERIC_REGION")


# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4156313/
tmp <- res2 %>% 
  filter(target_or_activity_of_compound== "inhibitor of cyclin-dependent kinases") 



top_5drugs <- pathways_df %>% select(broad_cpd_id) %>% distinct() %>% slice(1:5)

tmp  <- pathways_df %>% 
  filter(broad_cpd_id %in% top_5drugs$broad_cpd_id) 
  
```


```{r}
ces1_glm_feature_annotated %>% 
  # filter(imp!=0) %>% 
  ggplot(aes(x= target_cat, y= -log10(abs(imp)))) +
  geom_violin(outlier.size = 0.01)+
  theme_classic()+
    theme_classic()+
  xlab("Gene type")+
  ylab("Feature importance -log10")+
  labs(fill= "Essentiality") +
  scale_x_discrete(breaks=c("0","1","2","3","4"),
        labels=c("Nomial target", "1st neighbour", "2nd neigbour", "3rd neighbour", "Others"))

```




Now I have a annotation matrix for the ConSen-sig and ConExp-sig
lets compare how they can be used

```{r}
CTRP_binary_PPIold_data <- read_csv( "~/cluster_scratch/prior/CTRP_binary_PPIold_data.csv")
```


```{r}
CTRP_binary_PPIold_data %>% 
  ggplot(aes(x= imptype,y = (abs(imp)), fill= anno_type1)) +
  geom_boxplot(position = position_dodge(),outlier.shape=NA )+
  ylim(c(0,0.01))
  
```


we should focus on the top genes
```{r}
CTRP_binary_PPIold_data1 <-
  bind_rows(
    CTRP_binary_PPIold_data %>%
      group_by(drug,imptype) %>% 
      top_n(wt=imp,  n= 100) %>% 
      ungroup() %>% 
      mutate(impdef= "toppos gene"),
    CTRP_binary_PPIold_data %>% 
      group_by(drug, imptype) %>% 
      top_n(wt=imp, n = -100) %>% 
      ungroup() %>% 
      mutate(impdef= "topneg gene"),
  )

CTRP_binary_PPIold_data1 %>% 
  ggplot(aes(x= imptype,y = (abs(imp)), fill= anno_type1)) +
  geom_boxplot(position = position_dodge(),outlier.shape=NA )+
  ylim(c(0,0.01))
# CTRP_binary_PPIold_data1 %>% 
#   filter(!(anno_type1 %in%  c("Unknown", "Target"))) %>% 
#   ggplot(aes(x= imptype, fill= anno_type1)) +
#   geom_bar(position = position_dodge())

table(CTRP_binary_PPIold_data1$imptype)
table(CTRP_binary_PPIold_data1$imptype)

# for top 100 top and bottom genes how does them distribute in the target network?
tmp <- CTRP_binary_PPIold_data1 %>% filter(imptype=="ConSen-Sig")
table(tmp$impdef,tmp$anno_type1)
tmp <- CTRP_binary_PPIold_data1 %>% filter(imptype=="ConExp-Sig")
table(tmp$impdef,tmp$anno_type1)



CTRP_binary_PPIold_data1 %>% 
  mutate(degree= as.numeric(anno_type)) %>% 
  drop_na() %>% 
  group_by(imptype) %>% 
  summarise(cor= cor(degree, imp,method="spearman"))

  
```

perhaps a direct comparison for the available drugs how many target are detected by the most important genes

show me the percentage of the drugs the target of which are being identified as top important genes
```{r}
tmp <- CTRP_binary_PPIold_data %>% 
  filter(anno_type == "Target") %>% 
  left_join(CTRP_binary_PPIold_data1) %>% 
  select(-anno_type, -anno_type1) %>% 
  mutate(impdef=replace_na(impdef, replace = "others"))

table(tmp$imptype, tmp$impdef) # this is meaningless considering that there are more "background genes"
```


```{r}
# for drugs with both two type of data, how many drugs the target of which has been picked by the top 100 genes?
  
drug_list <- 
  ctrp_target_binary %>% 
  filter(drug %in% ctrp_drug_list) %>% 
  pull(drug)
```


```{r}
# Or, directly compare whether the drug target ranked higher in consensig than conexp sig
map_chr(drug_list, function(x){
  target= ctrp_target_binary %>% 
    fitler(drug==x) %>% 
    pull(target)
  rank_consensig= consen
  if (target)
  
}
        )
```


Lets use target, target+ 1st negibour... as binarizing threshold and plot AUC for the ranked gene list.


#should we instead focus on the top genes

