---
title: "Modelling output exploration Part2 drug target prediction"
author: "Wenyu"
date: "1/15/2021"
output: html_document
---

The aim of this nootbook is to explore whether the extracted model importances from the sen~ess glmnet model can be used in supervised drug target prediction


## 1
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
```

## 2 read in files. 

read in all the needed csv file for drug target prediction using various predictors and then save an RData file as input for modelscript

### 2.1 read in model based features
```{r,warning = FALSE, message=FALSE}
load("~/cluster_scratch/forward_modelling/forwardmodelling_all.RData")
feature_imp_ridge_ctrp_ces1 <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_ctrp_ces1.csv")

feature_imp_ridge_ctrp_ceres <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_ctrp_ceres.csv")

feature_imp_ridge_ctrp_demeter2 <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_ctrp_demeter2.csv")

feature_imp_ridge_ctrp_exp <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_ctrp_exp.csv")

feature_imp_ridge_gdsc_ces1 <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_gdsc_ces1.csv")

feature_imp_ridge_gdsc_ceres <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_gdsc_ceres.csv")

feature_imp_ridge_gdsc_demeter2 <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_gdsc_demeter2.csv")

feature_imp_ridge_gdsc_exp <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_gdsc_exp.csv")

feature_imp_ridge_prism_ces1 <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_prism_ces1.csv")

feature_imp_ridge_prism_ceres <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_prism_ceres.csv")

feature_imp_ridge_prism_demeter2 <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_prism_demeter2.csv")

feature_imp_ridge_prism_exp <- read_csv("~/cluster_scratch/forward_modelling/feature_imp/feature_imp_ridge_prism_exp.csv")
```


We discussed that the drug sen fitted signatures should be combined

```{r,warning = FALSE, message=FALSE}
#comb 1 simple sum
feature_imp_ridge_ctrp_comb1 <- 
  bind_cols(
    feature_imp_ridge_ctrp_ces1 %>% select(drug),
    as_tibble(
      (as.matrix(feature_imp_ridge_ctrp_ces1 %>% select(-drug)) +
      as.matrix(feature_imp_ridge_ctrp_ceres %>% select(-drug)) +
      as.matrix(feature_imp_ridge_ctrp_demeter2 %>% select(-drug)) +
      as.matrix(feature_imp_ridge_ctrp_exp %>% select(-drug)) )/4)
    )

feature_imp_ridge_gdsc_comb1 <- 
  bind_cols(
    feature_imp_ridge_gdsc_ces1 %>% select(drug),
    as_tibble(
      (as.matrix(feature_imp_ridge_gdsc_ces1 %>% select(-drug)) +
      as.matrix(feature_imp_ridge_gdsc_ceres %>% select(-drug)) +
      as.matrix(feature_imp_ridge_gdsc_demeter2 %>% select(-drug)) +
      as.matrix(feature_imp_ridge_gdsc_exp %>% select(-drug)) )/4)
    )

feature_imp_ridge_prism_comb1 <- 
  bind_cols(
    feature_imp_ridge_prism_ces1 %>% select(drug),
    as_tibble(
      (as.matrix(feature_imp_ridge_prism_ces1 %>% select(-drug)) +
      as.matrix(feature_imp_ridge_prism_ceres %>% select(-drug)) +
      as.matrix(feature_imp_ridge_prism_demeter2 %>% select(-drug)) +
      as.matrix(feature_imp_ridge_prism_exp %>% select(-drug))/4) )
    )
  
#comb 2 weighted sum exp + 1/3 of each ess based
feature_imp_ridge_ctrp_comb2 <- 
  bind_cols(
    feature_imp_ridge_ctrp_ces1 %>% select(drug),
    as_tibble(
      (as.matrix(feature_imp_ridge_ctrp_ces1 %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_ctrp_ceres %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_ctrp_demeter2 %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_ctrp_exp %>% select(-drug)))/2 )
    )

feature_imp_ridge_gdsc_comb2 <- 
  bind_cols(
    feature_imp_ridge_gdsc_ces1 %>% select(drug),
    as_tibble(
      (as.matrix(feature_imp_ridge_gdsc_ces1 %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_gdsc_ceres %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_gdsc_demeter2 %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_gdsc_exp %>% select(-drug)) )/2)
    )

feature_imp_ridge_prism_comb2 <- 
  bind_cols(
    feature_imp_ridge_prism_ces1 %>% select(drug),
    as_tibble(
      (as.matrix(feature_imp_ridge_prism_ces1 %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_prism_ceres %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_prism_demeter2 %>% select(-drug))/3 +
      as.matrix(feature_imp_ridge_prism_exp %>% select(-drug)) )/2)
    )



#comb 3 use the feature vector from the best model
feature_imp_ridge_ctrp_comb3 <- as_tibble(
    cbind(
    matrix(0, nrow = 545, ncol = 10623)
    )
)
feature_imp_ridge_gdsc_comb3 <- as_tibble(
    cbind(
    matrix(0, nrow = 198, ncol = 10623)
    )
)
feature_imp_ridge_prism_comb3 <- as_tibble(
    cbind(
    matrix(0, nrow = 1448, ncol = 10623)
    )
)

idx_list_ctrp <-  apply(res_ctrp2[,1:4],MARGIN = 1, which.max)
idx_list_gdsc <-   apply(res_gdsc2[,1:4],MARGIN = 1, which.max)
idx_list_prism <-   apply(res_prism2[,1:4],MARGIN = 1, which.max)
    
ctrp_array <- array(
  data =
      c(as.matrix(feature_imp_ridge_ctrp_ces1 %>% select(-drug)),
      as.matrix(feature_imp_ridge_ctrp_ceres %>% select(-drug)),
      as.matrix(feature_imp_ridge_ctrp_demeter2  %>% select(-drug)), 
      as.matrix(feature_imp_ridge_ctrp_exp %>% select(-drug))
      ),
  dim= c(545,10623,4) 
  )

gdsc_array <- array(
  data =
      c(as.matrix(feature_imp_ridge_gdsc_ces1 %>% select(-drug)),
      as.matrix(feature_imp_ridge_gdsc_ceres %>% select(-drug)),
      as.matrix(feature_imp_ridge_gdsc_demeter2  %>% select(-drug)), 
      as.matrix(feature_imp_ridge_gdsc_exp %>% select(-drug))
      ),
  dim= c(198,10623,4) 
  )

prism_array <- array(
  data =
      c(as.matrix(feature_imp_ridge_prism_ces1 %>% select(-drug)),
      as.matrix(feature_imp_ridge_prism_ceres %>% select(-drug)),
      as.matrix(feature_imp_ridge_prism_demeter2  %>% select(-drug)), 
      as.matrix(feature_imp_ridge_prism_exp %>% select(-drug))
      ),
  dim= c(1448,10623,4) 
  )

for (i in 1:545){
 feature_imp_ridge_ctrp_comb3[i,] <- t(ctrp_array[i,,idx_list_ctrp[i]])
}
  
for (i in 1:198){
 feature_imp_ridge_gdsc_comb3[i,] <- t(gdsc_array[i,,idx_list_gdsc[i]])
}

for (i in 1:1448){
 feature_imp_ridge_prism_comb3[i,] <- t(prism_array[i,,idx_list_prism[i]])
}





```




### 2.2 read in target labels 
```{r,warning = FALSE, message=FALSE}
ctrp_target_binary <- read_csv("~/cluster_scratch/prior/ctrpv2_target_binary.csv")
gdsc_target_binary <- read_csv("~/cluster_scratch/prior/gdsc_target_binary.csv")
prism_target_binary <- read_csv("~/cluster_scratch/prior/prism_target_binary.csv")
ctrp_target_dtc <- read_csv("~/cluster_scratch/prior/ctrpv2_target_dtc.csv")
gdsc_target_dtc <- read_csv("~/cluster_scratch/prior/gdsc_target_dtc.csv")
prism_target_dtc <- read_csv("~/cluster_scratch/prior/ctrpv2_target_dtc.csv")
```

### 2.3 read in additional feature preparation
```{r,warning = FALSE, message=FALSE}
#fingerprint
setwd("~/cluster_scratch/fingerprints/new/fingerprint/result")
feature_maccs_ctrp <- read_csv("maccs_finger_ctrp.csv") %>% select(-smiles, -InChIKey,-pubchem_cid) %>% rename(drug =broad_cpd_id)
feature_extended_ctrp <- read_csv("extended_finger_ctrp.csv") %>% select(-smiles, -InChIKey,-pubchem_cid) %>% rename(drug =broad_cpd_id)

feature_maccs_gdsc <- read_csv("maccs_finger_gdsc.csv")%>% select(-smiles,-PubCHEM) %>% rename(drug =DRUG_ID) 
feature_maccs_gdsc <-feature_maccs_gdsc%>% distinct()
feature_extended_gdsc <- read_csv("extended_finger_gdsc.csv")%>% select(-smiles, -PubCHEM) %>% rename(drug =DRUG_ID)
feature_extended_gdsc <-feature_extended_gdsc%>% distinct()


feature_maccs_prism <- read_csv("maccs_finger_prism.csv")%>% select(-smiles, -InChIKey,-pubchem_cid) %>% rename(drug =BROAD_ID)
feature_extended_prism <- read_csv("extended_finger_prism.csv") %>% select(-smiles, -InChIKey,-pubchem_cid) %>% rename(drug =BROAD_ID)

## Consensus signature
setwd("~/cluster_scratch//L1000/consensus_signatures_challenge/")
drug_consensus_ctrp <- read_csv("feature_consensus_ctrp.csv")
drug_consensus_prism <- read_csv("feature_consensus_prism.csv")
drug_consensus_gdsc <- read_csv("feature_consensus_gdsc.csv")
```

### 2.4 save workspace
```{r,warning = FALSE, message=FALSE}
save.image("~/cluster_scratch/forward_modelling/targetpred_serverinput.RData")

```


Some previous analysis
```{r,warning = FALSE, message=FALSE}
# Write A function to calculate jaccard similarity based on fingerprint
# extended_cor <- feature_extended_finger_print %>% 
#   pivot_longer(cols = -broad_cpd_id,names_to= "name", values_to= "value") %>% 
#   pivot_wider(id_cols = name, names_from= broad_cpd_id,  values_from= value) %>%
#   arrange(name) %>% 
#   select(-name) %>% 
#   as.matrix() %>%
#   prabclus::jaccard()
  # cor(method = "spearman")
  

# hist(extended_cor) 
# extended_cor1 <- (extended_cor - 0.5)* (-2)
# extended_cor1 <- -extended_cor + mean(extended_cor)
# hist(extended_cor1) 

# maccs_cor <- feature_maccs_finger_print %>% 
#   pivot_longer(cols = -broad_cpd_id,names_to= "name", values_to= "value") %>% 
#   arrange(broad_cpd_id) %>% 
#   pivot_wider(id_cols = name, names_from= broad_cpd_id,  values_from= value) %>% 
#   select(-name) %>% 
#   as.matrix() %>% 
#   prabclus::jaccard()
#   # cor(method = "spearman")

# hist(maccs_cor)
# maccs_cor1 <- -maccs_cor + mean(maccs_cor)
# hist(maccs_cor1) 
# hist(sen_cor)
 
# ces1_cor <- cor(t(
#   x = feature_imp_ridge_ctrp_ces1 %>% 
#     rename(drug=broad_cpd_id) %>% 
#     arrange(drug) %>% 
#     select(-drug) %>% 
#     mutate_all(.funs = scale)), method = "spearman")
# ces1_cor[ces1_cor<0] <- 0
# colnames(ces1_cor) <- row.names(ces1_cor) <- sort(feature_imp_ridge_ctrp_ces1$broad_cpd_id)
# 
# sen_cor <- cor(t(
#   x = feature_sen_ctrp %>% 
#     rename(drug=broad_cpd_id) %>% 
#     arrange(drug) %>% 
#     select(-drug) %>% 
#     mutate_all(.funs = scale)), method = "spearman")
# sen_cor[sen_cor<0] <- 0
# colnames(sen_cor) <- row.names(sen_cor) <- sort(feature_imp_ridge_ctrp_ces1$broad_cpd_id)


# ces1_extended_cor <- (ces1_cor + extended_cor)/2
# ces1_extended_sen_cor <- (ces1_cor + extended_cor+ sen_cor)/3
# ces1_maccs_cor <- (ces1_cor + maccs_cor)/2
# ces1_maccs_sen_cor <- (ces1_cor + maccs_cor+ sen_cor)/3

# save.image("~/cluster_scratch/glmnet_modelling/target_pred_server/targetpred_serverinput.RData")
```

lets use the existing target information of the
365 drugs to do cv and predict drug target

The prediction algorithm can be based on dream challenge and performance is evaluated using cv.
We then consider again a nested cv to first find the thresholding parameters 

the central idea is to check what additional value can such basal cell info bring to MOA prediction in addition to the drug sensitivity and how does the accuracy comparing to, for example, chemical fingerprint based prediction?

## 3 Supervisied prediction with ctrpv2's own target info (from DrugBank)
```{r}
load("~/cluster_scratch/forward_modelling/targetpred_serverinput.RData")
```



### 3.1 Naive prediction without any filtering
```{r}
#ctrp
acc_df_ctrp_binary_fold_cv <- get_target_pred_accuracy_batch(dataset= "ctrp",  estimation_method= "fold_cv" , target_source= ctrp_target_binary)

acc_df_ctrp_binary_loocv <- get_target_pred_accuracy_batch(dataset= "ctrp",  estimation_method= "loocv" , target_source= ctrp_target_binary)

acc_df_ctrp_dtcbinary_foldcv <- get_target_pred_accuracy_batch(
  dataset= "ctrp", estimation_method= "fold_cv" , 
  target_source= ctrp_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score)
  )

acc_df_ctrp_dtcbinary_loocv <- get_target_pred_accuracy_batch(
  dataset= "ctrp",  estimation_method= "loocv" , 
  target_source= ctrp_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score)
  )


acc_df_ctrp_dtc_foldcv <- get_target_pred_accuracy_batch(dataset= "ctrp", estimation_method= "fold_cv" , target_source= ctrp_target_dtc%>% filter(binding_score >0))

acc_df_ctrp_dtc_loocv <- get_target_pred_accuracy_batch(dataset= "ctrp",  estimation_method= "loocv" , target_source= ctrp_target_dtc%>% filter(binding_score >0))


#gdsc
acc_df_gdsc_binary_fold_cv <- get_target_pred_accuracy_batch(dataset= "gdsc",  estimation_method= "fold_cv" , target_source= gdsc_target_binary)

acc_df_gdsc_binary_loocv <- get_target_pred_accuracy_batch(dataset= "gdsc",  estimation_method= "loocv" , target_source= gdsc_target_binary)

acc_df_gdsc_dtcbinary_foldcv <- get_target_pred_accuracy_batch(
  dataset= "gdsc", estimation_method= "fold_cv" , 
  target_source= gdsc_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score)
  )

acc_df_gdsc_dtcbinary_loocv <- get_target_pred_accuracy_batch(
  dataset= "gdsc",  estimation_method= "loocv" , 
  target_source= gdsc_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score)
  )


acc_df_gdsc_dtc_foldcv <- get_target_pred_accuracy_batch(dataset= "gdsc", estimation_method= "fold_cv" , target_source= gdsc_target_dtc%>% filter(binding_score >0))

acc_df_gdsc_dtc_loocv <- get_target_pred_accuracy_batch(dataset= "gdsc",  estimation_method= "loocv" , target_source= gdsc_target_dtc%>% filter(binding_score >0))


#prism
acc_df_prism_binary_fold_cv <- get_target_pred_accuracy_batch(dataset= "prism",  estimation_method= "fold_cv" , target_source= prism_target_binary)

acc_df_prism_binary_loocv <- get_target_pred_accuracy_batch(dataset= "prism",  estimation_method= "loocv" , target_source= prism_target_binary)

acc_df_prism_dtcbinary_foldcv <- get_target_pred_accuracy_batch(
  dataset= "prism", estimation_method= "fold_cv" ,
  target_source= prism_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score)
  )

acc_df_prism_dtcbinary_loocv <- get_target_pred_accuracy_batch(
  dataset= "prism",  estimation_method= "loocv" ,
  target_source= prism_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score)
  )

acc_df_prism_dtc_foldcv <- get_target_pred_accuracy_batch(dataset= "prism", estimation_method= "fold_cv" , target_source= prism_target_dtc%>% filter(binding_score >0))

acc_df_prism_dtc_loocv <- get_target_pred_accuracy_batch(dataset= "prism",  estimation_method= "loocv" , target_source= prism_target_dtc%>% filter(binding_score >0))

save.image("~/cluster_scratch/forward_modelling/targetpred_output.RData")
```


### 3.2 Target prediction by filtering out the poorly fitted drugs and merging the gene signatures of the duplicated drugs.


I will get three id_list, one for each dataset.
For overlapping drugs (same smiles)
pick only best fitted ones.

filtering standard acc <0.10 and sample size < 100

```{r}

ctrp_drug_list <- res_ctrp2 %>% 
  filter(!ces<0.1) %>% 
  filter(!ceres<0.1) %>% 
  filter(!demeter2<0.1) %>% 
  filter(!exp<0.1) %>% 
  filter(!sample_size <100) %>% 
  select(cpd_smiles,broad_cpd_id, ces) %>%
  drop_na() %>% 
  group_by(cpd_smiles) %>% 
  slice_max(n=1, order_by=ces) %>% 
  pull(broad_cpd_id)
  

gdsc_drug_list <- res_gdsc2 %>% 
  # filter(!ces<0.1) %>% 
  # filter(!ceres<0.1) %>% 
  # filter(!demeter2<0.1) %>% 
  # filter(!exp<0.1) %>% 
  filter(!sample_size <100) %>% 
  select(smiles,DRUG_ID, ces) %>%
  drop_na() %>% 
  group_by(smiles) %>% 
  slice_max(n=1, order_by=ces) %>% 
  pull(DRUG_ID)
  
prism_drug_list <- res_prism2  %>% 
  filter(!ces<0.1) %>% 
  filter(!ceres<0.1) %>% 
  filter(!demeter2<0.1) %>% 
  filter(!exp<0.1) %>% 
  filter(!sample_size <100) %>% 
  select(smiles,BROAD_ID, ces) %>%
  drop_na() %>% 
  group_by(smiles) %>% 
  slice_max(n=1, order_by=ces) %>% 
  pull(BROAD_ID)

#ctrp
acc_df_ctrp_binary_fold_cv <- get_target_pred_accuracy_batch(
  dataset= "ctrp",  
  estimation_method= "fold_cv" , 
  target_source= ctrp_target_binary, 
  id_list = ctrp_drug_list)

acc_df_ctrp_binary_loocv <- get_target_pred_accuracy_batch(
  dataset= "ctrp",  estimation_method= "loocv" , 
  target_source= ctrp_target_binary, 
  id_list = ctrp_drug_list)

acc_df_ctrp_dtcbinary_foldcv <- get_target_pred_accuracy_batch(
  dataset= "ctrp", estimation_method= "fold_cv" , 
  target_source= ctrp_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score), 
  id_list = ctrp_drug_list
  )

acc_df_ctrp_dtcbinary_loocv <- get_target_pred_accuracy_batch(
  dataset= "ctrp",  estimation_method= "loocv" , 
  target_source= ctrp_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score), 
  id_list = ctrp_drug_list
  )

acc_df_ctrp_dtc_foldcv <- get_target_pred_accuracy_batch(
  dataset= "ctrp", estimation_method= "fold_cv" , target_source= ctrp_target_dtc%>% filter(binding_score >0), 
  id_list = ctrp_drug_list)

acc_df_ctrp_dtc_loocv <- get_target_pred_accuracy_batch(
  dataset= "ctrp",  estimation_method= "loocv" , 
  target_source= ctrp_target_dtc%>% filter(binding_score >0), 
  id_list = ctrp_drug_list)


#gdsc
acc_df_gdsc_binary_fold_cv <- get_target_pred_accuracy_batch(
  dataset= "gdsc",  estimation_method= "fold_cv" , target_source= gdsc_target_binary, 
  id_list = gdsc_drug_list)

acc_df_gdsc_binary_loocv <- get_target_pred_accuracy_batch(
  dataset= "gdsc",  estimation_method= "loocv" , 
  target_source= gdsc_target_binary, 
  id_list = gdsc_drug_list
  )

acc_df_gdsc_dtcbinary_foldcv <- get_target_pred_accuracy_batch(
  dataset= "gdsc", estimation_method= "fold_cv" , 
  target_source= gdsc_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score), 
  id_list = gdsc_drug_list
  )

acc_df_gdsc_dtcbinary_loocv <- get_target_pred_accuracy_batch(
  dataset= "gdsc",  estimation_method= "loocv" , 
  target_source= gdsc_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score),
  id_list = gdsc_drug_list
  )


acc_df_gdsc_dtc_foldcv <- get_target_pred_accuracy_batch(
  dataset= "gdsc", estimation_method= "fold_cv" , 
  target_source= gdsc_target_dtc%>% filter(binding_score >0),
  id_list = gdsc_drug_list
  )

acc_df_gdsc_dtc_loocv <- get_target_pred_accuracy_batch(
  dataset= "gdsc",  estimation_method= "loocv" , 
  target_source= gdsc_target_dtc%>% filter(binding_score >0),
  id_list = gdsc_drug_list 
  )


#prism
acc_df_prism_binary_fold_cv <- get_target_pred_accuracy_batch(
  dataset= "prism",  estimation_method= "fold_cv" , 
  target_source= prism_target_binary,
  id_list = prism_drug_list)

acc_df_prism_binary_loocv <- get_target_pred_accuracy_batch(
  dataset= "prism",  estimation_method= "loocv" , 
  target_source= prism_target_binary,
  id_list = prism_drug_list)

acc_df_prism_dtcbinary_foldcv <- get_target_pred_accuracy_batch(
  dataset= "prism", estimation_method= "fold_cv" ,
  target_source= prism_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score),
  id_list = prism_drug_list
  )

acc_df_prism_dtcbinary_loocv <- get_target_pred_accuracy_batch(
  dataset= "prism",  estimation_method= "loocv" ,
  target_source= prism_target_dtc %>% filter(binding_score >0.4) %>% select(- binding_score),
  id_list = prism_drug_list
  )

acc_df_prism_dtc_foldcv <- get_target_pred_accuracy_batch(
  dataset= "prism", estimation_method= "fold_cv" , 
  target_source= prism_target_dtc%>% filter(binding_score >0),
  id_list = prism_drug_list)

acc_df_prism_dtc_loocv <- get_target_pred_accuracy_batch(
  dataset= "prism",  estimation_method= "loocv" , 
  target_source= prism_target_dtc%>% filter(binding_score >0),
  id_list = prism_drug_list)

save.image("~/cluster_scratch/forward_modelling/targetpred_output_allfiltered.RData")
```


```{r}
sum(duplicated(ctrp_data$cpd_smiles)) # no duplicates
sum(duplicated(na.omit(gdsc_data$smiles))) # 1 duplicates
sum(duplicated(prism_data$smiles)) # no duplicates
```


```{r}
# load("~/cluster_scratch/forward_modelling/targetpred_output.RData")
load("~/cluster_scratch/forward_modelling/targetpred_output_filtered.RData")
get_acc_summary <- function(acc_df){
  acc_df %>% 
    group_by(method) %>% 
    summarise(acc_mean= mean(acc,na.rm = T), acc_median= median(acc, na.rm = T))
}


get_acc_violin_plot <- function(acc_df){
  acc_df %>% 
    filter(method %in% c("senbased_genesig_comb2", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") ) %>% 
    ggplot(aes(x=method, y=acc)) + 
    geom_violin()+
    coord_flip()+
    theme_classic()
}
```




```{r}
get_acc_summary(acc_df_ctrp_binary_fold_cv)
get_acc_summary(acc_df_ctrp_binary_loocv)
get_acc_summary(acc_df_ctrp_dtcbinary_foldcv)
get_acc_summary(acc_df_ctrp_dtcbinary_loocv)
get_acc_summary(acc_df_ctrp_dtc_foldcv)
get_acc_summary(acc_df_ctrp_dtc_loocv)


get_acc_violin_plot(acc_df_ctrp_binary_fold_cv)
get_acc_violin_plot(acc_df_ctrp_binary_loocv)
get_acc_violin_plot(acc_df_ctrp_dtcbinary_foldcv)
get_acc_violin_plot(acc_df_ctrp_dtcbinary_loocv)
get_acc_violin_plot(acc_df_ctrp_dtc_foldcv)
get_acc_violin_plot(acc_df_ctrp_dtc_loocv)
```


```{r}
get_acc_summary(acc_df_gdsc_binary_fold_cv)
get_acc_summary(acc_df_gdsc_binary_loocv)
get_acc_summary(acc_df_gdsc_dtcbinary_foldcv)
get_acc_summary(acc_df_gdsc_dtcbinary_loocv)
get_acc_summary(acc_df_gdsc_dtc_foldcv)
get_acc_summary(acc_df_gdsc_dtc_loocv)

get_acc_violin_plot(acc_df_gdsc_binary_fold_cv)
get_acc_violin_plot(acc_df_gdsc_binary_loocv)
get_acc_violin_plot(acc_df_gdsc_dtcbinary_foldcv)
get_acc_violin_plot(acc_df_gdsc_dtcbinary_loocv)
get_acc_violin_plot(acc_df_gdsc_dtc_foldcv)
get_acc_violin_plot(acc_df_gdsc_dtc_loocv)
```


```{r}
get_acc_summary(acc_df_prism_binary_fold_cv)
get_acc_summary(acc_df_prism_binary_loocv)
get_acc_summary(acc_df_prism_dtcbinary_foldcv)
get_acc_summary(acc_df_prism_dtcbinary_loocv)
get_acc_summary(acc_df_prism_dtc_foldcv)
get_acc_summary(acc_df_prism_dtc_loocv)

get_acc_violin_plot(acc_df_prism_binary_fold_cv)
get_acc_violin_plot(acc_df_prism_binary_loocv)
get_acc_violin_plot(acc_df_prism_dtcbinary_foldcv)
get_acc_violin_plot(acc_df_prism_dtcbinary_loocv)
get_acc_violin_plot(acc_df_prism_dtc_foldcv)
get_acc_violin_plot(acc_df_prism_dtc_loocv)
```



imp dtc correlation
```{r}
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(ctrp_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
# 
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(ctrp_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   inner_join(res_ctrp2 %>% select(ces,broad_cpd_id, cpd_name,ces_variance)) %>% 
#   filter(ces_variance < 0.05) %>% 
#   filter(ces >0.3) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()


# feature_imp_ridge_gdsc_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(gdsc_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
# 
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(gdsc_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
```


imp correlation across different dataset
get a shared list of drugs across three set
```{r}
cross_ref_tibble_gdsc <- read_csv("~/cluster_scratch/prior/drug_id_list/cross_ref_tibble_gdsc")
overlapping_drug_list <- sort(intersect(intersect(cross_ref_tibble_gdsc$BROAD_ID, ctrp_data$broad_cpd_id), prism_data$BROAD_ID)) # 44 drugs available (in nature cancer paper 84 compound and median 236 cell line)

imp_ctrp_shared <- feature_imp_ridge_ctrp_ces1 %>% filter(drug %in% overlapping_drug_list) %>% arrange(drug)

imp_prism_shared <- feature_imp_ridge_prism_ces1 %>% 
  filter(drug %in% overlapping_drug_list) %>% arrange(drug)

imp_gdsc_shared <- cross_ref_tibble_gdsc %>% 
  inner_join(  feature_imp_ridge_gdsc_ces1, by =c("DRUG_ID"= "drug")) %>% 
  select(-pubchem_cid, -DRUG_ID) %>% 
  rename(drug= BROAD_ID) %>% 
  filter(drug %in% overlapping_drug_list) %>% 
  arrange(drug)

get_cor_long_tibble <- function(df1,df2){ 
  cor_mat <- cor(
    x = t(df1[,-1]),
    y= t(df2[,-1]),
    method = "pearson"
    )
  cor_vec <- diag(cor_mat)
  }


cor_tibble <- tibble(drug= imp_ctrp_shared$drug, 
                     ctrp_gdsc = get_cor_long_tibble(imp_ctrp_shared, imp_gdsc_shared), 
                     ctrp_prism = get_cor_long_tibble(imp_ctrp_shared, imp_prism_shared), 
                     gdsc_prism = get_cor_long_tibble(imp_prism_shared, imp_gdsc_shared)) 

cor_tibble

```


## MOA 


## 5) Combine the result and plotting
```{r}
rm(list = ls())
load("~/cluster_scratch/glmnet_modelling/drugbank_supervised_prediction.RData")
acc_list <- ls()
acc_drugbank <- map_dfc(.x = acc_list,.f = get)
colnames(acc_drugbank) <- acc_list


load("~/cluster_scratch/glmnet_modelling/dtc_supervised_prediction.RData")
acc_dtc <- map_dfc(.x = acc_list,.f = get)
colnames(acc_dtc) <- acc_list

acc_supervised_target_pred <- bind_rows(
  acc_drugbank %>% 
    pivot_longer(cols= everything(),names_to = "method",values_to= "spearman_cor") %>%
    mutate(label_dataset= "drugbank")
  ,
  acc_dtc %>%
    pivot_longer(cols= everything(),names_to = "method",values_to= "spearman_cor") %>%
    mutate(label_dataset= "dtc")
)

acc_supervised_target_pred %>% 
  ggplot(aes(x= method, y = spearman_cor, fill= label_dataset)) +
  geom_boxplot()+
  theme_classic()


fig <- acc_supervised_target_pred %>% 
  ggplot(aes(fill= method,  x= label_dataset,y = spearman_cor)) +
  geom_boxplot(outlier.color = "white")+
  theme_classic()+
  scale_fill_discrete(name = "Predictor data type", labels = c("CERES","CES1","CES2", "DEMETER2", "Sensitivity", "Sensitivity+CES1", "Sensitivity+EXP", "EXP"))+
  xlab("Target resources" )+
  ylab("Prediction accuracy")
  
fig
```



```{r,fig.width=5, fig.height=2}
fig
```
```{r}
fig <- acc_supervised_target_pred %>% 
  filter(method %in% c("acc_ces1", "acc_sen", "acc_sen_ces1", "acc_exp", "acc_sen_exp")) %>% 
  ggplot(aes(fill= method,  x= label_dataset,y = spearman_cor)) +
  geom_boxplot(outlier.color = "white")+
  theme_classic()+
  scale_fill_discrete(name = "Predictor data type", labels = c("CES1","Sensitivity", "Sensitivity+CES1", "Sensitivity+EXP", "EXP"))+
  xlab("Target resources" )+
  ylab("Prediction accuracy")
  
```


```{r,fig.width=4, fig.height=2}
fig
```











## 6) further explore the prediction result.

drug category, Does perturbation data favor certain kind of drug comparing to chemical finger print?

Continues binding score and prediction scatter plot.


## 7)

Exploring whether similarity matrix calculated on the ess signature is a better representation of drug target based similarity matrix
```{r}
load("~/cluster_scratch/glmnet_modelling/target_pred_server/targetpred_serverinput.RData")

source('~/cluster_wrk/drug_moa/supervised_target_pred/get_target_matrix_from_long_target_tibble.R')

target_tibble_drugbank= ctrp_target_tibble %>%
  ungroup() %>%
  select(broad_cpd_id, gene_symbol_of_protein_target) %>%
  rename(drug=broad_cpd_id, target_gene=gene_symbol_of_protein_target) %>% 
  mutate(binding_score= 1)

target_tibble_dtc <- ctrp_target_dtc %>% 
  select(standard_inchi_key, gene_name, interaction_strength) %>%
  filter(interaction_strength!= 0) %>% 
  drop_na() %>% 
  group_by(standard_inchi_key, gene_name) %>% 
  summarize(interaction_strength= median(interaction_strength,na.rm = T)) %>% 
  ungroup() %>% 
  inner_join(ctrpv2_list_to_zia,by= c("standard_inchi_key"= "InChIKey")) %>% 
  select(broad_cpd_id, gene_name, interaction_strength) %>% 
  group_by(broad_cpd_id, gene_name) %>% 
  summarize(interaction_strength= max(interaction_strength,na.rm = T)) %>% 
  ungroup() %>%   rename(drug=broad_cpd_id, target_gene=gene_name, binding_score= interaction_strength) %>% 
  filter(binding_score>0.4) %>% 
    mutate(binding_score= 1)

target_mat_ctrp <- get_target_mat(target_tibble_drugbank)

target_mat_dtc <- get_target_mat(target_tibble_dtc)
```

```{r}
target_drugbank_cor <- t(target_mat_ctrp) %>% 
  prabclus::jaccard()

consensusexp_cor <- t(drug_consensus %>% filter(BROAD_ID %in% colnames(ces1_cor 
get_long_tibble_from_mat <- function(mat){
  tmp <- as_tibble(mat) %>% 
  mutate(drug1= colnames(mat)) %>% 
  pivot_longer(cols = - drug1,names_to= 'drug2', values_to='similiarity') %>% 
    distinct()
  return(tmp)
}


res <- get_long_tibble_from_mat(target_drugbank_cor) %>%
  rename(targetdrugbank_similiarity= similiarity) %>% 
  inner_join(get_long_tibble_from_mat(maccs_cor) %>% 
               rename(maccs_similiarity= similiarity)) %>% 
  inner_join(get_long_tibble_from_mat(ces1_cor) %>% 
                rename(ces1_similiarity= similiarity)) 

  # inner_join(get_long_tibble_from_mat(ces1_cor))   


cor(res$targetdrugbank_similiarity, res$maccs_similiarity,method = "spearman") #0.26

cor(res$targetdrugbank_similiarity, res$ces1_similiarity,method = "spearman")
#-0.48

res %>% 
  ggplot(mapping = aes(y= targetdrugbank_similiarity, x= maccs_similiarity)) +
  geom_point(size=0.1)


res %>% 
  ggplot(mapping = aes(y= targetdrugbank_similiarity, x= ces1_similiarity)) +
  geom_point(size=0.1)
```



## checking correlation

We want to check how original ces and ces based feature importance is correlating with the other basal cell line feature.

```{r}
load("~/cluster_scratch/forward_modelling/ctrp_input.RData")


map(.x = 2:437, .f = ~cor(ces1[,.x], ceres[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()

map(.x = 2:437, .f = ~cor(ces1[,.x], demeter2[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()

map(.x = 2:437, .f = ~cor(ces1[,.x], exp_seq[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()


map(.x = 2:437, .f = ~cor(ceres[,.x], demeter2[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()


```


```{r}
load("~/cluster_scratch/forward_modelling/targetpred_output_filtered.RData")

map(.x = 2:495, .f = ~cor(feature_imp_ridge_ctrp_ces1[,.x], feature_imp_ridge_ctrp_ceres[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()

map(.x = 2:495, .f = ~cor(feature_imp_ridge_ctrp_ces1[,.x], feature_imp_ridge_ctrp_demeter2[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()

map(.x = 2:495, .f = ~cor(feature_imp_ridge_ctrp_ces1[,.x], feature_imp_ridge_ctrp_exp[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()

map(.x = 2:495, .f = ~cor(feature_imp_ridge_ctrp_ceres[,.x], feature_imp_ridge_ctrp_demeter2[,.x],method = "spearman")) %>% 
  unlist() %>% 
  hist()

```

