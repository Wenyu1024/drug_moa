---
title: "Modelling output exploration Part2 drug target prediction"
author: "Wenyu"
date: "1/15/2021"
output: html_document
---

The aim of this nootbook is to explore whether the extracted model importances from the sen~ess glmnet model can be used in supervised drug target prediction


## 1 Init
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
```


lets use the existing target information of the
365 drugs to do cv and predict drug target

The prediction algorithm can be based on dream challenge and performance is evaluated using cv.
We then consider again a nested cv to first find the thresholding parameters 

the central idea is to check what additional value can such basal cell info bring to MOA prediction in addition to the drug sensitivity and how does the accuracy comparing to, for example, chemical fingerprint based prediction?


Check how many drugs are avaliable for supervised target prediction comparison
The prediction itself is moved to server batch job codes.
```{r}

#217
ctrp_drug_list <- res_ctrp2 %>% 
  filter(!sample_size <100) %>% 
  filter(broad_cpd_id %in% drug_consensus_ctrp$drug) %>% 
  select(cpd_smiles,broad_cpd_id, sample_size) %>%
  drop_na() %>% 
  group_by(cpd_smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(broad_cpd_id)
  
#57
gdsc_drug_list <- res_gdsc2 %>% 
  filter(DRUG_ID %in% drug_consensus_gdsc$drug) %>% 
  filter(!sample_size <100) %>% 
  select(smiles,DRUG_ID, sample_size) %>%
  drop_na() %>% 
  group_by(smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(DRUG_ID)

#918  (805, 137)
prism_drug_list <- res_prism2  %>% 
  filter(BROAD_ID %in% drug_consensus_prism$drug) %>% 
  filter(!sample_size <100) %>% 
  select(smiles,BROAD_ID, sample_size) %>%
  drop_na() %>% 
  group_by(smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(BROAD_ID)

length(intersect(ctrp_drug_list, unique(ctrp_target_binary$drug))) #196
length(intersect(ctrp_drug_list, unique(ctrp_target_dtc$drug))) #183
length(intersect(gdsc_drug_list, unique(gdsc_target_binary$drug))) #49
length(intersect(gdsc_drug_list, unique(gdsc_target_dtc$drug))) #52
length(intersect(prism_drug_list, unique(prism_target_binary$drug))) #805
length(intersect(prism_drug_list, unique(prism_target_dtc$drug))) #137
```

## 2 check prediction result 
### 2.1 Function
```{r}

get_acc_summary <- function(acc_df){
  acc_df <- acc_df %>% 
    filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
  
  acc_df$method <- 
     factor(acc_df$method, 
            levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
            labels = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))
  
  acc_df %>%    
    group_by(method) %>% 
    summarise(acc_mean= mean(acc,na.rm = T), acc_median= median(acc, na.rm = T))
}


get_acc_violin_plot <- function(acc_df){
  library(ggsci)
  acc_df <- acc_df %>% 
    filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
  
  acc_df$method <- 
     factor(acc_df$method, 
            levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
            labels = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))
  acc_df %>% 
    ggplot(aes(x=method, y=acc, color= method)) + 
    geom_violin()+
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
             colour = "black")+
    theme_classic()+
    theme(axis.text.x = element_blank())+
    xlab(label = "")+
    ylab(label = "AUC")+
    # scale_color_manual(name="Cylinders",
    #                  labels=c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))+
    scale_color_npg()
}


```

### 2.2 CTRP
```{r}
get_acc_summary(acc_df_ctrp_binary_fold_cv)
# get_acc_summary(acc_df_ctrp_binary_loocv)
get_acc_summary(acc_df_ctrp_dtcbinary_foldcv)
# get_acc_summary(acc_df_ctrp_dtcbinary_loocv)
get_acc_summary(acc_df_ctrp_dtc_foldcv)
# get_acc_summary(acc_df_ctrp_dtc_loocv)


fig_ctrp1 <- get_acc_violin_plot(acc_df_ctrp_binary_fold_cv)
# get_acc_violin_plot(acc_df_ctrp_binary_loocv)
# get_acc_box_plot(acc_df_ctrp_binary_loocv)
fig_ctrp2 <- get_acc_violin_plot(acc_df_ctrp_dtcbinary_foldcv)
# get_acc_violin_plot(acc_df_ctrp_dtcbinary_loocv)
fig_ctrp3 <- get_acc_violin_plot(acc_df_ctrp_dtc_foldcv)+ ylab(label = "COR")
# get_acc_violin_plot(acc_df_ctrp_dtc_loocv)


```

### 2.3 GDSC
```{r}
get_acc_summary(acc_df_gdsc_binary_fold_cv)
# get_acc_summary(acc_df_gdsc_binary_loocv)
get_acc_summary(acc_df_gdsc_dtcbinary_foldcv)
# get_acc_summary(acc_df_gdsc_dtcbinary_loocv)
get_acc_summary(acc_df_gdsc_dtc_foldcv)
# get_acc_summary(acc_df_gdsc_dtc_loocv)

fig_gdsc1 <- get_acc_violin_plot(acc_df_gdsc_binary_fold_cv)
# get_acc_violin_plot(acc_df_gdsc_binary_loocv)
fig_gdsc2 <- get_acc_violin_plot(acc_df_gdsc_dtcbinary_foldcv)
# get_acc_violin_plot(acc_df_gdsc_dtcbinary_loocv)
fig_gdsc3 <- get_acc_violin_plot(acc_df_gdsc_dtc_foldcv)+ ylab(label = "COR")
# get_acc_violin_plot(acc_df_gdsc_dtc_loocv)
```

### 2.4 PRISM
```{r}
get_acc_summary(acc_df_prism_binary_fold_cv)
# get_acc_summary(acc_df_prism_binary_loocv)
get_acc_summary(acc_df_prism_dtcbinary_foldcv)
# get_acc_summary(acc_df_prism_dtcbinary_loocv)
get_acc_summary(acc_df_prism_dtc_foldcv)
# get_acc_summary(acc_df_prism_dtc_loocv)

get_acc_violin_plot(acc_df_prism_binary_fold_cv)
# get_acc_violin_plot(acc_df_prism_binary_loocv)
get_acc_violin_plot(acc_df_prism_dtcbinary_foldcv)
# get_acc_violin_plot(acc_df_prism_dtcbinary_loocv)
get_acc_violin_plot(acc_df_prism_dtc_foldcv)+ ylab(label = "COR")
# get_acc_violin_plot(acc_df_prism_dtc_loocv)
```


### 2.5 Output figure preparation

```{r}
acc_df <- 
  bind_rows(acc_df_ctrp_binary_fold_cv %>% mutate(Dataset= "CTRP", TargetType= "Primary")) %>% 
  bind_rows(acc_df_ctrp_dtcbinary_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Binarized")) %>% 
  bind_rows(acc_df_ctrp_dtc_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Continues")) %>% 
bind_rows(acc_df_gdsc_binary_fold_cv %>% mutate(Dataset= "GDSC", TargetType= "Primary")) %>% 
  bind_rows(acc_df_gdsc_dtcbinary_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Binarized")) %>% 
  bind_rows(acc_df_gdsc_dtc_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Continues")) %>% 
  filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
  # mutate(Y_names= case_when(TargetTpue %in% "Kinome-wide Continues" ~ "COR"),TRUE~AUC)

acc_df$method <-  factor(
  acc_df$method, 
  levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
  labels = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))

acc_df$TargetType <-  factor(
  acc_df$TargetType, 
  levels= c("Primary", "Kinome-wide Binarized", "Kinome-wide Continues"),
  labels = c("Primary (AUC)", "Kinome-wide Binarized (AUC)", "Kinome-wide Continues (COR)"))
```

```{r}

# annotate_figure(figure,
#                top = text_grob("Visualizing Tooth Growth", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Figure arranged using ggpubr", color = "green", rot = 90),
#                right = text_grob(bquote("Superscript: ("*kg~NH[3]~ha^-1~yr^-1*")"), rot = 90),
#                fig.lab = "Figure 1", fig.lab.face = "bold"
# )
```

```{r,fig.width= 3.5,fig.height=8}
acc_df %>% 
  ggplot(aes(x=method, y=acc, color= method)) + 
    geom_violin()+
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
             colour = "black")+
    theme_classic()+
    theme(axis.text.x = element_blank())+
    xlab(label = "")+
    ylab(label = "Accuracy")+
    scale_color_npg()+
    theme(legend.position="top")+  
    facet_grid(cols = vars(Dataset), rows = vars(TargetType),scales = "free")+
    guides(color= guide_legend(nrow = 2,title.position = "top"))+
    labs(color = "Drug Representation")
```

Figure for group meeting
```{r}
acc_df1 <- 
  bind_rows(acc_df_ctrp_binary_fold_cv %>% mutate(Dataset= "CTRP", TargetType= "Primary")) %>% 
  bind_rows(acc_df_ctrp_dtcbinary_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Binarized")) %>% 
  bind_rows(acc_df_ctrp_dtc_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Continues")) %>% 
  bind_rows(acc_df_gdsc_binary_fold_cv %>% mutate(Dataset= "GDSC", TargetType= "Primary")) %>% 
  bind_rows(acc_df_gdsc_dtcbinary_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Binarized")) %>% 
  bind_rows(acc_df_gdsc_dtc_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Continues")) %>% 
  bind_rows(acc_df_prism_binary_fold_cv %>% mutate(Dataset= "PRISM", TargetType= "Primary")) %>% 
  bind_rows(acc_df_prism_dtcbinary_foldcv %>% mutate(Dataset= "PRISM", TargetType= "Kinome-wide Binarized")) %>% 
  bind_rows(acc_df_prism_dtc_foldcv %>% mutate(Dataset= "PRISM", TargetType= "Kinome-wide Continues")) %>% 
  filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
  # mutate(Y_names= case_when(TargetTpue %in% "Kinome-wide Continues" ~ "COR"),TRUE~AUC)

acc_df1$method <-  factor(
  acc_df1$method, 
  levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
  labels = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))

acc_df1$TargetType <-  factor(
  acc_df1$TargetType, 
  levels= c("Primary", "Kinome-wide Binarized", "Kinome-wide Continues"),
  labels = c("Primary (AUC)", "Kinome-wide Binarized (AUC)", "Kinome-wide Continues (COR)"))
```


```{r,fig.width=9,fig.height=6.5}
acc_df1 %>% 
  ggplot(aes(x=method, y=acc, color= method)) + 
    geom_violin()+
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
             colour = "black",size=0.2)+
    theme_classic()+
    theme(axis.text.x = element_blank())+
    xlab(label = "")+
    ylab(label = "Accuracy")+
    scale_color_npg()+
    theme(legend.position="right")+  
    facet_grid(cols = vars(Dataset), rows = vars(TargetType),scales = "free")+
    guides(color= guide_legend(nrow = 4,title.position = "top"))+
    labs(color = "Drug Representation")
```


imp dtc correlation
```{r}
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(ctrp_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
# 
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(ctrp_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   inner_join(res_ctrp2 %>% select(ces,broad_cpd_id, cpd_name,ces_variance)) %>% 
#   filter(ces_variance < 0.05) %>% 
#   filter(ces >0.3) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()


# feature_imp_ridge_gdsc_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(gdsc_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
# 
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(gdsc_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
```




## 3 Compare ConSen-sig and ConExp-sig. They are very different.
Does ConSen-sig correlate with ConExp-sig
Figure 3B
```{r}
overlapping_gene_ctrp_sig <- intersect(
  x = colnames(feature_imp_ridge_ctrp_comb1)[-1], 
  y = colnames(drug_consensus_ctrp)[-1]
  )

tmp <- inner_join(
  feature_imp_ridge_ctrp_comb1 %>%
    filter(drug %in% ctrp_drug_list) %>% 
    select(one_of(c("drug", overlapping_gene_ctrp_sig))) %>% 
    pivot_longer(cols = -drug, names_to= "gene", values_to= "Consen_sigvalue")
  ,
  drug_consensus_ctrp %>%
    filter(drug %in% ctrp_drug_list) %>% 
    select(one_of(c("drug", overlapping_gene_ctrp_sig))) %>% 
    pivot_longer(cols = -drug, names_to= "gene", values_to= "Conexp_sigvalue")
  )
  
cor_druglevel <- tmp %>% 
  group_by(drug) %>% 
  summarize(cor= cor(Consen_sigvalue, Conexp_sigvalue,method = "spearman"))


hist(cor_druglevel$cor)



overlapping_gene_gdsc_sig <- intersect(
  x = colnames(feature_imp_ridge_gdsc_comb1)[-1], 
  y = colnames(drug_consensus_gdsc)[-1]
  )

tmp <- inner_join(
  feature_imp_ridge_gdsc_comb1 %>%
    filter(drug %in% gdsc_drug_list) %>% 
    select(one_of(c("drug", overlapping_gene_gdsc_sig))) %>% 
    pivot_longer(cols = -drug, names_to= "gene", values_to= "Consen_sigvalue")
  ,
  drug_consensus_gdsc %>%
    filter(drug %in% gdsc_drug_list) %>% 
    select(one_of(c("drug", overlapping_gene_gdsc_sig))) %>% 
    pivot_longer(cols = -drug, names_to= "gene", values_to= "Conexp_sigvalue")
  )
  
cor_druglevel <- tmp %>% 
  group_by(drug) %>% 
  summarize(cor= cor(Consen_sigvalue, Conexp_sigvalue,method = "spearman"))


hist(cor_druglevel$cor)



overlapping_gene_prism_sig <- intersect(
  x = colnames(feature_imp_ridge_prism_comb1)[-1], 
  y = colnames(drug_consensus_prism)[-1]
  )

tmp <- inner_join(
  feature_imp_ridge_prism_comb1 %>%
    filter(drug %in% prism_drug_list) %>% 
    select(one_of(c("drug", overlapping_gene_prism_sig))) %>% 
    pivot_longer(cols = -drug, names_to= "gene", values_to= "Consen_sigvalue")
  ,
  drug_consensus_prism %>%
    filter(drug %in% prism_drug_list) %>% 
    select(one_of(c("drug", overlapping_gene_prism_sig))) %>% 
    pivot_longer(cols = -drug, names_to= "gene", values_to= "Conexp_sigvalue")
  )
  
cor_druglevel <- tmp %>% 
  group_by(drug) %>% 
  summarize(cor= cor(Consen_sigvalue, Conexp_sigvalue,method = "spearman"))


hist(cor_druglevel$cor)
```


## 4 Some additional analysis

We want to check how original ces and ces based feature importance is correlating with the other basal cell line feature.

```{r}
load("~/cluster_scratch/forward_modelling/ctrp_input.RData")

tmp <- unlist(ces1[1,-1])
map(.x = 1:437, .f = ~cor(unlist(ces1[.x,-1]), unlist(ceres[.x,-1]),method = "spearman")) %>% 
  unlist() %>% 
  hist()

map(.x = 1:437, .f = ~cor(unlist(ces1[.x,-1]), unlist(demeter2[.x,-1]),method = "spearman")) %>% 
  unlist() %>% 
  hist()



map(.x = 1:437, .f = ~cor(unlist(ceres[.x,-1]), unlist(demeter2[.x,-1]),method = "spearman")) %>% 
  unlist() %>% 
  hist()



map(.x = 1:437, .f = ~cor(unlist(ces1[.x,-1]), unlist(exp_seq[.x,-1]),method = "spearman")) %>%
  unlist() %>%
  hist()

# ces_columnscaled <- ces %>% 
#   mutate_at(2:10624, scale)
# 
# ceres_columnscaled <- ceres %>% 
#   mutate_at(2:10624, scale)


ces1_columnscaled <- ces1 %>% 
  pivot_longer(cols= -DepMap_ID, names_to = "gene", values_to= "ess") %>% 
  pivot_wider(id_cols = gene, names_from= DepMap_ID, values_from= ess) %>% 
  mutate_at(2:438, .funs = scale) %>% 
  pivot_longer(cols= -gene, names_to = "DepMap_ID", values_to= "ess") %>% 
  pivot_wider(id_cols = DepMap_ID, names_from= gene, values_from= ess) 

ceres_columnscaled <- ceres %>% 
  pivot_longer(cols= -DepMap_ID, names_to = "gene", values_to= "ess") %>% 
  pivot_wider(id_cols = gene, names_from= DepMap_ID, values_from= ess) %>% 
  mutate_at(2:438, .funs = scale) %>% 
  pivot_longer(cols= -gene, names_to = "DepMap_ID", values_to= "ess") %>% 
  pivot_wider(id_cols = DepMap_ID, names_from= gene, values_from= ess) 


map(.x = 2:10624, .f = ~cor(unlist(ces1[,.x]), unlist(ceres[,.x]),method = "spearman")) %>%
  unlist() %>% 
  hist()

map(.x = 2:10624, 
    .f = 
      ~cor(unlist(ces1_columnscaled[,.x]),unlist(ceres_columnscaled[,.x]),method = "spearman")) %>% 
  unlist() %>% 
  hist()

# map(.x = 2:10624, .f = ~cor(unlist(ces1[,.x]), unlist(demeter2[,.x]),method = "spearman")) %>%
#   unlist() %>% 
#   hist()
# 
# 
# map(.x = 2:10624, .f = ~cor(unlist(demeter2[,.x]), unlist(ceres[,.x]),method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
```




```{r}
load("~/cluster_scratch/forward_modelling/targetpred_serverinput.RData")

map(.x = 1:5, .f = ~cor(feature_imp_ridge_ctrp_ces1[.x,-1], feature_imp_ridge_ctrp_ceres[.x,-1],method = "spearman")) %>%
  unlist() %>%
  hist()
# 
# map(.x = 1:545, .f = ~cor(feature_imp_ridge_ctrp_ces1[.x,-1], feature_imp_ridge_ctrp_demeter2[.x,],method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
# 
# map(.x = 1:545, .f = ~cor(feature_imp_ridge_ctrp_ces1[.x,], feature_imp_ridge_ctrp_exp[.x,],method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
# 
# map(.x = 1:545, .f = ~cor(feature_imp_ridge_ctrp_ceres[.x,], feature_imp_ridge_ctrp_demeter2[.x,],method = "spearman")) %>% 
#   unlist() %>% 
#   hist()

tmp <- bind_rows(feature_imp_ridge_ctrp_ces1[1,],feature_imp_ridge_ctrp_ceres[1,]) %>% 
  select(-drug) %>% 
  t() %>% 
  as_tibble() 
tmp %>% 
  ggplot(aes(x=V1, y= V2))+
  geom_point()

cor(tmp$V1, tmp$V2)


tmp <- bind_rows(feature_imp_ridge_ctrp_ces1[1,],feature_imp_ridge_ctrp_demeter2[1,]) %>% 
  select(-drug) %>% 
  t() %>% 
  as_tibble() 
tmp %>% 
  ggplot(aes(x=V1, y= V2))+
  geom_point()

cor(tmp$V1, tmp$V2)


tmp <- bind_rows(feature_imp_ridge_ctrp_ces1[1,],feature_imp_ridge_ctrp_exp[1,]) %>% 
  select(-drug) %>% 
  t() %>% 
  as_tibble() 
tmp %>% 
  ggplot(aes(x=V1, y= V2))+
  geom_point()

cor(tmp$V1, tmp$V2)

```

