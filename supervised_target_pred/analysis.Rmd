---
title: "Modelling output exploration Part2 drug target prediction"
author: "Wenyu"
date: "1/15/2021"
output: html_document
---

The aim of this nootbook is to explore whether the extracted model importances from the sen~ess glmnet model can be used in supervised drug target prediction


## 1 Init
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
source("~/cluster_wrk/drug_moa/supervised_target_pred/function/get_target_pred_supervised.R")
```


Check how many drugs are available for supervised target prediction comparison
The prediction itself is moved to server batch job codes.
```{r}

#217
ctrp_drug_list <- res_ctrp2 %>% 
  select(-.metric, -estimate, -variance, -input) %>% 
  distinct() %>% 
  filter(!sample_size <100) %>% 
  filter(broad_cpd_id %in% drug_consensus_ctrp$drug) %>% 
  filter(!drug_pair) %>% 
  select(cpd_smiles,broad_cpd_id, sample_size) %>%
  drop_na() %>% 
  group_by(cpd_smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(broad_cpd_id)
  
#57
gdsc_drug_list <- res_gdsc2 %>% 
  select(-.metric, -estimate, -variance, -input) %>% 
  distinct() %>% 
  filter(DRUG_ID %in% drug_consensus_gdsc$drug) %>% 
  filter(!sample_size <100) %>% 
  select(smiles,DRUG_ID, sample_size) %>%
  drop_na() %>% 
  group_by(smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(DRUG_ID)

#918  (805, 137)
prism_drug_list <- res_prism2  %>% 
  select(-.metric, -estimate, -variance, -input) %>% 
  distinct() %>% 
  filter(BROAD_ID %in% drug_consensus_prism$drug) %>% 
  filter(!sample_size <100) %>% 
  select(smiles,BROAD_ID, sample_size) %>%
  drop_na() %>% 
  group_by(smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(BROAD_ID)

length(intersect(ctrp_drug_list, unique(ctrp_target_binary$drug))) #196
length(intersect(ctrp_drug_list, unique(ctrp_target_dtc$drug))) #183
length(intersect(gdsc_drug_list, unique(gdsc_target_binary$drug))) #49
length(intersect(gdsc_drug_list, unique(gdsc_target_dtc$drug))) #52
length(intersect(prism_drug_list, unique(prism_target_binary$drug))) #805
length(intersect(prism_drug_list, unique(prism_target_dtc$drug))) #137
```

check how many drugs are available for exploring ess-signature without comparing to other set of features?
```{r}
#n =488
ctrp_allvalid_list <- res_ctrp2 %>% 
  select(-.metric, -estimate, -variance, -input) %>% 
  distinct() %>% 
  filter(!sample_size <100) %>% 
  filter(!drug_pair) %>% 
  select(cpd_smiles,broad_cpd_id, sample_size) %>%
  drop_na() %>% 
  group_by(cpd_smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(broad_cpd_id)

#n= 122
gdsc_allvalid_list <- res_gdsc2 %>% 
  select(-.metric, -estimate, -variance, -input) %>% 
  distinct() %>% 
  filter(!sample_size <100) %>% 
  select(smiles,DRUG_ID, sample_size) %>%
  drop_na() %>% 
  group_by(smiles) %>% 
  slice_max(n=1, order_by=sample_size) %>% 
  pull(DRUG_ID)

length(intersect(ctrp_allvalid_list, unique(ctrp_target_binary$drug))) #360
length(intersect(ctrp_allvalid_list, unique(ctrp_target_dtc$drug))) #209

length(intersect(gdsc_allvalid_list, unique(gdsc_target_binary$drug))) #89
length(intersect(gdsc_allvalid_list, unique(gdsc_target_dtc$drug))) #100
```


## 2 Check prediction result 
### 2.1 Function
```{r}

get_acc_summary <- function(acc_df){
  acc_df <- acc_df %>% 
    filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
  
  acc_df$method <- 
     factor(acc_df$method, 
            levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
            labels = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))
  
  acc_df %>%    
    group_by(method) %>% 
    summarise(acc_mean= mean(acc,na.rm = T), acc_median= median(acc, na.rm = T))
}


get_acc_violin_plot <- function(acc_df){
  library(ggsci)
  acc_df <- acc_df %>% 
    filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
  
  acc_df$method <- 
     factor(acc_df$method, 
            levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
            labels = c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))
  acc_df %>% 
    ggplot(aes(x=method, y=acc, color= method)) + 
    geom_violin()+
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
             colour = "black")+
    theme_classic()+
    theme(axis.text.x = element_blank())+
    xlab(label = "")+
    ylab(label = "AUC")+
    # scale_color_manual(name="Cylinders",
    #                  labels=c("ConSen-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))+
    scale_color_npg()
}


```

### 2.2 CTRP
```{r}
get_acc_summary(acc_df_ctrp_binary_fold_cv)
# get_acc_summary(acc_df_ctrp_binary_loocv)
get_acc_summary(acc_df_ctrp_dtcbinary_foldcv)
# get_acc_summary(acc_df_ctrp_dtcbinary_loocv)
get_acc_summary(acc_df_ctrp_dtc_foldcv)
# get_acc_summary(acc_df_ctrp_dtc_loocv)


fig_ctrp1 <- get_acc_violin_plot(acc_df_ctrp_binary_fold_cv)
# get_acc_violin_plot(acc_df_ctrp_binary_loocv)
# get_acc_box_plot(acc_df_ctrp_binary_loocv)
fig_ctrp2 <- get_acc_violin_plot(acc_df_ctrp_dtcbinary_foldcv)
# get_acc_violin_plot(acc_df_ctrp_dtcbinary_loocv)
fig_ctrp3 <- get_acc_violin_plot(acc_df_ctrp_dtc_foldcv)+ ylab(label = "COR")
# get_acc_violin_plot(acc_df_ctrp_dtc_loocv)


```

### 2.3 GDSC
```{r}
get_acc_summary(acc_df_gdsc_binary_fold_cv)
# get_acc_summary(acc_df_gdsc_binary_loocv)
get_acc_summary(acc_df_gdsc_dtcbinary_foldcv)
# get_acc_summary(acc_df_gdsc_dtcbinary_loocv)
get_acc_summary(acc_df_gdsc_dtc_foldcv)
# get_acc_summary(acc_df_gdsc_dtc_loocv)

fig_gdsc1 <- get_acc_violin_plot(acc_df_gdsc_binary_fold_cv)
# get_acc_violin_plot(acc_df_gdsc_binary_loocv)
fig_gdsc2 <- get_acc_violin_plot(acc_df_gdsc_dtcbinary_foldcv)
# get_acc_violin_plot(acc_df_gdsc_dtcbinary_loocv)
fig_gdsc3 <- get_acc_violin_plot(acc_df_gdsc_dtc_foldcv)+ ylab(label = "COR")
# get_acc_violin_plot(acc_df_gdsc_dtc_loocv)
```

### 2.4 PRISM
```{r}
get_acc_summary(acc_df_prism_binary_fold_cv)
# get_acc_summary(acc_df_prism_binary_loocv)
get_acc_summary(acc_df_prism_dtcbinary_foldcv)
# get_acc_summary(acc_df_prism_dtcbinary_loocv)
get_acc_summary(acc_df_prism_dtc_foldcv)
# get_acc_summary(acc_df_prism_dtc_loocv)

get_acc_violin_plot(acc_df_prism_binary_fold_cv)
# get_acc_violin_plot(acc_df_prism_binary_loocv)
get_acc_violin_plot(acc_df_prism_dtcbinary_foldcv)
# get_acc_violin_plot(acc_df_prism_dtcbinary_loocv)
get_acc_violin_plot(acc_df_prism_dtc_foldcv)+ ylab(label = "COR")
# get_acc_violin_plot(acc_df_prism_dtc_loocv)
```


### 2.5 Output figure preparation

```{r}
acc_df <- 
  bind_rows(acc_df_ctrp_binary_fold_cv %>% mutate(Dataset= "CTRP", TargetType= "Primary")) %>% 
  bind_rows(acc_df_ctrp_dtcbinary_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Binarized")) %>% 
  bind_rows(acc_df_ctrp_dtc_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Continues")) %>% 
bind_rows(acc_df_gdsc_binary_fold_cv %>% mutate(Dataset= "GDSC", TargetType= "Primary")) %>% 
  bind_rows(acc_df_gdsc_dtcbinary_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Binarized")) %>% 
  bind_rows(acc_df_gdsc_dtc_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Continues")) %>% 
  filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
  # mutate(Y_names= case_when(TargetTpue %in% "Kinome-wide Continues" ~ "COR"),TRUE~AUC)

acc_df$method <-  factor(
  acc_df$method, 
  levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
  labels = c("Ess-sig", "Exp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))

acc_df$TargetType <-  factor(
  acc_df$TargetType, 
  levels= c("Primary", "Kinome-wide Binarized", "Kinome-wide Continues"),
  labels = c("Primary (AUC)", "Kinome-wide Binarized (AUC)", "Kinome-wide Continues (COR)"))
```

```{r}

# annotate_figure(figure,
#                top = text_grob("Visualizing Tooth Growth", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Figure arranged using ggpubr", color = "green", rot = 90),
#                right = text_grob(bquote("Superscript: ("*kg~NH[3]~ha^-1~yr^-1*")"), rot = 90),
#                fig.lab = "Figure 1", fig.lab.face = "bold"
# )
```

```{r,fig.width= 2.5,fig.height=7.5}
fig <- acc_df %>% 
  ggplot(aes(x=method, y=acc, color= method, fill= method)) + 
    geom_violin()+
    stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
             colour = "black")+
    theme_classic()+
    theme(axis.text.x = element_blank())+
    xlab(label = "")+
    ylab(label = "Accuracy")+
    scale_color_npg()+
    scale_fill_npg()+
    facet_grid(cols = vars(Dataset), rows = vars(TargetType),scales = "free")+
    theme(legend.position="top")+
    guides(color= guide_legend(nrow = 2,title.position = "top"))+
    guides(fill= guide_legend(nrow = 2,title.position = "top"))+
    labs(color = "Signature type", fill="Signature type" )+
    ylab("Supervised target prediction accuracy")


fig
# ggsave(fig, filename = "~/cluster_wrk/drug_moa/supervised_target_pred/fig_res/fig 3B.pdf",width = 6,height = 7)
# ggsave(fig, filename = "~/cluster_wrk/drug_moa/supervised_target_pred/fig_res/fig 3B.tiff",width = 6,height = 7)
```

Figure for group meeting
```{r}
# acc_df1 <- 
#   bind_rows(acc_df_ctrp_binary_fold_cv %>% mutate(Dataset= "CTRP", TargetType= "Primary")) %>% 
#   bind_rows(acc_df_ctrp_dtcbinary_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Binarized")) %>% 
#   bind_rows(acc_df_ctrp_dtc_foldcv %>% mutate(Dataset= "CTRP", TargetType= "Kinome-wide Continues")) %>% 
#   bind_rows(acc_df_gdsc_binary_fold_cv %>% mutate(Dataset= "GDSC", TargetType= "Primary")) %>% 
#   bind_rows(acc_df_gdsc_dtcbinary_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Binarized")) %>% 
#   bind_rows(acc_df_gdsc_dtc_foldcv %>% mutate(Dataset= "GDSC", TargetType= "Kinome-wide Continues")) %>% 
#   bind_rows(acc_df_prism_binary_fold_cv %>% mutate(Dataset= "PRISM", TargetType= "Primary")) %>% 
#   bind_rows(acc_df_prism_dtcbinary_foldcv %>% mutate(Dataset= "PRISM", TargetType= "Kinome-wide Binarized")) %>% 
#   bind_rows(acc_df_prism_dtc_foldcv %>% mutate(Dataset= "PRISM", TargetType= "Kinome-wide Continues")) %>% 
#   filter(method %in% c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS") )
#   # mutate(Y_names= case_when(TargetTpue %in% "Kinome-wide Continues" ~ "COR"),TRUE~AUC)
# 
# acc_df1$method <-  factor(
#   acc_df1$method, 
#   levels= c("senbased_genesig_comb1", "Consensus_exp_perturb", "structure_ECFP", "structure_MACCS"), 
#   labels = c("Ess-sig", "ConExp-sig", "Fingerprint-ECFP","Fingerprint-MACCS" ))
# 
# acc_df1$TargetType <-  factor(
#   acc_df1$TargetType, 
#   levels= c("Primary", "Kinome-wide Binarized", "Kinome-wide Continues"),
#   labels = c("Primary (AUC)", "Kinome-wide Binarized (AUC)", "Kinome-wide Continues (COR)"))
```


```{r,fig.width=9,fig.height=6.5}
# acc_df1 %>% 
#   ggplot(aes(x=method, y=acc, color= method)) + 
#     geom_violin()+
#     stat_summary(fun.data = "mean_cl_boot", geom = "pointrange",
#              colour = "black",size=0.2)+
#     theme_classic()+
#     theme(axis.text.x = element_blank())+
#     xlab(label = "")+
#     ylab(label = "Accuracy")+
#     scale_color_npg()+
#     theme(legend.position="right")+  
#     facet_grid(cols = vars(Dataset), rows = vars(TargetType),scales = "free")+
#     guides(color= guide_legend(nrow = 4,title.position = "top"))+
#     labs(color = "Drug Representation")
```


imp dtc correlation
```{r}
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(ctrp_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
# 
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(ctrp_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   inner_join(res_ctrp2 %>% select(ces,broad_cpd_id, cpd_name,ces_variance)) %>% 
#   filter(ces_variance < 0.05) %>% 
#   filter(ces >0.3) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()


# feature_imp_ridge_gdsc_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(gdsc_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
# 
# feature_imp_ridge_ctrp_ces1 %>% 
#   pivot_longer(cols= -drug, names_to = "gene",values_to= "importance") %>% 
#   inner_join(gdsc_target_dtc ,by =c("drug"= "drug", "gene"="target")) %>% 
#   filter(importance >0) %>% 
#   # filter(binding_score >0) %>% 
#   ggplot(aes(x= importance,y= binding_score)) + 
#   geom_point(size= 0.01) +
#   theme_classic()
```



Abondoned analysis (this is unsupervised analysis, no need to include in this section)
Compare Ess-sig and ConExp-sig. They are very different.
Does Ess-sig correlate with ConExp-sig
Figure 3B
```{r}
# overlapping_gene_ctrp_sig <- intersect(
#   x = colnames(feature_imp_ridge_ctrp_comb1)[-1], 
#   y = colnames(drug_consensus_ctrp)[-1]
#   )
# 
# tmp <- inner_join(
#   feature_imp_ridge_ctrp_comb1 %>%
#     filter(drug %in% ctrp_drug_list) %>% 
#     select(one_of(c("drug", overlapping_gene_ctrp_sig))) %>% 
#     pivot_longer(cols = -drug, names_to= "gene", values_to= "Consen_sigvalue")
#   ,
#   drug_consensus_ctrp %>%
#     filter(drug %in% ctrp_drug_list) %>% 
#     select(one_of(c("drug", overlapping_gene_ctrp_sig))) %>% 
#     pivot_longer(cols = -drug, names_to= "gene", values_to= "Conexp_sigvalue")
#   )
#   
# cor_druglevel <- tmp %>% 
#   group_by(drug) %>% 
#   summarize(cor= cor(Consen_sigvalue, Conexp_sigvalue,method = "spearman"))
# 
# 
# hist(cor_druglevel$cor)
# 
# 
# 
# overlapping_gene_gdsc_sig <- intersect(
#   x = colnames(feature_imp_ridge_gdsc_comb1)[-1], 
#   y = colnames(drug_consensus_gdsc)[-1]
#   )
# 
# tmp <- inner_join(
#   feature_imp_ridge_gdsc_comb1 %>%
#     filter(drug %in% gdsc_drug_list) %>% 
#     select(one_of(c("drug", overlapping_gene_gdsc_sig))) %>% 
#     pivot_longer(cols = -drug, names_to= "gene", values_to= "Consen_sigvalue")
#   ,
#   drug_consensus_gdsc %>%
#     filter(drug %in% gdsc_drug_list) %>% 
#     select(one_of(c("drug", overlapping_gene_gdsc_sig))) %>% 
#     pivot_longer(cols = -drug, names_to= "gene", values_to= "Conexp_sigvalue")
#   )
#   
# cor_druglevel <- tmp %>% 
#   group_by(drug) %>% 
#   summarize(cor= cor(Consen_sigvalue, Conexp_sigvalue,method = "spearman"))
# 
# 
# hist(cor_druglevel$cor)
# 
# 
# 
# overlapping_gene_prism_sig <- intersect(
#   x = colnames(feature_imp_ridge_prism_comb1)[-1], 
#   y = colnames(drug_consensus_prism)[-1]
#   )
# 
# tmp <- inner_join(
#   feature_imp_ridge_prism_comb1 %>%
#     filter(drug %in% prism_drug_list) %>% 
#     select(one_of(c("drug", overlapping_gene_prism_sig))) %>% 
#     pivot_longer(cols = -drug, names_to= "gene", values_to= "Consen_sigvalue")
#   ,
#   drug_consensus_prism %>%
#     filter(drug %in% prism_drug_list) %>% 
#     select(one_of(c("drug", overlapping_gene_prism_sig))) %>% 
#     pivot_longer(cols = -drug, names_to= "gene", values_to= "Conexp_sigvalue")
#   )
#   
# cor_druglevel <- tmp %>% 
#   group_by(drug) %>% 
#   summarize(cor= cor(Consen_sigvalue, Conexp_sigvalue,method = "spearman"))
# 
# 
# hist(cor_druglevel$cor)
```


## 3 Get predictions for the drugs. 

lets still use the leave out method since I am going to 
investigate the selectivity of the predicted targets

training drugs: allvalid drugs with targets from binary table
test_drugs,  allvalid_drugs

assign the weight of the same drugs to zero in the correlation
matrix to avoid data leaking.

```{r}
ctrpess_drugbank_predictions <- get_predictions(
  sig_data=feature_imp_ridge_ctrp_comb1,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_binary$drug),
  pred_drugs=ctrp_allvalid_list, 
  train_label= ctrp_target_binary)

ctrpexp_drugbank_predictions <- get_predictions(
  sig_data=drug_consensus_ctrp,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_binary$drug),
  pred_drugs=drug_consensus_ctrp$drug, 
  train_label= ctrp_target_binary)

ctrpmaccs_drugbank_predictions <- get_predictions(
  sig_data=feature_maccs_ctrp,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_binary$drug),
  pred_drugs=feature_maccs_ctrp$drug, 
  train_label= ctrp_target_binary,
  similarity= "tahimoto")

ctrpextended_drugbank_predictions <- get_predictions(
  sig_data=feature_extended_ctrp,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_binary$drug),
  pred_drugs=feature_extended_ctrp$drug, 
  train_label= ctrp_target_binary,
  similarity= "tahimoto")

gdscess_drugbank_predictions <- get_predictions(
  sig_data=feature_imp_ridge_gdsc_comb1,
  train_drugs=intersect(gdsc_drug_list, gdsc_target_binary$drug),
  pred_drugs=gdsc_allvalid_list, 
  train_label= gdsc_target_binary)

gdscexp_drugbank_predictions <- get_predictions(
  sig_data=drug_consensus_gdsc,
  train_drugs=intersect(drug_consensus_gdsc$drug, gdsc_target_binary$drug),
  pred_drugs=drug_consensus_gdsc$drug,
  train_label= gdsc_target_binary)

gdscmaccs_drugbank_predictions <- get_predictions(
  sig_data=feature_maccs_gdsc,
  train_drugs=intersect(feature_maccs_gdsc$drug, gdsc_target_binary$drug),
  pred_drugs=feature_maccs_gdsc$drug,
  train_label= gdsc_target_binary,
  similarity= "tahimoto")

gdscextended_drugbank_predictions <- get_predictions(
  sig_data=feature_extended_gdsc,
  train_drugs=intersect(feature_extended_gdsc$drug, gdsc_target_binary$drug),
  pred_drugs=feature_extended_gdsc$drug,
  train_label= gdsc_target_binary,
  similarity= "tahimoto")

# DTC
ctrpess_dtc_predictions <- get_predictions(
  sig_data=feature_imp_ridge_ctrp_comb1,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_dtc$drug),
  pred_drugs=ctrp_allvalid_list, 
  train_label= ctrp_target_dtc)

ctrpexp_dtc_predictions <- get_predictions(
  sig_data=drug_consensus_ctrp,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_dtc$drug),
  pred_drugs=drug_consensus_ctrp$drug, 
  train_label= ctrp_target_dtc)

ctrpmaccs_dtc_predictions <- get_predictions(
  sig_data=feature_maccs_ctrp,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_dtc$drug),
  pred_drugs=feature_maccs_ctrp$drug, 
  train_label= ctrp_target_dtc,
  similarity= "tahimoto")

ctrpextended_dtc_predictions <- get_predictions(
  sig_data=feature_extended_ctrp,
  train_drugs=intersect(ctrp_drug_list, ctrp_target_dtc$drug),
  pred_drugs=feature_extended_ctrp$drug, 
  train_label= ctrp_target_dtc,
  similarity= "tahimoto")

gdscess_dtc_predictions <- get_predictions(
  sig_data=feature_imp_ridge_gdsc_comb1,
  train_drugs=intersect(gdsc_drug_list, gdsc_target_dtc$drug),
  pred_drugs=gdsc_allvalid_list, 
  train_label= gdsc_target_dtc)

gdscexp_dtc_predictions <- get_predictions(
  sig_data=drug_consensus_gdsc,
  train_drugs=intersect(drug_consensus_gdsc$drug, gdsc_target_dtc$drug),
  pred_drugs=drug_consensus_gdsc$drug,
  train_label= gdsc_target_dtc)

gdscmaccs_dtc_predictions <- get_predictions(
  sig_data=feature_maccs_gdsc,
  train_drugs=intersect(feature_maccs_gdsc$drug, gdsc_target_dtc$drug),
  pred_drugs=feature_maccs_gdsc$drug,
  train_label= gdsc_target_dtc,
  similarity= "tahimoto")

gdscextended_dtc_predictions <- get_predictions(
  sig_data=feature_extended_gdsc,
  train_drugs=intersect(feature_extended_gdsc$drug, gdsc_target_dtc$drug),
  pred_drugs=feature_extended_gdsc$drug,
  train_label= gdsc_target_dtc,
  similarity= "tahimoto")
```


lets find drugs whose target similiarity and sensitivity similiarity is high showed high similiarity in predicted target space by sensig not the other two types

now prepare sen matrix and target similiarity matrix 
```{r}
## Predicted target space similiarity
get_similarity_mat <- function(mat){
   cor((mat), method = "spearman")
}

ctrpess_drugbank_predictions_cormat <- get_similarity_mat(ctrpess_drugbank_predictions)
ctrpexp_drugbank_predictions_cormat <- get_similarity_mat(ctrpexp_drugbank_predictions)
ctrpmaccs_drugbank_predictions_cormat <- get_similarity_mat(ctrpmaccs_drugbank_predictions)
ctrpextended_drugbank_predictions_cormat <- get_similarity_mat(ctrpextended_drugbank_predictions)

gdscess_drugbank_predictions_cormat <- get_similarity_mat(gdscess_drugbank_predictions)
gdscexp_drugbank_predictions_cormat <- get_similarity_mat(gdscexp_drugbank_predictions)
gdscmaccs_drugbank_predictions_cormat <- get_similarity_mat(gdscmaccs_drugbank_predictions)
gdscextended_drugbank_predictions_cormat <- get_similarity_mat(gdscextended_drugbank_predictions)

ctrpess_dtc_predictions_cormat <- get_similarity_mat(ctrpess_dtc_predictions)
ctrpexp_dtc_predictions_cormat <- get_similarity_mat(ctrpexp_dtc_predictions)
ctrpmaccs_dtc_predictions_cormat <- get_similarity_mat(ctrpmaccs_dtc_predictions)
ctrpextended_dtc_predictions_cormat <- get_similarity_mat(ctrpextended_dtc_predictions)

gdscess_dtc_predictions_cormat <- get_similarity_mat(gdscess_dtc_predictions)
gdscexp_dtc_predictions_cormat <- get_similarity_mat(gdscexp_dtc_predictions)
gdscmaccs_dtc_predictions_cormat <- get_similarity_mat(gdscmaccs_dtc_predictions)
gdscextended_dtc_predictions_cormat <- get_similarity_mat(gdscextended_dtc_predictions)

## Sensitivity space similiarity
sen_ctrp_mat <- ctrp_data %>% 
  select(broad_cpd_id, sensitivity) %>% 
  unnest(sensitivity) %>% 
  select(-apparent_ec50_umol) %>% 
  filter(DepMap_ID %in% ces1$DepMap_ID) %>% 
  group_by(DepMap_ID, broad_cpd_id) %>% 
  summarize(area_under_curve= median(area_under_curve,na.rm = T)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = DepMap_ID, names_from=broad_cpd_id , values_from=area_under_curve) 

sen_ctrp_cor_mat <- cor(x = as.matrix(sen_ctrp_mat %>% select(-DepMap_ID)),
                          use = "pairwise.complete.obs" ,
                          method= "spearman")

sen_gdsc_mat <- gdsc_data %>%
  select(DRUG_ID, sensitivity) %>%
  unnest(sensitivity) %>%
  select(-LN_IC50) %>%
  group_by(DepMap_ID, DRUG_ID) %>%
  summarize(AUC= median(AUC,na.rm = T)) %>%
  ungroup() %>%
  pivot_wider(id_cols = DepMap_ID, names_from=DRUG_ID , values_from=AUC)


sen_gdsc_cor_mat <-   cor(x = as.matrix(sen_gdsc_mat %>% select(-DepMap_ID)),
                          use = "pairwise.complete.obs" ,
                          method= "spearman")

## putative target space similarity
get_similarity_mat_tahimoto <- function(predictors_mat){

  predictors_mat[predictors_mat<0.4] <- 0
  predictors_mat[predictors_mat>=0.4] <- 1  
  cor_mat = 1- as.matrix(vegan::vegdist(x = (predictors_mat),method = "jaccard",upper = F))
  cor_mat[is.nan(cor_mat)] <- 0
  return(cor_mat)
}


tar_ctrp_cor_mat_drugbank <- get_similarity_mat_tahimoto(get_target_mat(ctrp_target_binary))

tar_ctrp_cor_mat_dtc <- get_similarity_mat_tahimoto(get_target_mat(ctrp_target_dtc %>% filter(binding_score>0.4) %>% select(-binding_score)))

tar_gdsc_cor_mat_drugbank <- get_similarity_mat_tahimoto(get_target_mat(gdsc_target_binary))

tar_gdsc_cor_mat_dtc <- get_similarity_mat_tahimoto(get_target_mat(gdsc_target_dtc %>% filter(binding_score>0.4) %>% select(-binding_score)))


# combining target space with sensitivity space and then use them for similarity calculation
get_goldstandardcormat <- function(sen_df, target_df){
  target_widedf <- get_target_mat(target_df,return_format= "widedf")
  sen_df <- sen_df %>% pivot_longer(-DepMap_ID, names_to= "drug", values_to= "sen") %>% 
    pivot_wider(id_cols = drug, names_from=DepMap_ID, values_from= sen) 
  combined_df <- inner_join(sen_df, target_widedf, by ="drug") %>% arrange(drug)
  cormat <- cor( t(as.matrix(combined_df %>% select(-drug))),use = "complete.obs" ,method = "spearman")
  row.names(cormat) <- colnames(cormat) <- combined_df$drug
  return(cormat)
}

sentar_ctrp_cor_mat_drugbank <- get_goldstandardcormat(sen_df=sen_ctrp_mat, target_df=ctrp_target_binary)  

sentar_ctrp_cor_mat_dtc <- get_goldstandardcormat(sen_df=sen_ctrp_mat, target_df=ctrp_target_dtc) 

sentar_gdsc_cor_mat_drugbank <- get_goldstandardcormat(sen_df=sen_gdsc_mat, target_df=gdsc_target_binary %>% mutate(drug= as.character(drug))) 

sentar_gdsc_cor_mat_dtc <- get_goldstandardcormat(sen_df=sen_gdsc_mat, target_df=gdsc_target_dtc%>% mutate(drug= as.character(drug))) 
```

```{r}
# Row: drugpair name, column: sensitivity similiarity rank percentage, predicted target space rank percentage
# transform the cor matrix to rank matrix, as.dataframe and pivot_longer, filter the same drug
# then join together
# min_max_normalization <- function(x){(x-min(x))/ (max(x)-min(x)) }
# cor_mat_to_drugpair_longtibble1 <- function(mat, metric= "similiarity" ){
#   # if (metric == "similiarity"){print("Similarity returned") } 
#   if (metric == "rank_percentage"){print("Rank percentage returned")
#     diag(mat) <- 0
#     mat = apply(mat, 2, FUN = function(x){round((rank(x,ties.method = "max"))/length(x),digits = 3)})
#     
#     }
#   # let avoid using rank function but normalized similarity  
#     # mat = apply(mat, 2, FUN = min_max_normalization)
#     mat = round(mat, digits = 2)
#   mat[upper.tri(mat,diag = T)] <- -1000
#   mat %>% 
#     as.data.frame() %>% 
#     rownames_to_column(var = "drug1") %>% 
#     pivot_longer(cols = -drug1, names_to="drug2", values_to= "value") %>% 
#     filter(value != -1000)
# }

cor_mat_to_drugpair_longtibble <- function(mat, metric= "similiarity" ){
  # if (metric == "rank_percentage_all"){
  #   print("Rank percentage all returned")
  #   mat = apply(mat, 2, FUN = function(x){
  #     round((rank(x,ties.method = "max"))/length(x),digits = 3)})
  #   }
  if (metric == "similiarity"){
    print("Similarity returned") 
  }
  

  if (metric == "rank_percentage_pairwise"){
    print("Rank percentage pairwise returned")
    diag(mat) <- -1000
    mat = apply(
      mat, 
      2, 
      FUN = function(x){rank(x,ties.method = "max")/length(x)}
            # FUN = function(x){rank(-x,ties.method = "max")}
      )
    mat = (mat + t(mat))/2
    # mat = round(mat,digits = 3)
  }
  
  mat[upper.tri(mat,diag = T)] <- -1000
  mat %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "drug1") %>% 
    pivot_longer(cols = -drug1, names_to="drug2", values_to= "value") %>% 
    filter(value != -1000) %>% 
    drop_na() 
    # mutate(value = min_max_normalization(value))
}


pairlevel_comparison_ctrp_drugbank <-
 cor_mat_to_drugpair_longtibble(tar_ctrp_cor_mat_drugbank,metric="similiarity")%>%
  rename(tar =value) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(sen_ctrp_cor_mat,metric= "similiarity") %>%
      rename(sen =value),
    by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpess_drugbank_predictions_cormat,metric= "similiarity") %>%
      rename(ess =value),
    by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpexp_drugbank_predictions_cormat,metric= "similiarity") %>% rename(exp= value),
    by= c("drug1", "drug2")
    ) %>%   
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpextended_drugbank_predictions_cormat,metric= "similiarity") %>%
      rename(extended= value),
        by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpmaccs_drugbank_predictions_cormat,metric= "similiarity") %>%
      rename(maccs= value),
        by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(sentar_ctrp_cor_mat_drugbank,metric= "similiarity") %>%
      rename(sentar= value),
        by= c("drug1", "drug2")
    ) 
  # inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug1"= "broad_cpd_id")) %>% 
  # inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug2"= "broad_cpd_id")) %>%  
  # filter(target_or_activity_of_compound.x == target_or_activity_of_compound.y )



  
# tmp <- pairlevel_comparison_ctrp_drugbank %>% 
#   select(tar:sentar) %>% 
#   cor(method= "spearman") %>% 
#   round(digits = 2)
# 
# pairlevel_comparison_ctrp_drugbank1 <-  pairlevel_comparison_ctrp_drugbank %>% 
#   select(tar:sentar) %>% 
#   as.matrix() %>% 
#   preprocessCore::normalize.quantiles()
# 
# pairlevel_comparison_ctrp_drugbank1 <- as.data.frame(pairlevel_comparison_ctrp_drugbank1) %>% 
#   as_tibble() 
# colnames(pairlevel_comparison_ctrp_drugbank1) <- colnames(pairlevel_comparison_ctrp_drugbank)[3:9]
# 
# pairlevel_comparison_ctrp_drugbank2 <- pairlevel_comparison_ctrp_drugbank %>%
#   select_at(1:2) %>% 
#   bind_cols(pairlevel_comparison_ctrp_drugbank1)
# 
# summary(pairlevel_comparison_ctrp_drugbank)
# summary(pairlevel_comparison_ctrp_drugbank2)

pairlevel_comparison_ctrp_drugbank3 <-
 cor_mat_to_drugpair_longtibble(tar_ctrp_cor_mat_drugbank,metric="rank_percentage_pairwise")%>%
  rename(tar =value) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(sen_ctrp_cor_mat,metric="rank_percentage_pairwise") %>%
      rename(sen =value),
    by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpess_drugbank_predictions_cormat,metric="rank_percentage_pairwise") %>%
      rename(ess =value),
    by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpexp_drugbank_predictions_cormat,metric="rank_percentage_pairwise") %>% rename(exp= value),
    by= c("drug1", "drug2")
    ) %>%   
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpextended_drugbank_predictions_cormat,metric="rank_percentage_pairwise") %>%
      rename(extended= value),
        by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(ctrpmaccs_drugbank_predictions_cormat,metric="rank_percentage_pairwise") %>%
      rename(maccs= value),
        by= c("drug1", "drug2")
    ) %>% 
  inner_join(
    cor_mat_to_drugpair_longtibble(sentar_ctrp_cor_mat_drugbank,metric="rank_percentage_pairwise") %>%
      rename(sentar= value),
        by= c("drug1", "drug2")
    ) 
  

# summary(pairlevel_comparison_ctrp_drugbank3)
```


```{r}
# pairlevel_comparison_gdsc_drugbank <- cor_mat_to_drugpair_longtibble(tar_gdsc_cor_mat_drugbank,metric="similiarity") %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(sen_gdsc_cor_mat,metric= "similiarity") %>%
#       rename(sen =value),
#     by= c("drug1", "drug2")
#     ) %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscess_drugbank_predictions_cormat,metric= "similiarity") %>%
#       rename(ess =value),
#     by= c("drug1", "drug2")
#     ) %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscexp_drugbank_predictions_cormat,metric= "similiarity") %>% rename(exp= value),
#     by= c("drug1", "drug2")
#     ) %>%   
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscextended_drugbank_predictions_cormat,metric= "similiarity") %>%
#       rename(extended= value),
#         by= c("drug1", "drug2")
#     ) %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscmaccs_drugbank_predictions_cormat,metric= "similiarity") %>%
#       rename(maccs= value),
#         by= c("drug1", "drug2")
#     ) %>% 
#   mutate_at(c("drug1","drug2"), as.integer) %>% 
#     inner_join(gdsc_data %>% select(DRUG_ID, PATHWAY_NAME, DRUG_NAME), by= c("drug1"= "DRUG_ID")) %>% 
#   inner_join(gdsc_data %>% select(DRUG_ID, PATHWAY_NAME, DRUG_NAME), by= c("drug2"= "DRUG_ID")) %>% 
#   mutate_at(c("drug1","drug2"), as.character) %>% 
#   filter(PATHWAY_NAME.x == PATHWAY_NAME.y) %>% 
#   filter(value>0.95) %>%
#   filter(sen>0.95)
# 
# pairlevel_comparison_gdsc_dtc  <- cor_mat_to_drugpair_longtibble(tar_gdsc_cor_mat_dtc,metric="similiarity") %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(sen_gdsc_cor_mat,metric= "similiarity") %>%
#       rename(sen =value),
#     by= c("drug1", "drug2")
#     ) %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscess_dtc_predictions_cormat,metric= "similiarity") %>%
#       rename(ess =value),
#     by= c("drug1", "drug2")
#     ) %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscexp_dtc_predictions_cormat,metric= "similiarity") %>% rename(exp= value),
#     by= c("drug1", "drug2")
#     ) %>%   
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscextended_dtc_predictions_cormat,metric= "similiarity") %>%
#       rename(extended= value),
#         by= c("drug1", "drug2")
#     ) %>% 
#   inner_join(
#     cor_mat_to_drugpair_longtibble(gdscmaccs_dtc_predictions_cormat,metric= "similiarity") %>%
#       rename(maccs= value),
#         by= c("drug1", "drug2")
#     ) %>% 
#   mutate_at(c("drug1","drug2"), as.integer) %>% 
#   inner_join(gdsc_data %>% select(DRUG_ID, PATHWAY_NAME, DRUG_NAME), by= c("drug1"= "DRUG_ID")) %>% 
#   inner_join(gdsc_data %>% select(DRUG_ID, PATHWAY_NAME, DRUG_NAME), by= c("drug2"= "DRUG_ID")) %>% 
#     mutate_at(c("drug1","drug2"), as.character) %>% 
#   filter(PATHWAY_NAME.x == PATHWAY_NAME.y ) %>% 
#   filter(value>0.95) %>% 
#   filter(sen>0.95)
```


```{r}
# check how often drugpair is prioritized?
pairlevel_comparison_ctrp_drugbank %>% summary()
pairlevel_comparison_ctrp_dtc %>% summary()
pairlevel_comparison_gdsc_drugbank %>% summary()
pairlevel_comparison_gdsc_dtc %>% summary()

apply(pairlevel_comparison_ctrp_drugbank %>% select_at(5:8), MARGIN = 2, function(x){sum(x>0.95)})
tmp <- pairlevel_comparison_ctrp_drugbank %>% 
  pivot_longer(cols= 5:8, names_to = "type", values_to= "rank_percentage") 
  
# kruskal.test(type~rank_percentage,data= tmp)
# kruskal.test(type~rank_percentage,data= tmp)
# pairwise.wilcox.test(tmp$rank_percentage, tmp$type,
#                  p.adjust.method = "BH")  
```


```{r,fig.width=12,fig.height=12}
# get similarity matrix from pred_mat
# Then check agreement between ctrp and gdsc
# for 49 shared drugs whether targets predicted from different 
# dataset agrees with each other

# shared_drugs_confirm <- shared_drugs %>%
#   filter(BROAD_ID %in% colnames(ctrpess_dtc_predictions)) %>%
#   filter(DRUG_ID %in% colnames(gdscess_dtc_predictions))
# 
# shared_candidate_gene <- sort(intersect(
#   row.names(ctrpess_dtc_predictions),
#   row.names(gdscess_dtc_predictions)))
# union_candidate_gene <- sort(union(
#   row.names(ctrpess_dtc_predictions),
#   row.names(gdscess_dtc_predictions)))
# 
# tmp1 <- (ctrpess_dtc_predictions)[
#   match(shared_candidate_gene,row.names(ctrpess_dtc_predictions))
#   ,
#   match(shared_drugs_confirm$BROAD_ID,colnames(ctrpess_dtc_predictions))
#   ]
# 
# tmp2 <- (gdscess_dtc_predictions)[
#   match(shared_candidate_gene,row.names(gdscess_dtc_predictions))
#   ,
#   match(shared_drugs_confirm$DRUG_ID,colnames(gdscess_dtc_predictions))
#   ]
# 
# tmp3 <- cor(tmp1, tmp2,method = "spearman")
# # row.names(tmp3) <- colnames(tmp1)
# identical(row.names(tmp3), shared_drugs_confirm$BROAD_ID)
# identical(colnames(tmp3), as.character(shared_drugs_confirm$DRUG_ID))
# colnames(tmp3) <- row.names(tmp3)
# 
# t.test(x = diag(tmp3), y = upper.tri(tmp3))
# 
# tmp4 <- as.data.frame(tmp3) %>%
#   as_tibble() %>%
#   mutate(drug1 = row.names(tmp3)) %>%
#   pivot_longer(cols = -drug1,names_to= "drug2", values_to= "cor_coef")
# 
# ggplot(tmp4, aes(drug1, drug2, fill=cor_coef))+
#   geom_tile(color = "white")+
#  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
#    midpoint = 0, limit = c(-1,1), space = "Lab",
#    name="Spearman\nCorrelation") +
#   theme_minimal()+
#  theme(axis.text.x = element_text(angle = 45, vjust = 1,
#     size = 12, hjust = 1))
# coord_fixed()
```


```{r,fig.height=8, fig.width=5}
# bind_rows(
#   pairlevel_comparison_ctrp_drugbank %>% mutate(target_resources= "Drugbank"), 
#   pairlevel_comparison_ctrp_dtc %>% mutate(target_resources= "DTC")  
#   ) %>% 
#   # ungroup() %>% 
#   # arrange(desc(ess)) %>% 
#   # mutate(ess_f = factor(ess)) %>% 
#   mutate(drug_pair_name= str_c(cpd_name.x, cpd_name.y,sep = "  ")) %>% 
#   select(drug_pair_name, ess:maccs, target_or_activity_of_compound.x, target_resources) %>% 
#   pivot_longer(ess:maccs, names_to="method", values_to= "value",names_repair = "unique") %>% 
#   ggplot(aes(x= method, y= value  )) +
#  geom_boxplot(outlier.shape = NA)+
#   geom_point(aes(color= target_or_activity_of_compound.x)) +
#   geom_line(aes(group=drug_pair_name,color= target_or_activity_of_compound.x)) +
#   facet_grid(rows = vars(target_resources))+
#   theme_classic()+
#   theme(legend.position="top")+
#   guides(color= guide_legend(nrow = 20,title.position = "top"))+
#   xlab("Prediction method")+
#   ylab("Simialirity ranking in the predicted target space" )+
#   labs(color = "Drug mechanism category")
#     # scale_color_npg()
```

```{r, fig.width=3.5,fig.height=5}
# tmp1 <- pairlevel_comparison_ctrp_drugbank2 %>%
#   inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug1"= "broad_cpd_id")) %>%
#   inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug2"= "broad_cpd_id")) %>%
#   # filter(sen >quantile(pairlevel_comparison_ctrp_drugbank2$sen,0.99)) %>%
#   # filter(tar >quantile(pairlevel_comparison_ctrp_drugbank2$tar,0.95)) %>%
#   filter(sentar >quantile(pairlevel_comparison_ctrp_drugbank2$sentar,0.99)) %>%
#   filter(target_or_activity_of_compound.x == target_or_activity_of_compound.y )
# summary(tmp)

tmp <- pairlevel_comparison_ctrp_drugbank3 %>%
  inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug1"= "broad_cpd_id")) %>%
  inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug2"= "broad_cpd_id")) %>%
  filter(sen >0.99) %>%
  filter(tar ==1) %>%
  filter(target_or_activity_of_compound.x == target_or_activity_of_compound.y ) %>% arrange(drug1,drug2)

# tmp1 <- pairlevel_comparison_ctrp_drugbank2 %>%
#   inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug1"= "broad_cpd_id")) %>%
#   inner_join(ctrp_data %>% select(broad_cpd_id, target_or_activity_of_compound, cpd_name), by= c("drug2"= "broad_cpd_id")) %>%
#   inner_join(tmp %>% select(drug1, drug2))%>% arrange(drug1,drug2)


figdata <- tmp %>% 
 # pairlevel_comparison_ctrp_drugbank2 %>%
  mutate(drug_pair_name= str_c(cpd_name.x, cpd_name.y,sep = "  ")) %>% 
  mutate(drug_pair_name = as.factor(drug_pair_name) ) %>%
  mutate(drug_pair_name = fct_reorder(drug_pair_name,ess))%>% 
  select(drug_pair_name, ess:maccs, target_or_activity_of_compound.x) %>% 
  pivot_longer(ess:maccs, names_to="method", values_to= "value",names_repair = "unique") 

pmain <- figdata %>% 
  ggplot(mapping = aes(x=  drug_pair_name,y = value, color= method) ) +
  geom_point()+
  geom_line(aes(group= method))+
  theme_classic()+
  theme(legend.position="bottom")+
  guides(color= guide_legend(nrow = 2,title.position = "top"))+
  xlab("Drug pair names")+
  ylab("Normalized Simialirity" )+
  labs(color = "Prediction Method")+
  coord_flip()+
  scale_color_npg()+
  scale_y_continuous(position = "right")+
  scale_x_discrete(position = "top")+
  theme(legend.position="none")
pmain
xbox <- figdata %>% 
  ggplot(
    mapping = aes(
      x= fct_reorder(method,value, median,.desc=T), 
      y = value, fill = method ) 
         ) +
  geom_boxplot(outlier.shape = NA)+
  theme_classic()+
  coord_flip()+
  scale_fill_npg()+
  theme(legend.position="none")

ybar <- figdata %>% 
  ggplot(aes(x= drug_pair_name, fill= target_or_activity_of_compound.x), 
      y =1 ) +
  geom_bar()+
  theme_classic()+
  coord_flip()+
  theme(legend.position="top")+
  guides(fill= guide_legend(nrow = 11,title.position = "top"))

p1 <- cowplot::insert_xaxis_grob(pmain, xbox,  position = "bottom")
p2 <- cowplot::insert_yaxis_grob(p1, ybar, grid::unit(0.1, "null"), position = "right")
ggdraw(p2)

```

```{r, fig.width=3,fig.height=7}
ybar+labs(fill = "Drug mechanism category")
```


```{r, fig.width=3.7,fig.height=7}
figdata <- pairlevel_comparison_ctrp_dtc %>%
  mutate(drug_pair_name= str_c(cpd_name.x, cpd_name.y,sep = "  ")) %>% 
  mutate(drug_pair_name = as.factor(drug_pair_name) ) %>%
  mutate(drug_pair_name = fct_reorder(drug_pair_name,ess))%>% 
  select(drug_pair_name, ess:maccs, target_or_activity_of_compound.x) %>% 
  pivot_longer(ess:maccs, names_to="method", values_to= "value",names_repair = "unique") 

pmain <- figdata %>% 
  ggplot(mapping = aes(x=  drug_pair_name,y = value, color= method) ) +
  geom_point()+
  geom_line(aes(group= method))+
  theme_classic()+
  theme(legend.position="bottom")+
  guides(color= guide_legend(nrow = 2,title.position = "top"))+
  xlab("Drug pair names")+
  ylab("Simialirity ranking" )+
  labs(color = "Prediction Method")+
  coord_flip()+
  scale_color_npg()+
  scale_y_continuous(position = "right")+
  scale_x_discrete(position = "top")+
  theme(legend.position="none")

xbox <- figdata %>% 
  ggplot(
    mapping = aes(
      x= fct_reorder(method,value, median,.desc=T), 
      y = value, fill = method ) 
         ) +
  geom_boxplot(outlier.shape = NA)+
  theme_classic()+
  coord_flip()+
  scale_fill_npg()+
  theme(legend.position="none")

ybar <- figdata %>% 
  ggplot(aes(x= drug_pair_name, fill= target_or_activity_of_compound.x), 
      y =1 ) +
  geom_bar()+
  theme_classic()+
  coord_flip()+
  theme(legend.position="top")+
  guides(fill= guide_legend(nrow = 20,title.position = "top"))
p1 <- cowplot::insert_xaxis_grob(pmain, xbox,  position = "bottom")
p2 <- cowplot::insert_yaxis_grob(p1, ybar, grid::unit(0.1, "null"), position = "right")
ggdraw(p2)
```
```{r, fig.width=3,fig.height=7}
ybar+labs(fill = "Drug mechanism category")
```

```{r,fig.height=7, fig.width=3.5}
# bind_rows(
#   pairlevel_comparison_gdsc_drugbank %>% mutate(target_resources= "Drugbank"), 
#   pairlevel_comparison_gdsc_dtc %>% mutate(target_resources= "DTC")  
#   ) %>% 
#   # filter(value> 0.95) %>%
#   filter(value==1) %>%
#   filter(sen>0.95) %>% 
#   # arrange(desc(ess)) %>% 
#   # mutate(ess_f = factor(ess)) %>% 
#   mutate(drug_pair_name= str_c(DRUG_NAME.x, DRUG_NAME.y,sep = "  ")) %>% 
#   select(drug_pair_name, ess:maccs, PATHWAY_NAME.x, target_resources) %>% 
#   pivot_longer(ess:maccs, names_to="method", values_to= "value",names_repair = "unique") %>% 
#   ggplot(aes(x= method, y= value,   )) +
#   geom_boxplot(outlier.shape = NA)+
#   geom_point(aes(color= PATHWAY_NAME.x)) +
#   geom_line(aes(group=drug_pair_name,color= PATHWAY_NAME.x)) +
#   facet_grid(rows = vars(target_resources))+
#   theme_classic()+
#   theme(legend.position="top")+
#   guides(color= guide_legend(nrow = 11,title.position = "top"))+
#   xlab("Prediction method")+
#   ylab("Simialirity ranking in the predicted target space" )+
#   labs(color = "Drug mechanism category")
```


```{r, fig.width=3.7,fig.height=7}
figdata <- 
 pairlevel_comparison_gdsc_drugbank %>%
  mutate(drug_pair_name= str_c(DRUG_NAME.x, DRUG_NAME.y,sep = "  ")) %>% 
  mutate(drug_pair_name = as.factor(drug_pair_name) ) %>%
  mutate(drug_pair_name = fct_reorder(drug_pair_name,ess))%>% 
  select(drug_pair_name, ess:maccs, PATHWAY_NAME.x) %>% 
  pivot_longer(ess:maccs, names_to="method", values_to= "value",names_repair = "unique") 

pmain <- figdata %>% 
  ggplot(mapping = aes(x=  drug_pair_name,y = value, color= method) ) +
  geom_point()+
  geom_line(aes(group= method))+
  theme_classic()+
  theme(legend.position="bottom")+
  guides(color= guide_legend(nrow = 2,title.position = "top"))+
  xlab("Drug pair names")+
  ylab("Simialirity ranking" )+
  labs(color = "Prediction Method")+
  coord_flip()+
  scale_color_npg()+
  scale_y_continuous(position = "right")+
  scale_x_discrete(position = "top")+
  theme(legend.position="none")

xbox <- figdata %>% 
  ggplot(
    mapping = aes(
      x= fct_reorder(method,value, median,.desc=T), 
      y = value, fill = method ) 
         ) +
  geom_boxplot(outlier.shape = NA)+
  theme_classic()+
  coord_flip()+
  scale_fill_npg()+
  theme(legend.position="none")

ybar <- figdata %>% 
  ggplot(aes(x= drug_pair_name, fill= PATHWAY_NAME.x), 
      y =1 ) +
  geom_bar()+
  theme_classic()+
  coord_flip()+
  theme(legend.position="top")+
  guides(fill= guide_legend(nrow = 11,title.position = "top"))

p1 <- cowplot::insert_xaxis_grob(pmain, xbox,  position = "bottom")
p2 <- cowplot::insert_yaxis_grob(p1, ybar, grid::unit(0.1, "null"), position = "right")
ggdraw(p2)
```

```{r, fig.width=3.7,fig.height=7}
figdata <- 
 pairlevel_comparison_gdsc_dtc %>%
  mutate(drug_pair_name= str_c(DRUG_NAME.x, DRUG_NAME.y,sep = "  ")) %>% 
  mutate(drug_pair_name = as.factor(drug_pair_name) ) %>%
  mutate(drug_pair_name = fct_reorder(drug_pair_name,ess))%>% 
  select(drug_pair_name, ess:maccs, PATHWAY_NAME.x) %>% 
  pivot_longer(ess:maccs, names_to="method", values_to= "value",names_repair = "unique") 

pmain <- figdata %>% 
  ggplot(mapping = aes(x=  drug_pair_name,y = value, color= method) ) +
  geom_point()+
  geom_line(aes(group= method))+
  theme_classic()+
  theme(legend.position="bottom")+
  guides(color= guide_legend(nrow = 2,title.position = "top"))+
  xlab("Drug pair names")+
  ylab("Simialirity ranking" )+
  labs(color = "Prediction Method")+
  coord_flip()+
  scale_color_npg()+
  scale_y_continuous(position = "right")+
  scale_x_discrete(position = "top")+
  theme(legend.position="none")

xbox <- figdata %>% 
  ggplot(
    mapping = aes(
      x= fct_reorder(method,value, median,.desc=T), 
      y = value, fill = method ) 
         ) +
  geom_boxplot(outlier.shape = NA)+
  theme_classic()+
  coord_flip()+
  scale_fill_npg()+
  theme(legend.position="none")

ybar <- figdata %>% 
  ggplot(aes(x= drug_pair_name, fill= PATHWAY_NAME.x), 
      y =1 ) +
  geom_bar()+
  theme_classic()+
  coord_flip()+
  theme(legend.position="top")+
  guides(fill= guide_legend(nrow = 11,title.position = "top"))

p1 <- cowplot::insert_xaxis_grob(pmain, xbox,  position = "bottom")
p2 <- cowplot::insert_yaxis_grob(p1, ybar, grid::unit(0.1, "null"), position = "right")
ggdraw(p2)
```


Abondoned explorative analysis
```{r, eval= FALSE}
# load("~/cluster_scratch/forward_modelling/targetpred_serverinput.RData")

# map(.x = 1:5, .f = ~cor(feature_imp_ridge_ctrp_ces1[.x,-1], feature_imp_ridge_ctrp_ceres[.x,-1],method = "spearman")) %>%
#   unlist() %>%
#   hist()
# 
# map(.x = 1:545, .f = ~cor(feature_imp_ridge_ctrp_ces1[.x,-1], feature_imp_ridge_ctrp_demeter2[.x,],method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
# 
# map(.x = 1:545, .f = ~cor(feature_imp_ridge_ctrp_ces1[.x,], feature_imp_ridge_ctrp_exp[.x,],method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
# 
# map(.x = 1:545, .f = ~cor(feature_imp_ridge_ctrp_ceres[.x,], feature_imp_ridge_ctrp_demeter2[.x,],method = "spearman")) %>% 
#   unlist() %>% 
#   hist()

# tmp <- bind_rows(feature_imp_ridge_ctrp_ces1[1,],feature_imp_ridge_ctrp_ceres[1,]) %>% 
#   select(-drug) %>% 
#   t() %>% 
#   as_tibble() 
# tmp %>% 
#   ggplot(aes(x=V1, y= V2))+
#   geom_point()
# 
# cor(tmp$V1, tmp$V2)
# 
# 
# tmp <- bind_rows(feature_imp_ridge_ctrp_ces1[1,],feature_imp_ridge_ctrp_demeter2[1,]) %>% 
#   select(-drug) %>% 
#   t() %>% 
#   as_tibble() 
# tmp %>% 
#   ggplot(aes(x=V1, y= V2))+
#   geom_point()
# 
# cor(tmp$V1, tmp$V2)
# 
# 
# tmp <- bind_rows(feature_imp_ridge_ctrp_ces1[1,],feature_imp_ridge_ctrp_exp[1,]) %>% 
#   select(-drug) %>% 
#   t() %>% 
#   as_tibble() 
# tmp %>% 
#   ggplot(aes(x=V1, y= V2))+
#   geom_point()
# 
# cor(tmp$V1, tmp$V2)


# We want to check how original ces and ces based feature importance is correlating with the other basal cell line feature.

# load("~/cluster_scratch/forward_modelling/ctrp_input.RData")
# 
# tmp <- unlist(ces1[1,-1])
# map(.x = 1:437, .f = ~cor(unlist(ces1[.x,-1]), unlist(ceres[.x,-1]),method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
# 
# map(.x = 1:437, .f = ~cor(unlist(ces1[.x,-1]), unlist(demeter2[.x,-1]),method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
# 
# 
# 
# map(.x = 1:437, .f = ~cor(unlist(ceres[.x,-1]), unlist(demeter2[.x,-1]),method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
# 
# 
# 
# map(.x = 1:437, .f = ~cor(unlist(ces1[.x,-1]), unlist(exp_seq[.x,-1]),method = "spearman")) %>%
#   unlist() %>%
#   hist()

# ces_columnscaled <- ces %>% 
#   mutate_at(2:10624, scale)
# 
# ceres_columnscaled <- ceres %>% 
#   mutate_at(2:10624, scale)


# ces1_columnscaled <- ces1 %>% 
#   pivot_longer(cols= -DepMap_ID, names_to = "gene", values_to= "ess") %>% 
#   pivot_wider(id_cols = gene, names_from= DepMap_ID, values_from= ess) %>% 
#   mutate_at(2:438, .funs = scale) %>% 
#   pivot_longer(cols= -gene, names_to = "DepMap_ID", values_to= "ess") %>% 
#   pivot_wider(id_cols = DepMap_ID, names_from= gene, values_from= ess) 
# 
# ceres_columnscaled <- ceres %>% 
#   pivot_longer(cols= -DepMap_ID, names_to = "gene", values_to= "ess") %>% 
#   pivot_wider(id_cols = gene, names_from= DepMap_ID, values_from= ess) %>% 
#   mutate_at(2:438, .funs = scale) %>% 
#   pivot_longer(cols= -gene, names_to = "DepMap_ID", values_to= "ess") %>% 
#   pivot_wider(id_cols = DepMap_ID, names_from= gene, values_from= ess) 
# 
# 
# map(.x = 2:10624, .f = ~cor(unlist(ces1[,.x]), unlist(ceres[,.x]),method = "spearman")) %>%
#   unlist() %>% 
#   hist()
# 
# map(.x = 2:10624, 
#     .f = 
#       ~cor(unlist(ces1_columnscaled[,.x]),unlist(ceres_columnscaled[,.x]),method = "spearman")) %>% 
#   unlist() %>% 
#   hist()

# map(.x = 2:10624, .f = ~cor(unlist(ces1[,.x]), unlist(demeter2[,.x]),method = "spearman")) %>%
#   unlist() %>% 
#   hist()
# 
# 
# map(.x = 2:10624, .f = ~cor(unlist(demeter2[,.x]), unlist(ceres[,.x]),method = "spearman")) %>% 
#   unlist() %>% 
#   hist()
```
