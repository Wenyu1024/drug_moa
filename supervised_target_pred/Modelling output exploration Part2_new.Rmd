---
title: "Modelling output exploration Part2 drug target prediction"
author: "Wenyu"
date: "1/15/2021"
output: html_document
---

The aim of this nootbook is to explore whether the extracted model importances from the sen~ess glmnet model can be used in 

1 Supervised drug target prediction
2 Unsupervised drug target identification



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
```

# 1 Target prediction with the help of existing target

## 1) Extract and reformat the feature importance from the glmnet model
```{r, eval= F}
#confirm whether the gene is matched
ces1 <- read_csv("~/cluster_scratch/impute_ess_20q4/ces1_478.csv")
load("~/cluster_scratch/glmnet_modelling_cluster/ridge_feature_multinode2.RData")

# extract the vector from the list from the list column and combine with 
# gene names and drug broad id into a square matrix. then perhaps transform to 
# long table for further exploration. 

gene <- sort(colnames(ces1)[2:10569])

# tmp <- tibble(gene)
# tmp <- map(res_feature$ces1_perf,function(x){bind_cols(tmp, tibble(x))} )
tmp <- matrix(nrow = 365,ncol = 10568)
colnames(tmp) <- gene
for (i in 1:365){
    tmp[i,] <- res_feature$ces1_perf[[i]]
}
feature_imp <- bind_cols(res_feature %>% select(broad_cpd_id), data.frame(tmp) %>% as_tibble()) 
write_csv(feature_imp,"~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ces1.csv")

for (i in 1:365){
    tmp[i,] <- res_feature$ces2_perf[[i]]
}
feature_imp <- bind_cols(res_feature %>% select(broad_cpd_id), data.frame(tmp) %>% as_tibble()) 
  
write_csv(feature_imp,"~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ces2.csv")

for (i in 1:365){
    tmp[i,] <- res_feature$ceres_perf[[i]]
}
feature_imp <- bind_cols(res_feature %>% select(broad_cpd_id), data.frame(tmp) %>% as_tibble()) 

write_csv(feature_imp,"~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ceres.csv")

for (i in 1:365){
    tmp[i,] <- res_feature$demeter2_perf[[i]]
}
feature_imp <- bind_cols(res_feature %>% select(broad_cpd_id), data.frame(tmp) %>% as_tibble()) 

write_csv(feature_imp,"~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_demeter2.csv")




load("~/cluster_scratch/impute_and_derive_exp_based_feature_importance/res_feature_imp_expseq2.RData")
exp_seq_pca <- read_csv("~/cluster_scratch/impute_and_derive_exp_based_feature_importance/exp_seq_pca.csv")

gene <- sort(colnames(exp_seq_pca)[2:1204])
tmp <- matrix(nrow = 365,ncol = 1203)
colnames(tmp) <- gene

for (i in 1:365){
    tmp[i,] <- res_feature$exp_perf[[i]]
}
feature_imp <- bind_cols(res_feature %>% select(broad_cpd_id), data.frame(tmp) %>% as_tibble())

write_csv(feature_imp,"~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_seq_pca.csv")
rm(list = ls())


```

## 2) Read in the data you write out by the previous chunk

read in all the needed csv file for drug target prediction using various predictors and then save an RData file as input for modelscript
```{r,warning = FALSE, message=FALSE}
feature_imp_ridge_ctrp_ces1 <- read_csv("~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ces1.csv")

feature_imp_ridge_ctrp_ces2 <- read_csv("~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ces2.csv")

feature_imp_ridge_ctrp_ceres <- read_csv("~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_ceres.csv")

feature_imp_ridge_ctrp_demeter2 <- read_csv("~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_demeter2.csv")

feature_sen_ctrp <- read_csv("~/cluster_scratch/impute_ctrp/ctrp_imputed.csv")

feature_imp_ridge_ctrp_seqpca <- read_csv("~/cluster_scratch/glmnet_modelling/result_largevm/feature_imp_ridge_ctrp_seq_pca.csv")


# update the analysis now (normalize the vector after merging)
feature_sen_ces1_ctrp <- inner_join(feature_imp_ridge_ctrp_ces1, feature_sen_ctrp,by = "broad_cpd_id") %>% 
  mutate_at(-1, .funs = scale )

feature_sen_seqpca_ctrp <- inner_join(feature_imp_ridge_seq_pca, feature_sen_ctrp,by = "broad_cpd_id") %>% 
    mutate_at(-1, .funs = scale )

ctrp_target_tibble <- read_csv("~/cluster_scratch/prior/target_long_ctrpv2.csv")
ctrpv2_list_to_zia <- read_csv("~/cluster_scratch/prior/ctrpv2_list_to_zia.csv")
ctrp_target_dtc <- read_csv("~/cluster_scratch/prior/ctrp_target_dtc.csv")

save.image("~/cluster_scratch/glmnet_modelling/target_pred_server/targetpred_serverinput.RData") 
```


```{r}
# a= rnorm(n = 100,mean = 0,sd = 1)
# b= rnorm(n = 100,mean = 0,sd = 1)
# 
# c1 = a + 3*b
# c2= 2*a + 2*b 
# c3 = 3*a + b 
# c4 = (2*a + 3*b)*10 



```


how do we use the feature important to predict drug target?

lets form the supervised drug target prediction scenarios!

in the meantime we want to compare the 
1ï¼‰signature based
2) sensitivity based prediction


lets use the existing target information of the
365 drugs to do cv and predict drug target

for these 365 drugs we will also drug sensitivities and drug consensus signatures from L1000, 
this should be quite easy. Lets aim at finishing these by tomorrow.

meanwhile I will collect the RNAseq data as basic entry for generating basal cell line info enhanced drug features.


lets build a pipeline first where a function can take a long target table, a prediction algorithm and a feature matrix to evaluate the predictability for that type of feature. 

The prediction algorithm will be based on dream challenge and performance is evaluated using cv.
We then consider again a nested cv to first find the thresholding parameters 

the central idea is to check what additional value can such basal cell info bring to MOA prediction in addition to the drug sensitivity and how does the accuracy comparing to, for example, chemical fingerprint based prediction?

## 3) Supervisied prediction with ctrpv2's own target info (from DrugBank)
```{r,warning = FALSE, message=FALSE,eval= FALSE}

target_tibble= ctrp_target_tibble %>%
  ungroup() %>%
  select(broad_cpd_id, gene_symbol_of_protein_target) %>%
  rename(drug=broad_cpd_id, target_gene=gene_symbol_of_protein_target) %>% 
  mutate(binding_score= 1)

set.seed(0000)
acc_ces1 <- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_ridge_ctrp_ces1 %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_ces2<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_ridge_ctrp_ces2 %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_ceres<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_ridge_ctrp_ceres %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_demeter2<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_ridge_ctrp_demeter2 %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_sen<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_sen_ctrp %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_sen_ces1<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_sen_ces1_ctrp %>% rename(drug=broad_cpd_id) )

set.seed(0000)
acc_seqpca<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_ridge_seq_pca %>% rename(drug=broad_cpd_id) )

set.seed(0000)
acc_sen_seqpca <- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_ridge_seq_pca %>% rename(drug=broad_cpd_id) )

save(
  list = c("acc_ces1","acc_ces2","acc_ceres","acc_demeter2","acc_sen","acc_sen_ces1","acc_seqpca","acc_sen_seqpca"),
  file = "~/cluster_scratch/glmnet_modelling/drugbank_supervised_prediction_ridge.RData"
  )
```

Check prediction performance Summary
```{r,warning = FALSE, message=FALSE}
load("~/cluster_scratch/glmnet_modelling/drugbank_supervised_prediction.RData")
mean(acc_ces1)
mean(acc_ces2)
mean(acc_ceres)
mean(acc_demeter2)
mean(acc_sen)
mean(acc_sen_ces1)
mean(acc_seqpca)
mean(acc_sen_seqpca)

median(acc_ces1)
median(acc_ces2)
median(acc_ceres)
median(acc_demeter2)
median(acc_sen)
median(acc_sen_ces1)
median(acc_seqpca)
median(acc_sen_seqpca)

wilcox.test(acc_ces1, acc_ceres,paired = T)
wilcox.test(acc_ces1, acc_ces2,paired = T)
wilcox.test(acc_ces1, acc_demeter2,paired = T)
```


## 4) Supervisied prediction with DTC target
redo the calculation given above
```{r,warning = FALSE, message=FALSE}

target_tibble <- ctrp_target_dtc %>% 
  select(standard_inchi_key, gene_name, interaction_strength) %>%
  filter(interaction_strength!= 0) %>% 
  drop_na() %>% 
  group_by(standard_inchi_key, gene_name) %>% 
  summarize(interaction_strength= median(interaction_strength,na.rm = T)) %>% 
  ungroup() %>% 
  inner_join(ctrpv2_list_to_zia,by= c("standard_inchi_key"= "InChIKey")) %>% 
  select(broad_cpd_id, gene_name, interaction_strength) %>% 
  group_by(broad_cpd_id, gene_name) %>% 
  summarize(interaction_strength= median(interaction_strength,na.rm = T)) %>% 
  ungroup() %>%   rename(drug=broad_cpd_id, target_gene=gene_name, binding_score= interaction_strength) 

length(unique(target_tibble$drug)) 

set.seed(0000)
acc_ces1 <- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_glmnet_ctrp_ces1 %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_ces2<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_glmnet_ctrp_ces2 %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_ceres<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_glmnet_ctrp_ceres %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_demeter2<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_glmnet_ctrp_demeter2 %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_sen<- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_sen_ctrp %>% rename(drug=broad_cpd_id) ) 

set.seed(0000)
acc_sen_ces1 <- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_sen_ces1_ctrp %>% rename(drug=broad_cpd_id) )

set.seed(0000)
acc_seqpca <- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_imp_glmnet_seq_pca %>% rename(drug=broad_cpd_id) )

set.seed(0000)
acc_sen_seqpca <- return_target_supervised_similiarity_prediction_acc(
  target_tibble = target_tibble,
  predictors_tibble = feature_sen_seqpca_ctrp %>% rename(drug=broad_cpd_id) )
save(
  list = c("acc_ces1","acc_ces2","acc_ceres","acc_demeter2","acc_sen","acc_sen_ces1","acc_seqpca","acc_sen_seqpca"),
  file = "~/cluster_scratch/glmnet_modelling/dtc_supervised_prediction.RData"
  )
```

Check prediction performance Summary
```{r}
load("~/cluster_scratch/glmnet_modelling/dtc_supervised_prediction.RData")
mean(acc_ces1)
mean(acc_ces2)
mean(acc_ceres)
mean(acc_demeter2)
mean(acc_sen)
mean(acc_sen_ces1)
mean(acc_seqpca)
mean(acc_sen_seqpca)

wilcox.test(acc_ces1, acc_ceres,paired = T)
wilcox.test(acc_ces1, acc_ces2,paired = T)
wilcox.test(acc_ces1, acc_demeter2,paired = T)

median(acc_ces1)
median(acc_ces2)
median(acc_ceres)
median(acc_demeter2)
median(acc_sen)
median(acc_sen_ces1)
median(acc_seqpca)
median(acc_sen_seqpca)
```

## 5) Combine the result and plotting
```{r}
rm(list = ls())
load("~/cluster_scratch/glmnet_modelling/drugbank_supervised_prediction.RData")
acc_list <- ls()
acc_drugbank <- map_dfc(.x = acc_list,.f = get)
colnames(acc_drugbank) <- acc_list


load("~/cluster_scratch/glmnet_modelling/dtc_supervised_prediction.RData")
acc_dtc <- map_dfc(.x = acc_list,.f = get)
colnames(acc_dtc) <- acc_list

acc_supervised_target_pred <- bind_rows(
  acc_drugbank %>% 
    pivot_longer(cols= everything(),names_to = "method",values_to= "spearman_cor") %>%
    mutate(label_dataset= "drugbank")
  ,
  acc_dtc %>%
    pivot_longer(cols= everything(),names_to = "method",values_to= "spearman_cor") %>%
    mutate(label_dataset= "dtc")
)

acc_supervised_target_pred %>% 
  ggplot(aes(x= method, y = spearman_cor, fill= label_dataset)) +
  geom_boxplot()+
  theme_classic()


fig <- acc_supervised_target_pred %>% 
  ggplot(aes(fill= method,  x= label_dataset,y = spearman_cor)) +
  geom_boxplot(outlier.color = "white")+
  theme_classic()+
  scale_fill_discrete(name = "Predictor data type", labels = c("CERES","CES1","CES2", "DEMETER2", "Sensitivity", "Sensitivity+CES1", "Sensitivity+EXP", "EXP"))+
  xlab("Target resources" )+
  ylab("Prediction accuracy")
  
fig
```



```{r,fig.width=5, fig.height=2}
fig
```
```{r}
fig <- acc_supervised_target_pred %>% 
  filter(method %in% c("acc_ces1", "acc_sen", "acc_sen_ces1", "acc_seqpca", "acc_sen_seqpca")) %>% 
  ggplot(aes(fill= method,  x= label_dataset,y = spearman_cor)) +
  geom_boxplot(outlier.color = "white")+
  theme_classic()+
  scale_fill_discrete(name = "Predictor data type", labels = c("CES1","Sensitivity", "Sensitivity+CES1", "Sensitivity+EXP", "EXP"))+
  xlab("Target resources" )+
  ylab("Prediction accuracy")
  
```


```{r,fig.width=4, fig.height=2}
fig
```




# 2 Unsupervised target exploration
use network long table, target long table and feature long table to generate a full long table with at least 5 columns


Now I am deriving the feature importance matrix for all four types of data to see how it performs (the job was run using run_glm_cluster.R and glmfit_onenode.sh in the glmnet_modelling_cluster module)

```{r}
kegg_tibble <- read_csv("~/cluster_scratch/prior/kegg_tibble.csv")

target_tibble <- ctrp_target_tibble %>%
  ungroup() %>%
  select(broad_cpd_id, gene_symbol_of_protein_target) %>%
  rename(drug=broad_cpd_id, target_gene=gene_symbol_of_protein_target) %>% 
  mutate(binding_score= 1)


ces1_glm_feature_annotated <- 
  annotate_feature_matrix(
    network = kegg_tibble,
    feature_imp_mat = feature_imp_glmnet_ctrp_ces1%>% 
      rename(drug= broad_cpd_id),
    target=  target_tibble
    )

ces2_glm_feature_annotated <- 
  annotate_feature_matrix(
    network = kegg_tibble,
    feature_imp_mat = feature_imp_glmnet_ctrp_ces2%>% 
      rename(drug= broad_cpd_id),
    target=  target_tibble
    )
  
ceres_glm_feature_annotated <- 
    annotate_feature_matrix(
    network = kegg_tibble,
    feature_imp_mat = feature_imp_glmnet_ctrp_ceres %>% 
      rename(drug= broad_cpd_id),
    target=  target_tibble
    )

demeter_glm_feature_annotated <- 
    annotate_feature_matrix(
    network = kegg_tibble,
    feature_imp_mat = feature_imp_glmnet_ctrp_demeter2 %>% 
      rename(drug= broad_cpd_id),
    target=  target_tibble
    )

save(list = c("ces1_glm_feature_annotated","ces2_glm_feature_annotated","ceres_glm_feature_annotated","demeter_glm_feature_annotated"),
     file = "~/cluster_scratch/glmnet_modelling/drugbank_annotated_feature_importance.RData"
     )
```

plot how the feature importance top ranked genes falls in direct target and 1, 2,3 neighbors. 
```{r}
load("~/cluster_scratch/glmnet_modelling/drugbank_annotated_feature_importance.RData")

drugbank_annotated_feature_importance <- 
  ces1_glm_feature_annotated %>% 
  mutate(ess= "ces1") %>% 
  bind_rows(ces2_glm_feature_annotated %>% mutate(ess= "ces2")) %>% 
  bind_rows(ceres_glm_feature_annotated %>% mutate(ess= "ceres")) %>%   
  bind_rows(demeter_glm_feature_annotated %>% mutate(ess= "demeter")) 


#let plot a grouped table of how target and their 1,2,3 neighbors are identified.

# feature importance distribution 

tmp <- drugbank_annotated_feature_importance %>%
  filter(imp!=0) %>% 
  pull(imp)
hist(tmp)  


drugbank_annotated_feature_importance %>% 
  filter(imp!=0) %>% 
  ggplot(aes(x= target_cat, y= imp, fill= ess)) +
  geom_violin()+
  theme_classic()+
  geom_hline(yintercept =0)

# drugbank_annotated_feature_importance %>% 
#   filter(imp!=0) %>% 
#   ggplot(aes(x= target_cat, y= log2(imp+1), fill= ess)) +
#   geom_violin()+
#   theme_classic()
fig <- drugbank_annotated_feature_importance %>% 
  filter(imp!=0) %>% 
  # ggplot(aes(x= target_cat, y= log(imp+1), fill= ess)) +
  ggplot(aes(x= target_cat, y= imp, fill= ess)) +
  geom_boxplot(outlier.size = 0.01)+ #outlier.size = -1
  geom_hline(yintercept = 0, lty=4, color= "red")+
  theme_classic()+
  xlab("Gene type")+
  ylab("Feature importance")+
  labs(fill= "Essentiality") +
  scale_x_discrete(breaks=c("0","1","2","3","4"),
        labels=c("Nomial target", "1st neighbour", "2nd neigbour", "3rd neighbour", "Others"))
  

# drugbank_annotated_feature_importance %>% 
#   filter(imp!=0) %>% 
#   ggplot(aes(x= target_cat, y= log2(imp+1), fill= ess)) +
#   geom_boxplot()+
#   theme_classic()

# how to transform the y axis so that it distribute more equally?

```

```{r, fig.height=2,fig.width=6}
fig
```


```{r}
#how many target and 1,2,3 neighbours has been identified by the non-zero feature importance?
drugbank_annotated_feature_importance %>% 
  filter(imp!=0) %>% 
  # filter(target_cat!=4) %>% 
  select(-imp) %>% 
  ggplot(aes(x= target_cat,  fill= ess)) +
  geom_bar(position = position_dodge())

# note dont use numbers, use the percentage: such as what percent of all the target are identified by the positive drug-gene feature importance?
tmp <- drugbank_annotated_feature_importance %>% 
  filter(target_cat==0) %>% 
  filter(imp > 0) %>%
  # filter(imp!0) %>% 
  group_by(ess) %>% 
  summarise(Percetage= n()/744)

# looks that the percentage of identifying the direct target is not looking good.
# (ceres result better than ces1?)
# perhaps stay with the form plot.
# or maybe tailer a threshold?


#How many target has been identified by the postive feature importance?
tmp <- drugbank_annotated_feature_importance %>% 
  # filter(target_cat==0) %>% 
  filter(imp > 0) %>%
  group_by(ess) %>% 
  summarise(Percetage= n())

```

ROC curve
```{r}
# tmp <-drugbank_annotated_feature_importance %>% 
#   mutate(d= (target_cat == "0")) 
  # pivot_wider(names_from=ess, values_from=imp)
  

library(plotROC)


fig <-  drugbank_annotated_feature_importance %>% 
  filter(imp>0) %>% 
  mutate(d= (target_cat == "0")) %>% 
  ggplot(aes(d = d, m = imp, color = ess )) + 
  geom_roc(n.cuts=0, size =0.3) + 
  style_roc(xlab="FPR",ylab="TPR")+
  theme_classic()+
  ggtitle("drugbank")+
      scale_x_continuous(breaks=seq(0,1,0.2),name = "FPR")+
    scale_y_continuous(breaks=seq(0,1,0.2),name = "TPR")
```

```{r,fig.height=2, fig.width=3}
fig
```





How about use dtc target to annotate
note now you also have interaction strength!

```{r}
ctrpv2_list_to_zia <- read_csv("~/cluster_scratch/prior/ctrpv2_list_to_zia.csv")
ctrp_target_dtc <- read_csv("~/cluster_scratch/prior/ctrp_target_dtc.csv")

target_tibble <- ctrp_target_dtc %>% 
  select(standard_inchi_key, gene_name, interaction_strength) %>%
  filter(interaction_strength!= 0) %>% 
  drop_na() %>% 
  group_by(standard_inchi_key, gene_name) %>% 
  summarize(interaction_strength= median(interaction_strength,na.rm = T)) %>% 
  ungroup() %>% 
  inner_join(ctrpv2_list_to_zia,by= c("standard_inchi_key"= "InChIKey")) %>% 
  select(broad_cpd_id, gene_name, interaction_strength) %>% 
  group_by(broad_cpd_id, gene_name) %>% 
  summarize(interaction_strength= median(interaction_strength,na.rm = T)) %>% 
  ungroup() %>%   rename(drug=broad_cpd_id, target_gene=gene_name, binding_score= interaction_strength) 

# ces1_glm_feature_annotated <- 
#   annotate_feature_matrix(
#     network = kegg_tibble,
#     feature_imp_mat = feature_imp_glmnet_ctrp_ces1%>% 
#       rename(drug= broad_cpd_id),
#     target=  target_tibble
#     )
# 
# ces2_glm_feature_annotated <- 
#   annotate_feature_matrix(
#     network = kegg_tibble,
#     feature_imp_mat = feature_imp_glmnet_ctrp_ces2%>% 
#       rename(drug= broad_cpd_id),
#     target=  target_tibble
#     )
#   
# ceres_glm_feature_annotated <- 
#     annotate_feature_matrix(
#     network = kegg_tibble,
#     feature_imp_mat = feature_imp_glmnet_ctrp_ceres %>% 
#       rename(drug= broad_cpd_id),
#     target=  target_tibble
#     )
# 
# demeter_glm_feature_annotated <- 
#     annotate_feature_matrix(
#     network = kegg_tibble,
#     feature_imp_mat = feature_imp_glmnet_ctrp_demeter2 %>% 
#       rename(drug= broad_cpd_id),
#     target=  target_tibble
#     )
# 
# save(list = c("ces1_glm_feature_annotated","ces2_glm_feature_annotated","ceres_glm_feature_annotated","demeter_glm_feature_annotated"),
#      file = "~/cluster_scratch/glmnet_modelling/DTC_annotated_feature_importance.RData"
#      )

```

since both feature importance and target binding score are continues now
lets see how do they agree with each other.

Is there a correlation?  for genes that do have a drug target binding score, does the feature importance value correlate with the numeric binding strength (original values or abs or only take the negative/positive ones?))


```{r}
load("~/cluster_scratch/glmnet_modelling/DTC_annotated_feature_importance.RData")
DTC_annotated_feature_importance <- 
  ces1_glm_feature_annotated %>% 
  mutate(ess= "ces1") %>% 
  bind_rows(ces2_glm_feature_annotated %>% mutate(ess= "ces2")) %>% 
  bind_rows(ceres_glm_feature_annotated %>% mutate(ess= "ceres")) %>%   
  bind_rows(demeter_glm_feature_annotated %>% mutate(ess= "demeter")) %>% 
  left_join(target_tibble,by= c("drug"= "drug", "gene"= "target_gene"))

```

Is there a linear relationship?

```{r}
fig <- DTC_annotated_feature_importance %>% 
  drop_na() %>%
  filter(imp!=0) %>% 
  ggplot(aes(y= imp, x= binding_score, color= ess)) 

fig +  geom_point()
fig +  stat_summary_bin(geom="crossbar",position = position_dodge()) 
```


```{r}
fig <- DTC_annotated_feature_importance %>% 
  drop_na() %>%
  filter(imp>0) %>%
  filter(ess== "ces1") %>% 
  ggplot(aes(y= log10(imp), x= binding_score))+
  geom_point(size= 0.1)+
  # stat_summary_bin(geom="crossbar",width= 0.3, color= "red",bins = 8)+
  theme_classic()
```


```{r, fig.width=2, fig.height=2}
fig
```

How does the ROC and Precision-recall curve looks like?

Note the precision and recall curve requires a binary label.
lets just use binding score 0, 0.2, 0.4, 0.6, 0.8 as threshold for binarization
```{r}
generate_roc_by_thresholding <- function(x){
  tmp <- DTC_annotated_feature_importance %>% 
  replace_na(list(binding_score = 0)) %>% 
  mutate(d= as.integer(binding_score>x))  %>% 
  filter(imp > 0)
  # mutate(threshold_0= (binding_score>0)) %>% 
  # mutate(threshold_0.2= (binding_score>0.2)) %>% 
  # mutate(threshold_0.4= (binding_score>0.4)) %>% 
  # mutate(threshold_0.6= (binding_score>0.6) ) %>% 
  # mutate(threshold_0.8= (binding_score>0.8)) %>% 
  # filter(threshold== threshold_0.2) %>% 
  # pivot_longer(cols = starts_with("thres"),names_to = "threshold", values_to= "D") %>% 
  tmp %>% 
  ggplot(aes(d = d, m = imp, color = ess)) + 
  geom_roc(n.cuts=0) + 
  style_roc(xlab="FPR",ylab="TPR")+
  theme_classic()+
  ggtitle(paste("threshold", x,sep= " "))

  }


```

```{r}
generate_roc_by_thresholding(0.2)
generate_roc_by_thresholding(0.4)
generate_roc_by_thresholding(0.5)
generate_roc_by_thresholding(0.6)
generate_roc_by_thresholding(0.8)


```


how many drug are there for each expression dataset?
```{r}
x <- ctrpv2_data$sensitivity[[1]]
tmp <- ctrpv2_data %>% 
  mutate(exp_data_point= map_int(.x = sensitivity, .f = function(x){
    tmp <- x %>% inner_join( 
      y= janitor::clean_names(exp_seq_imputed[,1:2])%>% 
        rename_at(vars(!contains("dep_map_id")), .fun= ~paste0(., "_predictors")), 
            by= c("DepMap_ID"="dep_map_id")) 
    tmp1 <- nrow(tmp)
    return(tmp1)
  })) 
estimate_performance_glmnet(sen_df = x,ess = exp_seq_imputed[,1:10])
estimate_performance_glmnet(sen_df = x,ess = exp_seq_imputed[,1:10])
```






