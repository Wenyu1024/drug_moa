---
title: "Non-oncology drug validation"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
library(ggsci)
library(fgsea)
```


```{r}
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
rm(get_target_mat)
rm(no_tunning_weighted_averaging)
rm(get_target_pred_accuracy_batch)
rm(return_acc_estimate_cv)
# note the unsupervised auc is precalculated in get_unsupervised_target_prediction_auc.R code
```


```{r}
load("~/cluster_scratch/unsupervised_target_pred/unsupervised_target_pred_ConSenSig.RData")

cell_line_info <- data.table::fread("~/cluster_scratch/depmap_21q1/sampleinfo")
targetpanel_dtc <- data.table::fread("~/cluster_scratch/prior/DTC_data_all.csv",
                                 select = c("gene_names")) %>% distinct() %>% pull(gene_names)

cell_line_info <- data.table::fread("~/cluster_scratch/depmap_21q1/sampleinfo")

targetpanel_drh <- read_tsv("~/cluster_scratch/prior/repurposing_drugs_20200324.txt") %>% 
  select(-disease_area, -indication) %>% 
  drop_na() %>% 
  separate_rows(target) %>% 
  distinct() 

targetpanel_drh_genelevel <- targetpanel_drh %>% 
  select(pert_iname, target) %>% 
  group_by(target) %>% 
  summarise(drug= paste(pert_iname,collapse = ","))
cellline_hgsoc <- cell_line_info %>% 
  filter(primary_disease== "Ovarian Cancer") %>% 
  filter(Subtype== "Adenocarcinoma, high grade serous")
```


```{r}
res_prism2_long <- res_prism2
res_prism2 <- res_prism2_long %>%
  select(-variance) %>% 
  filter(.metric== "spearman coef") %>%
  pivot_wider(names_from = input, values_from= estimate) %>%
  mutate(acc_sen= (ceres+ces+demeter2)/3) %>%
  distinct() 
prism_good_fitted_drugs <- res_prism2 %>%
  filter(sample_size>100) %>%
  filter(acc_sen>0.2) %>%
  arrange(BROAD_ID)
# n=312, 199 targeted cancer drugs, 50 chemo drugs and 63 noncancer drugs.

# how many non-oncology drugs? N= 63
prism_good_fitted_nononcologydrugs <-  prism_good_fitted_drugs %>% 
  filter(drug_category== "noncancer") %>% 
  arrange(BROAD_ID ) %>% 
  pull(BROAD_ID) %>% 
  unique()


# drh annotation include both MOA and target info N=268, this will be my train set
prism_good_fitted_drugs_drhannotated <- prism_good_fitted_drugs %>% 
  select(BROAD_ID, moa) %>% 
  drop_na() %>% 
  filter(BROAD_ID %in% prism_target_binary$drug) %>% 
  pull(BROAD_ID)
  
# DTC only care about target gene but not moa annotation: N= 52
prism_good_fitted_drugs_dtcannotated <- prism_good_fitted_drugs %>% 
  filter(BROAD_ID %in% prism_target_dtc$drug) %>% 
  pull(BROAD_ID)

# 46 = 58-13 +1 1 drug no moa but have target.
# prism_good_fitted_nononcologydrugs_drhannotated <- intersect(prism_good_fitted_drugs_drhannotated, prism_good_fitted_nononcologydrugs)
# 
# prism_good_fitted_nononcologydrugs_drhnotannotated <- setdiff(prism_good_fitted_drugs_drhannotated, prism_good_fitted_nononcologydrugs)

# prism_good_fitted_nononcologydrugs <-  prism_good_fitted_drugs %>% 
#   filter(drug_category== "noncancer") %>% 
#   arrange(BROAD_ID ) %>% 
#   filter(is.na(moa))

save(list = c("prism_data", "prism_target_binary", "prism_target_dtc"), file= "./fig_res/putative_targetinfo.RData")
```

get hgsoc sensitivity for all 63 noncancer drugs
```{r}
prism_63_sen <- prism_data %>% 
  filter(BROAD_ID %in%  prism_good_fitted_nononcologydrugs) %>% 
  select(BROAD_ID ,sensitivity) %>% 
  unnest(cols=sensitivity) %>% 
  drop_na()


# list auc of HGSOC, and the number of sen HGSOC cells for that drugs
prism_63_sen_hgsoc <- full_join(
    x= prism_63_sen %>% filter(depmap_id %in% cellline_hgsoc$DepMap_ID),
    y= cellline_hgsoc %>% select(DepMap_ID, cell_line_name), 
    by=c("depmap_id"= "DepMap_ID")
  ) %>% 
  select(-ec50) %>% 
  # filter(auc< 0.8) %>%
  group_by(BROAD_ID) %>% 
  summarise(n_total= n(),n_0.8= sum(auc<0.8)  ) %>% 
  drop_na() %>% 
  ungroup() %>% 
  full_join(
  y = prism_63_sen %>% filter(depmap_id == "ACH-000524")
    )
# write_csv(prism_63_sen_hgsoc, path = "~/cluster_wrk/drug_moa/predicting_prism/prism_63_sen_hgsoc.csv")

# tmp <- prism_data %>% filter(BROAD_ID %in% prism_good_fitted_nononcologydrugs) %>% 
#   filter(!(BROAD_ID  %in% prism_good_fitted_drugs_drhannotated )) %>%  select(BROAD_ID, moa)
```



Now use the 268 drugs as the training set to predict the targets for the drugs of interest
```{r}
source("~/cluster_wrk/drug_moa/supervised_target_pred/function/get_target_pred_supervised.R")
source('~/cluster_wrk/drug_moa/supervised_target_pred/function/return_acc_estimate_loocv.R')
prism_drh_predictions <- get_predictions(
  sig_data=feature_imp_ridge_prism_comb1,
  train_drugs=prism_good_fitted_drugs_drhannotated,
  pred_drugs=prism_good_fitted_drugs$BROAD_ID, 
  train_label= prism_target_binary) %>% 
  as_tibble(rownames= "target")

prism_unsupervised <- feature_imp_ridge_prism_comb1 %>% 
  filter(drug %in% prism_good_fitted_drugs$BROAD_ID) %>% 
  pivot_longer(-drug, names_to= "target", values_to= "pred") %>% 
  pivot_wider(id_cols = target, names_from= drug, values_from= pred)

setwd("~/cluster_wrk/drug_moa/predicting_prism")
write_csv(prism_drh_predictions, "./fig_res/prism312_drh_predictions.csv")
write_csv(prism_unsupervised,path = "./fig_res/prism312_unsupervised.csv")
```
y

```{r}
rm(list= ls())
load("./fig_res/putative_targetinfo.RData")
prism_drh_predictions <- read_csv("../predicting_prism/fig_res/prism312_drh_predictions.csv")
prism_unsupervised <- read_csv("../predicting_prism/fig_res/prism312_unsupervised.csv")

senvalid_20drugs <- read_csv("../predicting_prism/fig_res/res_final.csv")
PISA_summary <- read_csv( "~/cluster_wrk/sen_tar_validation/data/inputdata/pisa_summary.csv")

# intersect(senvalid_20drugs$Drug_name, unique(PISA_summary$drug_name) )
# setdiff(senvalid_20drugs$Drug_name, unique(PISA_summary$drug_name))
# setdiff(unique(PISA_summary$drug_name),senvalid_20drugs$Drug_name)

PISA_summary <- PISA_summary %>% 
  janitor::clean_names() %>% 
  filter(!is.na(gene_symbol))%>%  
  inner_join(senvalid_20drugs %>% select(Drug_name, drugid),  by=c("drug_name"="Drug_name")) %>% 
  group_by(drugid, drug_name, gene_symbol) %>%
  slice_min(p_value) %>%
  ungroup() %>% 
  mutate(p_adj=p.adjust(p_value, method = "fdr")) 

PISA_summary <- janitor::clean_names(PISA_summary)

# PISA_summary %>% group_by(drug_name) %>% summarise(res= length((gene_symbol)))
# PISA_summary %>% group_by(drug_name) %>% summarise(res= length(unique(gene_symbol)))
#there are duplicates in gene names, summarize by score
hist(PISA_summary$log2_fc)

# PISA_summary_simplified <- PISA_summary %>% 
#   select(drugid, drug_name, gene_symbol, fc, p_value,score,log10_p, log2_fc) %>%
#   # nest_by(drugid, drug_name, gene_symbol) %>% 
#   # ungroup()
#   group_by(drugid, drug_name, gene_symbol) %>% 
#   slice_min(p_value) %>% 
#   ungroup()


prism_drh_pred20 <- prism_drh_predictions %>% 
  select(one_of(c("BROAD_ID", senvalid_20drugs$drugid))) %>% 
  pivot_longer(cols= 2:21,names_to="drug_id", values_to="sup_pred_score") %>% 
  rename(target=BROAD_ID)

prism_unsupervised_pred20 <- prism_unsupervised %>% 
  select(one_of(c("target", senvalid_20drugs$drugid))) %>% 
  pivot_longer(cols= 2:21,names_to="drug_id", values_to="unsup_pred_score")
```


```{r}
# log2(TPM+1) psedo count
exp_seq_kuramochi <- read_csv("~/cluster_scratch/ces_21q1_io/exp_seq_tidy.csv") %>% 
  filter(DepMap_ID== 'ACH-000524') %>% 
  pivot_longer(cols = - DepMap_ID, names_to= "gene", values_to="exp_tpm_rsem") 

exp_seq_kuramochi %>% 
  filter(gene %in% unique(PISA_summary$gene_symbol)) %>% 
  ggplot()+
  geom_histogram(aes(exp_tpm_rsem))+
  xlab("log2(TPM+1)")
exp_gene_c2 <- exp_seq_kuramochi%>% 
  filter(exp_tpm_rsem>2) %>% 
  pull(gene)
```


```{r}
tmp <- full_join(
  prism_drh_pred20, 
  PISA_summary  %>% 
    select(drug_name, gene_symbol, drugid, score),
  by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
  filter(!is.na(drug_name)) %>% 
  nest_by(drug_id, drug_name) %>% 
  ungroup() %>% 
  mutate(cor= map_dbl(.x = data, 
                      .f = function(df){
                        df= df %>% filter(_c2)
                        cor(df$sup_pred_score, df$score, use = "complete.obs")}))

tmp1 <- full_join(
  prism_unsupervised_pred20, 
  PISA_summary  %>% 
    select(drug_name, gene_symbol, drugid, score),
  by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
  filter(!is.na(drug_name)) %>% 
  nest_by(drug_id, drug_name) %>% 
  ungroup() %>% 
  mutate(cor= map_dbl(.x = data, 
                      .f = function(df){
                        df= df %>% filter(exp_gene_c2)
                        cor(df$unsup_pred_score, df$score, use = "complete.obs")}))
```

Check PISA result with expression
```{r}


#filter out the non expressing genes from PISA as they are false positive result.
# use threshold 2 for log2(TPM+1) play with this threshold to get better results.


# in general pisa result is not correlated with gene expression
inner_join(exp_seq_kuramochi, PISA_summary, by=c("gene"= "gene_symbol")) %>% 
  nest_by(drug_name, drugid) %>% 
  ungroup() %>% 
  mutate(cor= map_dbl(.x = data, 
                      .f = function(df){cor(df$exp_tpm_rsem, df$score, use = "complete.obs")})) %>% 
  select(-data) %>%
  mutate(cor= round(cor,2)) %>% 
  arrange(desc(cor)) %>% 
  View()

#however there is still false positive result which should be removed.

inner_join(exp_seq_kuramochi,  <- , by=c("gene"= "gene_symbol")) %>% 
  mutate(exp_status= (exp_tpm_rsem>2)) %>% 
  ggplot(aes(exp_status, log10(score)))+
  geom_violin()+
  ggpubr::stat_compare_means(method = "t.test")


```


check whether PISA result recapulate putative targets
```{r}
pisa_drh <- prism_target_binary %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol"))

t.test(pisa_drh$score, PISA_summary$score)

prism_target_binary %>% 
  mutate(binding_score=1) %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  right_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= !(is.na(binding_score))) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
 
pisa_dtc <- prism_target_dtc %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol"))

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

pisa_dtc %>% 
  drop_na() %>% 
  ggplot(aes(score, binding_score))+
  geom_point()+
  ylab("dtc_score")+
  xlab("pisa_score")

# only one drug are widely avaliable BMS-387032

prism_target_dtc %>% 
  filter(drug == "BRD-K43389698") %>%
  # filter(drug %in% pisa_dtc$drug) %>%  
  right_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= case_when(binding_score>0.4~ "yes",
                             (binding_score <= 0.4)|(is.na(binding_score))~ "no")) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "kendall")

# whether the primary targets are  prioritized in PISA result
# cannot do enrichment analysis since there are too little
```

what if I filter out false positive PISA result?
```{r}
PISA_summary_expfiltered <- PISA_summary %>% filter(gene_symbol %in% exp_gene_c2) 
pisa_drh <- prism_target_binary %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol"))

t.test(pisa_drh$score, PISA_summary_expfiltered$score)

prism_target_binary %>% 
  mutate(binding_score=1) %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  right_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= !(is.na(binding_score))) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
  
pisa_dtc <- prism_target_dtc %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol"))

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

pisa_dtc %>% 
  drop_na() %>% 
  ggplot(aes(score, binding_score))+
  geom_point()+
  ylab("dtc_score")+
  xlab("pisa_score")

# only one drug are widely avaliable BMS-387032

prism_target_dtc %>% 
  filter(drug == "BRD-K43389698") %>%
  # filter(drug %in% pisa_dtc$drug) %>%  
  right_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= case_when(binding_score>0.4~ "yes",
                             (binding_score <= 0.4)|(is.na(binding_score))~ "no")) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "kendall")

tmp2 <- full_join(
  prism_drh_pred20, 
  PISA_summary_expfiltered  %>% 
    # filter(log2_fc>0) %>%
    select(drug_name, gene_symbol, drugid, score)
  ,
  by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
  filter(!is.na(drug_name)) %>% 
  nest_by(drug_id, drug_name) %>% 
  ungroup() %>% 
  mutate(cor= map_dbl(.x = data, 
                      .f = function(df){cor(df$sup_pred_score, df$score, use = "complete.obs")}))

tmp2_filtered <- full_join(
  prism_drh_pred20, 
  PISA_summary_expfiltered  %>% 
    filter(log2_fc>0) %>%
    select(drug_name, gene_symbol, drugid, score)
  ,
  by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
  filter(!is.na(drug_name)) %>% 
  nest_by(drug_id, drug_name) %>% 
  ungroup() %>% 
  mutate(cor= map_dbl(.x = data, 
                      .f = function(df){cor(df$sup_pred_score, df$score, use = "complete.obs")}))

tmp3 <- full_join(
  prism_unsupervised_pred20, 
  PISA_summary_expfiltered  %>% 
        filter(log2_fc>0) %>% 
    select(drug_name, gene_symbol, drugid, score),
  by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
  filter(!is.na(drug_name)) %>% 
  nest_by(drug_id, drug_name) %>% 
  ungroup() %>% 
  mutate(cor= map_dbl(.x = data, 
                      .f = function(df){cor(df$unsup_pred_score, df$score, use = "complete.obs")}))
```

Whether the top predicted targets are prioritized in the pisa result vector?
```{r}
# generate pathway object
generate_pathway <- function(df= prism_drh_pred20, gene_number= 30){
  
  res <- df %>% 
  rename("score"=ends_with("score")) %>% 
  group_by(drug_id) %>% 
  slice_max(n= gene_number,order_by=score) %>% 
  ungroup() %>% 
  select(drug_id, target) %>% 
  nest_by(drug_id,.key= "genelist") %>% ungroup() %>% 
  mutate(genelist= map(.x = genelist, ~.x$target)) 
  res1 <- res$genelist
  names(res1) <- res$drug_id

  candidate_gene <- df %>% 
    select(target) %>% 
    distinct() %>% 
    pull(target)
  res2 <- map(1:100, function(i){
    set.seed(i)
    res= sample(candidate_gene, size = gene_number)
    return(res)} )
  names(res2) <- paste("geneset_rdm", 1:100, sep= "_")
  res3 <- c(res1, res2)
  return(res3)
}

# generate 99 random pathways to be shared for all the drugs
# the total number of pathways for each drug will be 101.
prism_drh_pred20_pathway50 <- generate_pathway(prism_drh_pred20, 50)
prism_unsupervised_pathway50 <- generate_pathway(prism_unsupervised_pred20, 50)
```


```{r}
save.image("~/cluster_wrk/drug_moa/noncancer_drug_validation/tmp.RData")
library(future)
plan(multisession)
res2 <- tmp %>%
  mutate(pathway_res=
           furrr::future_map(
             .x= data,
             .f= function(df){
                df <- df %>% select(c(1,3)) %>% drop_na()
                rank <- df %>% pull(2)
                names(rank) <-  df %>% pull(1)
                # pathway= 
                fgseaRes <- fgsea(prism_drh_pred20_pathway50, rank,scoreType = "pos")
                fgseaRes <- fgseaRes %>% arrange(pval)
                return(fgseaRes)}
             ,
             .options = furrr::furrr_options(seed = TRUE)
             ))

plan(sequential)
res2_flat <- res2 %>% select(-data) %>% unnest(pathway_res) %>% 
  mutate(matched_pathway= (drug_id==pathway)

res2_flat %>% 
  ggplot(aes(matched_pathway, ES))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
         

plan(multisession)
res3 <- tmp %>%
  mutate(pathway_res=
           furrr::future_map(
             .x= data,
             .f= function(df){
                df <- df %>% select(c(1,3)) %>% drop_na()
                rank <- df %>% pull(2)
                names(rank) <-  df %>% pull(1)
                fgseaRes <- fgsea(prism_unsupervised_pathway50, rank,scoreType = "pos")
                fgseaRes <- fgseaRes %>% arrange(pval)
                return(fgseaRes)}
             ,
             .options = furrr::furrr_options(seed = TRUE)
             ))
plan(sequential)

res3_flat <- res3 %>% select(-data) %>% unnest(pathway_res) %>% 
  mutate(matched_pathway= (drug_id==pathway))

res3_flat %>% 
  ggplot(aes(matched_pathway, ES))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
```


```{r}
plan(multisession)
res4 <- tmp2 %>%
  mutate(pathway_res=
           furrr::future_map(
             .x= data,
             .f= function(df){
                df <- df %>% select(c(1,3)) %>% drop_na()
                rank <- df %>% pull(2)
                names(rank) <-  df %>% pull(1)
                # pathway= 
                fgseaRes <- fgsea(prism_drh_pred20_pathway50, rank,scoreType = "pos")
                fgseaRes <- fgseaRes %>% arrange(pval)
                return(fgseaRes)}
             ,
             .options = furrr::furrr_options(seed = TRUE)
             ))

plan(sequential)
res4_flat <- res4 %>% select(-data) %>% unnest(pathway_res) %>% 
  mutate(matched_pathway= (drug_id==pathway))

res4_flat %>% 
  ggplot(aes(matched_pathway, ES))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
         

plan(multisession)
res5 <- tmp2 %>%
  mutate(pathway_res=
           furrr::future_map(
             .x= data,
             .f= function(df){
                df <- df %>% select(c(1,3)) %>% drop_na()
                rank <- df %>% pull(2)
                names(rank) <-  df %>% pull(1)
                fgseaRes <- fgsea(prism_unsupervised_pathway50, rank,scoreType = "pos")
                fgseaRes <- fgseaRes %>% arrange(pval)
                return(fgseaRes)}
             ,
             .options = furrr::furrr_options(seed = TRUE)
             ))
plan(sequential)

res5_flat <- res5 %>% select(-data) %>% unnest(pathway_res) %>% 
  mutate(matched_pathway= (drug_id==pathway))

res5_flat %>% 
  ggplot(aes(matched_pathway, ES))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
```


```{r}
# PISA_summary_augmented= PISA_summary %>% 
#   mutate(exp_status= gene_symbol %in% exp_gene_c2) %>%
#   mutate(score1= log10_p*abs(log2_fc)*(p_value<0.05)) %>%
#   mutate(score2= p_adj*abs(log2_fc)) %>%
#   mutate(score3= p_adj*(p_adj<0.1)*abs(log2_fc) )%>%
#   mutate(score4= abs(log2_fc)*(p_value<0.05)) %>% 
#   mutate(score5= (p_adj<0.25)*abs(log2_fc) ) %>%
#   mutate(score6= (p_value<0.05) ) %>% 
#   mutate(score7= (p_adj<0.25) ) %>% 
#   mutate(score8= (p_adj<0.20) ) %>% 
#   mutate(score9= (p_adj<0.15) ) %>% 
#   mutate(score10= (p_adj<0.1) ) %>% 
#   mutate(score11= (p_adj<0.05) ) %>% 
#   mutate(score12= (p_value<0.05)& (abs(log2_fc)>0.322)) %>% 
#   mutate(score13= (p_adj<0.25)& (abs(log2_fc)>0.322)) %>% 
#   mutate(score14= (p_adj<0.20)& (abs(log2_fc)>0.322) ) %>% 
#   mutate(score15= (p_adj<0.15)& (abs(log2_fc)>0.322) ) %>% 
#   mutate(score16= (p_adj<0.1)& (abs(log2_fc)>0.322) ) %>% 
#   mutate(score17= (p_adj<0.05)& (abs(log2_fc)>0.322) ) %>% 
#   mutate(score18= (p_value<0.05)& (abs(log2_fc)>0.3785)) %>% 
#   mutate(score19= (p_adj<0.25)& (abs(log2_fc)>0.3785)) %>% 
#   mutate(score20= (p_adj<0.20)& (abs(log2_fc)>0.3785) ) %>% 
#   mutate(score21= (p_adj<0.15)& (abs(log2_fc)>0.3785) ) %>% 
#   mutate(score22= (p_adj<0.1)& (abs(log2_fc)>0.3785) ) %>% 
#   mutate(score23= (p_adj<0.05)& (abs(log2_fc)>0.3785) ) %>% 
#   mutate(score24= (p_adj<0.25)& (abs(log2_fc)>0.3785)) %>% 
#   mutate(score25= (p_adj<0.20)& (abs(log2_fc)>0.3785) ) %>% 
#   mutate(score26= (p_adj<0.15)& (abs(log2_fc)>0.3785) ) %>% 
#   mutate(score27= (p_adj<0.1)& (abs(log2_fc)>0.3785) ) %>% 
#   mutate(score28= (p_adj<0.05)& (abs(log2_fc)>0.3785) ) 

# use the continues value to calculate correlation,
# use the binary value to calculate ROC-AUC.
# generate random predictions to form null distribution of ROC-AUCs.
# tmp4 <- full_join(
#   prism_drh_pred20, 
#   PISA_summary_augmented  %>% 
#     # filter(log2_fc<0) %>%
#     filter(exp_status==1) %>%
#     select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score23)
#   ,
#   by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
#   filter(!is.na(drug_name)) %>% 
#   nest_by(exp_id,drug_id, drug_name) %>% 
#   ungroup() %>% 
#   mutate(cor= map_dbl(.x = data,
#                       .f = function(df){cor(df$sup_pred_score, df$score, use = "complete.obs")})) %>%
#   mutate(cor1= map_dbl(.x = data,
#                       .f = function(df){cor(df$sup_pred_score, df$score1, use = "complete.obs")})) %>%
#   mutate(cor2= map_dbl(.x = data,
#                       .f = function(df){cor(df$sup_pred_score, df$score2, use = "complete.obs")})) %>%
#   mutate(cor3= map_dbl(.x = data,
#                       .f = function(df){cor(df$sup_pred_score, df$score3, use = "complete.obs")})) %>%
#   mutate(cor4= map_dbl(.x = data,
#                       .f = function(df){cor(df$sup_pred_score, df$score4, use = "complete.obs")})) %>%
#   mutate(cor5= map_dbl(.x = data,
#                       .f = function(df){cor(df$sup_pred_score, df$score5, use = "complete.obs")})) %>%
#   mutate(auc6= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score6), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc7= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score7), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc8= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score8), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc9= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score9), sup_pred_score, event_level = "second")$.estimate})) %>% 
#   mutate(auc10= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score10), sup_pred_score, event_level = "second")$.estimate})) %>% 
#   mutate(auc11= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score11), sup_pred_score, event_level = "second")$.estimate})) %>% 
#     mutate(auc12= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score12), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc13= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score13), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc14= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score14), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc15= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score15), sup_pred_score, event_level = "second")$.estimate})) %>% 
#   mutate(auc16= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score16), sup_pred_score, event_level = "second")$.estimate})) %>% 
#   mutate(auc17= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score17), sup_pred_score, event_level = "second")$.estimate})) %>% 
#     mutate(auc18= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score18), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc19= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score19), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc20= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score20), sup_pred_score, event_level = "second")$.estimate})) %>%  
#   mutate(auc21= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score21), sup_pred_score, event_level = "second")$.estimate})) %>% 
#   mutate(auc22= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score22), sup_pred_score, event_level = "second")$.estimate})) %>% 
#   mutate(auc23= map_dbl(.x = data, 
#                        .f = function(df){roc_auc(df, truth = as_factor(score23), sup_pred_score, event_level = "second")$.estimate})) %>% 
#%>% 
  # mutate(prauc6= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score6), sup_pred_score, event_level = "second")$.estimate})) %>%  
  # mutate(prauc7= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score7), sup_pred_score, event_level = "second")$.estimate})) %>%  
  # mutate(prauc8= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score8), sup_pred_score, event_level = "second")$.estimate})) %>%  
  # mutate(prauc9= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score9), sup_pred_score, event_level = "second")$.estimate})) %>% 
  # mutate(prauc10= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score10), sup_pred_score, event_level = "second")$.estimate})) %>% 
  # mutate(prauc11= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score11), sup_pred_score, event_level = "second")$.estimate})) %>% 
  #   mutate(prauc12= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score12), sup_pred_score, event_level = "second")$.estimate})) %>%  
  # mutate(prauc13= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score13), sup_pred_score, event_level = "second")$.estimate})) %>%  
  # mutate(prauc14= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score14), sup_pred_score, event_level = "second")$.estimate})) %>%  
  # mutate(prauc15= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score15), sup_pred_score, event_level = "second")$.estimate})) %>% 
  # mutate(prauc16= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score16), sup_pred_score, event_level = "second")$.estimate})) %>% 
  # mutate(prauc17= map_dbl(.x = data, 
  #                      .f = function(df){pr_auc(df, truth = as_factor(score17), sup_pred_score, event_level = "second")$.estimate}))
```


```{r}
PISA_summary_augmented= PISA_summary %>%
  mutate(exp_status= gene_symbol %in% exp_gene_c2) %>%
  # filter(exp_status==1) %>%
  mutate(score1= p_adj*abs(log2_fc)) %>%
  mutate(score2= (p_value<0.05) ) %>%
  mutate(score3= (p_value<0.01) ) %>%
  mutate(score4= (p_value<0.005) ) %>%
  mutate(score5= (p_value<0.001) ) %>%
  mutate(score6= (p_value<0.0001) ) %>%
  mutate(score7= (p_adj<0.25) ) %>%
  mutate(score8= (p_adj<0.20) ) %>%
  mutate(score9= (p_adj<0.15) ) %>%
  mutate(score10= (p_adj<0.1) ) %>%
  nest_by(exp_id,drug_id, drug_name) %>%
  ungroup() %>%
  mutate(data= map(.x= data,function(df){
      df_row <- nrow(df) 
      df %>% 
        arrange(desc(score)) %>% 
        mutate(score11= score>nth(score,n = 51)) %>% 
        mutate(score12= score>nth(score,n = 101)) %>%
        mutate(score13= score>nth(score,n = 201)) %>%
        mutate(score14= score>nth(score,n = 301)) %>%
        mutate(score15= score>nth(score,n = df_row*(0.01))) %>%
        mutate(score16= score>nth(score,n = df_row*(0.05))) %>%
        mutate(score17= score>nth(score,n = df_row*(0.1))) })) %>%
  unnest(data)
```

supervised prediction accuracy
```{r}
TMP <- PISA_summary_augmented  %>%
  select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
  # filter(exp_status==1) %>%
  full_join(prism_drh_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  filter(!is.na(drug_name)) %>%
  nest_by(exp_id,drugid, drug_name) %>%
  ungroup() %>% 
  mutate(res =map(data,function(df) {
    df <- df %>% 
      drop_na() %>% 
      select(score,score1:score17) %>% 
      summarise_all(sum)})) %>% 
  select(-data) %>% 
  unnest(res)
# summary(TMP)
# we can see when filter with a fixed threshold, supervised prediction is only prioritizing
# several of genes, the result of which is not persuasive

TMP1 <- PISA_summary_augmented  %>%
  select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
  filter(exp_status==1) %>%
  full_join(prism_unsupervised_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  filter(!is.na(drug_name)) %>%
  nest_by(exp_id,drugid, drug_name) %>%
  ungroup() %>% 
  mutate(res =map(data,function(df) {
    df <- df %>% 
      drop_na() %>% 
      select(score2:score17) %>% 
      summarise_all(sum)})) %>% 
  select(-data) %>% 
  unnest(res)
# summary(TMP1)
```


```{r}
# use the 30 binary columns as filter for spearman/pearson correlation.
# use nth to filter top PISA score and score 1 directly for spearman/pearson correlation.
tmp4 <- PISA_summary_augmented  %>%
  select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
  filter(exp_status==1) %>%
  full_join(prism_drh_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  filter(!is.na(drug_name)) %>%
  nest_by(exp_id,drugid, drug_name) %>%
  ungroup() %>% 
  mutate(cor= map_dbl(
    .x = data,
    .f = function(df){
      cor(df$sup_pred_score, df$score, use = "complete.obs",method = "pearson")})) %>%
  mutate(cor1= map_dbl(
    .x = data,
    .f = function(df){
      cor(df$sup_pred_score, df$score2, use = "complete.obs",method = "pearson")})) %>%
  mutate(cor2= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score2)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
               ) }
    )) %>%
  mutate(cor7= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score7)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
               ) }
    )) %>%
  mutate(cor8= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score8)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
               ) }
    )) %>% 
  mutate(cor13= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score13)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor14= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score14)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor15= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score15)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor16= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score16)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor17= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score17)
      tryCatch(
        expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
        error= function(err) NA
               ) }
    ))# %>% 
  # select(-data)
# summary(tmp4)
# tapply(tmp4$cor7, tmp4$exp_id, summary)
```
get pvalue
```{r}
tmp6 <- PISA_summary_augmented  %>%
  select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
  filter(exp_status==1) %>%
  full_join(prism_drh_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  filter(!is.na(drug_name)) %>%
  nest_by(exp_id,drugid, drug_name) %>%
  ungroup() %>% 
  mutate(cor_res= map(
    .x = data,
    .f = function(df){
      df= df %>% filter(score17)
      tryCatch(
        expr = 
          cor.test(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson") %>%
          tidy() %>% select(estimate, p.value,parameter) ,
        error= function(err) NA
               ) }
    )) %>% 
  select(-data) %>% 
  unnest(cor_res)

# with a very unstringent PISA threshold examined whether supervised pred recover PISA
# we found 3 drugs.
# Top drug.
```


```{r}
prism_drh_pred20_rdm_idx <- map(
  .x= 1:100,
  .f= function(x){
    seed=x
    ridx=sample(1:6020)
  }
  )

tmp4_rdm <- map(
  .x= 1:100,
  .f= function(x){
    idx <- prism_drh_pred20_rdm_idx[[x]]
    prism_drh_pred20_rdm <- prism_drh_pred20 %>% 
    mutate(sup_pred_score= prism_drh_pred20$sup_pred_score[idx])
    tmp4 <- PISA_summary_augmented  %>%
      select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
      filter(exp_status==1) %>%
      full_join(prism_drh_pred20_rdm, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
      filter(!is.na(drug_name)) %>%
      nest_by(exp_id,drugid, drug_name) %>%
      ungroup() %>% 
      mutate(cor= map_dbl(
        .x = data,
        .f = function(df){
          cor(df$sup_pred_score, df$score, use = "complete.obs",method = "pearson")})) %>%
      mutate(cor1= map_dbl(
        .x = data,
        .f = function(df){
          cor(df$sup_pred_score, df$score2, use = "complete.obs",method = "pearson")})) %>%
      mutate(cor2= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score2)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
                   ) }
        )) %>%
      mutate(cor7= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score7)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
                   ) }
        )) %>%
      mutate(cor8= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score8)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
                   ) }
        )) %>% 
      mutate(cor13= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score13)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
          ) }
      )) %>% 
      mutate(cor14= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score14)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor15= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score15)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
          ) }
      )) %>% 
      mutate(cor16= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score16)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
          ) }
      )) %>% 
      mutate(cor17= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score17)
          tryCatch(
            expr = cor(df$sup_pred_score, df$score, use = "complete.obs", method= "pearson"),
            error= function(err) NA
                   ) }
        )) %>% 
      select(-data)
    
    
  }              
                )
```


Unsupervised prediction
```{r}
tmp5 <- PISA_summary_augmented  %>%
  select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
  # filter(exp_status==1) %>%
  full_join(prism_unsupervised_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  filter(!is.na(drug_name)) %>%
  nest_by(exp_id,drugid, drug_name) %>%
  ungroup() %>% 
  mutate(cor= map_dbl(
    .x = data,
    .f = function(df){
      cor(df$unsup_pred_score, df$score, use = "complete.obs",method = "spearman")})) %>%
  mutate(cor1= map_dbl(
    .x = data,
    .f = function(df){
      cor(df$unsup_pred_score, df$score2, use = "complete.obs",method = "spearman")})) %>%
  mutate(cor2= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score2)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor3= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score3)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%  
  mutate(cor4= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score4)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor5= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score5)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor6= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score6)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor7= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score7)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor8= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score8)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor9= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score9)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor10= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score10)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%  
  mutate(cor11= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score11)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor12= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score12)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor13= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score13)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor14= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score14)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>%
  mutate(cor15= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score15)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor16= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score16)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>% 
  mutate(cor17= map_dbl(
    .x = data,
    .f = function(df){
      df= df %>% filter(score17)
      tryCatch(
        expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
        error= function(err) NA
      ) }
  )) %>% 
  select(-data)
summary(tmp5)
tapply(tmp5$cor11, tmp5$exp_id, summary) #top 50 pisa targets

tmp7 <- PISA_summary_augmented  %>%
  select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
  # filter(exp_status==1) %>%
  full_join(prism_unsupervised_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  filter(!is.na(drug_name)) %>%
  nest_by(exp_id,drugid, drug_name) %>%
  ungroup() %>% 
  mutate(cor_res= map(
    .x = data,
    .f = function(df){
      df= df %>% filter(score11)
      tryCatch(
        expr = 
          cor.test(df$unsup_pred_score, df$score, use = "complete.obs", method= "pearson") %>%
          tidy() %>% select(estimate, p.value,parameter) ,
        error= function(err) NA
               ) }
    )) %>% 
  select(-data) %>% 
  unnest(cor_res)
```

```{r}
tmp7 <- PISA_summary_augmented  %>%
  select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
  filter(exp_status==1) %>%
  full_join(prism_unsupervised_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  filter(!is.na(drug_name)) %>%
  nest_by(exp_id,drugid, drug_name) %>%
  ungroup() %>% 
  mutate(cor_res= map(
    .x = data,
    .f = function(df){
      df= df %>% filter(score15)
      tryCatch(
        expr = 
          cor.test(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman") %>%
          tidy() %>% select(estimate, p.value,parameter) ,
        error= function(err) NA
               ) }
    )) %>% 
  select(-data) %>% 
  unnest(cor_res)
```

with score 11, can unsupervised pred really correlated better with PISA better than the random?
generate 100 random prism_unsupervised_pred20
```{r}
prism_unsupervised_pred20_rdm <- map(
  .x= 1:100,
  .f= function(x){
    seed=x
    ridx=sample(1:212460)

  }
  )

# plan(multisession,workers=2)
tmp5_rdm <- map(
  .x= 1:100,
  # .options = furrr::furrr_options(seed=1),
  .f= function(df){
    df <- prism_unsupervised_pred20_rdm[[i]]
    res <-  PISA_summary_augmented  %>%
      select(exp_id,drug_name, gene_symbol, drugid,exp_status,score, score1:score17) %>% 
      # filter(exp_status==1) %>%
      full_join(df, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
      filter(!is.na(drug_name)) %>%
      nest_by(exp_id,drugid, drug_name) %>%
      ungroup() %>% 
      mutate(cor= map_dbl(
        .x = data,
        .f = function(df){
          cor(df$unsup_pred_score, df$score, use = "complete.obs",method = "spearman")})) %>%
      mutate(cor1= map_dbl(
        .x = data,
        .f = function(df){
          cor(df$unsup_pred_score, df$score2, use = "complete.obs",method = "spearman")})) %>%
      mutate(cor2= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score2)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor3= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score3)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor4= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score4)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor5= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score5)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor6= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score6)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor7= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score7)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor8= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score8)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor9= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score9)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor10= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score10)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor11= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score11)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor12= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score12)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor13= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score13)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor14= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score14)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor15= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score15)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor16= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score16)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      mutate(cor17= map_dbl(
        .x = data,
        .f = function(df){
          df= df %>% filter(score17)
          tryCatch(
            expr = cor(df$unsup_pred_score, df$score, use = "complete.obs", method= "spearman"),
            error= function(err) NA
          ) }
      )) %>%
      select(-data)
    
  }              
                )
# plan(sequential)
```



gene-level is not working well.
let's try pathway level instead

get pathway for pisa
```{r}
library(fgsea)

pathway_go <- gmtPathways("~/cluster_scratch/prior/c5.go.v7.4.symbols.gmt")
pathway_kegg <- gmtPathways("~/cluster_scratch/prior/c2.cp.kegg.v7.4.symbols.gmt")
prism_go <- read_csv("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/GO_df_prism.csv")
prism_kegg <- read_csv("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/pathways_df_prism.csv")

plan(multisession,workers=5)
PISA_pathway <- PISA_summary_augmented %>% 
   filter(exp_status==1) %>%
  select(exp_id,drug_name, drugid, gene_symbol, drugid,exp_status,score, score2,log10_p) %>% 
  filter(!is.na(drug_name)) %>% 
  nest_by(exp_id,drugid, drug_name) %>% 
  ungroup() %>% 
  mutate(kegg_scorebased =  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score) %>% drop_na()
      rank <- df$score
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_kegg, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)} )) %>% 
  mutate(kegg_score2based=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score2) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_kegg, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>%
  mutate(kegg_pbased=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,log10_p) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_kegg, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>%
  mutate(go_scorebased=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score) %>% drop_na()
      rank <- df$score
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_go, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>%
  mutate(go_score2based=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score2) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_go, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>% 
  mutate(go_score2based=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,log10_p) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_go, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)}))
plan(sequential)  
```


lets get the overlapping go and kegg pathways for ess_sig and pisa
```{r}
# n=319 for 16 drugs
prism_go <- prism_go %>% 
  filter(drug %in% PISA_pathway$drugid)

#n= 45 for 14 drugs 
prism_kegg <- prism_kegg %>% 
  filter(drug %in% PISA_pathway$drugid)
```


```{r}
# n= 1033 for 20 drugs
PISA_sig_GO <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, go_scorebased) %>%
  unnest(go_scorebased) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(padj<0.05) %>%
  inner_join(prism_go %>% select(drug, pathway),
                   by=c("drugid"="drug", "pathway"="pathway"))
# n= 205 for 20 drugs
PISA_sig_KEGG <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, kegg_scorebased) %>%
  unnest(kegg_scorebased) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(pval<0.05) %>%
  inner_join(prism_kegg %>% select(drug, pathway),
                   by=c("drugid"="drug", "pathway"="pathway"))


PISA_sig_GO2 <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, go_score2based) %>%
  unnest(go_score2based) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(padj<0.05) %>% 
  inner_join(prism_go %>% select(drug, pathway), 
                   by=c("drugid"="drug", "pathway"="pathway"))

PISA_sig_KEGG2 <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, kegg_score2based) %>%
  unnest(kegg_score2based) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(padj<0.05) %>% 
  inner_join(prism_kegg %>% select(drug, pathway), 
                   by=c("drugid"="drug", "pathway"="pathway"))
```

save an RData for Jing
```{r}
supervised_pred <- prism_drh_pred20
unsupervised_pred <- prism_unsupervised_pred20
PISA <- PISA_summary %>% 
  mutate(exp_status= gene_symbol %in% exp_gene_c2)
PISA_supervised <- tmp4 
PISA_unsupervised <- tmp5
save(supervised_pred,unsupervised_pred, PISA, PISA_supervised,PISA_unsupervised, 
     file = "~/cluster_wrk/drug_moa/noncancer_drug_validation/res_to_Jing.RData")
```



```{r}
# train_consen_sig <- bind_rows(
#     feature_imp_ridge_prism_comb1 %>%
#       filter(drug %in% prism_good_fitted_drugs_drhannotated) %>%
#       arrange(drug),
# 
#     feature_imp_ridge_prism_comb1 %>%
#       filter(drug %in% prism_good_fitted_nononcologydrugs) %>%
#       arrange(drug)
# )
# 
# train_cor_mat <- cor(t(train_consen_sig %>% select(-drug)))
# colnames(train_cor_mat) <- train_consen_sig$drug
# row.names(train_cor_mat) <- train_consen_sig$drug
# target_mat_268 <- get_target_mat(
#   target_tibble = prism_target_binary %>%
#     filter(drug %in% prism_good_fitted_drugs_drhannotated) %>%
#     arrange(drug))
# 
# pred_63_supervised <- no_tunning_weighted_averaging(
#   target_mat = target_mat_268,
#   cor_mat = train_cor_mat,
#   test_idx = 269:331,pred_new = T)
# pred_63_supervised <- t(pred_63_supervised)
# 
# pred_268_supervised <- map_dfc(
#   .x = 1:268,
#   .f = ~no_tunning_weighted_averaging(
#     target_mat = target_mat_268,
#     cor_mat = train_cor_mat[1:268,1:268],
#     test_idx = .x,
#     pred_all = T)
#   )
# # pred_268_supervised <- t(pred_268_supervised)
# 
# colnames(pred_268_supervised) <- row.names(target_mat_268)
# rownames(pred_268_supervised) <-colnames(target_mat_268)
```


```{r}
# pred_58_supervised <- 
#   tibble(
#     target= colnames(pred_58_supervised),
#     as.data.frame(t(pred_58_supervised))
#   ) %>%
#   arrange(target)
# 
# colnames(pred_58_supervised )[2:59] <-  sort(prism_good_fitted_nononcologydrugs)

# write_csv(pred_58_supervised, "~/cluster_wrk/drug_moa/pred_58_supervised.csv")
# also write out the unsupervised prediction for the 58 drugs
# pred_58_unsupervised <- feature_imp_ridge_prism_comb1 %>% 
#   filter(drug %in% prism_good_fitted_nononcologydrugs) %>% 
#   pivot_longer(-drug, names_to= "target", values_to= "pred") %>% 
#   pivot_wider(id_cols = target, names_from= drug, values_from= pred)
# write_csv(pred_58_unsupervised, "~/cluster_wrk/drug_moa/pred_58_unsupervised.csv")
```


The following analysis asked by Jing in answering Krister's question
```{r}
# cor_df_predicted_target <- 
#   cor(pred_268_supervised, use = "pairwise.complete.obs", method = "spearman") %>%
#   as_tibble() %>% 
#   mutate(drug1=row.names(target_mat_268)) %>%
#   pivot_longer(cols = -drug1,names_to= "drug2") %>% 
#   arrange(drug1, drug2)
# 
# cor_df_unpred_target <- 
#   train_cor_mat[1:268,1:268] %>% 
#   as_tibble() %>% 
#   mutate(drug1=row.names(target_mat_268)) %>%
#   pivot_longer(cols = -drug1,names_to= "drug2") %>% 
#   arrange(drug1, drug2)
# 
# 
# cor_df_sen <- prism_data %>% filter(BROAD_ID %in% row.names(target_mat_268)) %>% 
#   select(BROAD_ID, sensitivity) %>% 
#   unnest(sensitivity) %>% 
#   select(-ec50) %>% 
#   drop_na() %>% 
#   pivot_wider(id_cols = depmap_id,names_from= BROAD_ID, values_from=auc) %>% 
#   select(-depmap_id) %>% 
#   cor(use = "pairwise.complete.obs",method = "spearman") 
# 
# colnames(cor_df_sen) <- row.names(cor_df_sen)
# cor_df_sen <- as_tibble(cor_df_sen)  %>% 
#   # rowid_to_column()
#   mutate(drug1= row.names(cor_df_sen)) %>% 
#   pivot_longer(cols = -drug1,names_to= "drug2") %>% arrange(drug1,drug2)
# 
# tmp <- inner_join(cor_df_predicted_target,cor_df_sen,by=c("drug1", "drug2")) 
# fig1 <- tmp %>% 
#   ggplot(aes(x=value.x, y=value.y)) +
#   geom_point(size=0.2)+
#   xlab("Supervised prediction target similiarity")+
#   ylab("Sensitivity similiarity")+
#   theme_classic()
#   # ggtitle("COR 0.74, p<2.2e-16")
# # cor.test(tmp$value.x, tmp$value.y) 
# 
# tmp1 <- inner_join(cor_df_unpred_target,cor_df_sen,by=c("drug1", "drug2")) 
# fig2 <- tmp1 %>% 
#   ggplot(aes(x=value.x, y=value.y)) +
#   geom_point(size=0.2)+
#   xlab("Unsupervised prediction target similiarity")+
#   ylab("Sensitivity similiarity")+
#   theme_classic()
#   # ggtitle("COR 0.88, p<2.2e-16")
#   
# # cor.test(tmp1$value.x, tmp1$value.y)
# fig1 
# fig2
# setwd("~/cluster_wrk/drug_moa/predicting_prism/fig_res")
# ggsave(filename = "figs3.tiff",plot = fig1,device = "tiff",width = 10,height = 10,units = "cm")
# ggsave(filename = "figs4.tiff",plot = fig2,device = "tiff",width = 10,height = 10,units = "cm")
```



Combine the incorrectly predicted drugs and drugs without target info together
include the average sensitivity (perhaps also the number of sensitive cell lines)
as an indicator.

Think about how accurate is accurate? for an AUC of 0.8 /0.9 is quite high but the
putative target is still not the top one prediction.

now we have both supervised and unsupervised prediction accuracy! Despite there are some 
NA due to the lack of cover of existing target from ConSen-sig gene. 
(only 8 drugs so not so worrying)

report statistics in the manuscript
```{r}
# get_auc_mean <- function(df){mean(df$auc, na.rm = T)}
# get_auc_variance <- function(df){sd(df$auc, na.rm = T)}
# get_nub_sencell <- function(df,thre){sum(df$auc<thre, na.rm = T)}
# Sen_sum <- prism_data %>% 
#   select(BROAD_ID, sensitivity) %>% 
#   mutate(
#     sen_mean=map_dbl(.x = sensitivity, .f = get_auc_mean),
#     sen_sd=map_dbl(.x = sensitivity, .f = get_auc_variance),
#     nub_sencell_0.8=map_dbl(.x = sensitivity, .f = ~get_nub_sencell(df = .x, thre = 0.8)),
#     nub_sencell_0.7=map_dbl(.x = sensitivity, .f = ~get_nub_sencell(df = .x, thre = 0.7))
#          ) %>% 
#   select(-sensitivity)
```


for non-oncology drugs listed in the 305 prism
```{r}
# prism_good_fitted_nononcologydrugs_notannotated_df <- prism_sc_drug %>% 
#   filter(broad_id %in% setdiff(prism_good_fitted_drugs, prism_good_fitted_drugs_annotated)) %>% 
#   filter(drug_category== "noncancer") %>% 
#   inner_join(
#     prism_data %>% 
#       select(-target, - sensitivity, -moa, -drug_category), by=c("broad_id"= "BROAD_ID") 
#     ) %>% 
#   mutate(acc=NaN) %>% 
#   mutate(auc=NaN) %>% 
#   mutate(target=NA) %>% 
#   # rename(drug_category=Drug_category) %>% 
#   rename(drug=broad_id)
# 
# 
# prism_good_fitted_nononcologydrugs_annotated_df <- prism_268_all %>% 
#   filter(drug_category=="noncancer") %>% 
#   select(-Drug_category) %>% 
#   select(-test_idx) %>% 
#   left_join(prism_sc_drug %>% select(broad_id, target), by= c("drug" = "broad_id")) 
# 
# prism_nononcology_df <- union(prism_good_fitted_nononcologydrugs_notannotated_df,
#                               prism_good_fitted_nononcologydrugs_annotated_df) %>% 
#   inner_join(Sen_sum,by=c("drug"= "BROAD_ID")) %>% 
#   # inner_join(bimodality ,by="drug") %>% 
#   select(-drug_category, -smiles) %>% 
#   relocate(name)
```


```{r}
# get the combined table for 58 nononcology drugs

# get_top_n_target <- function(pred_tibble, res_type="short_table", n_pred= 5){
#   
#   tmp <- pred_tibble %>% 
#     pivot_longer(cols = -target, values_to= "pred", names_to= "drug") %>% 
#     group_by(drug) %>% 
#     slice_max(order_by = pred, n= n_pred) %>% 
#     ungroup() %>% 
#     select(-pred)
#     
#   tmp1 <- tmp %>% 
#     group_by(drug) %>%
#     summarise(target=paste(target,collapse = ",")) %>% 
#     ungroup() 
#   
#   if (res_type== "long_table"){return(tmp)}
#   if (res_type== "short_table"){return(tmp1)}
#   
# }
# 
# 
# # supervised_top5 <- get_top_n_target(pred_tibble = pred_58_supervised)
# # unsupervised_top5 <- get_top_n_target(pred_tibble = pred_58_unsupervised)
# # 
# # prism_nononcology_df <- prism_nononcology_df %>% 
# #   inner_join(supervised_top5 %>% rename(supervised_target= target)) %>% 
# #   inner_join(unsupervised_top5 %>% rename(unsupervised_target= target)) %>% 
# #   inner_join(bimodality_df, by=c("drug"= "BROAD_ID")) %>% 
# #   rename(putative_target=target) %>% 
# #   rename(supervised_pred_accuracy= acc) %>% 
# #   rename(unsupervised_pred_accuracy= auc) 
# # write_csv(prism_nononcology_df, "prism_nononcology_df.csv")  
```

plot the sensitivity distributions for the 58 drugs!
```{r,fig.width=10,fig.height=1.5}
# plot_hist_sen <- function(drug_id, add_title= T){
#   df <- prism_data %>% 
#     filter(BROAD_ID %in%  drug_id) %>% 
#     pull(sensitivity)
# 
#   df <- df[[1]]
#   
#   fig <- df %>% 
#     ggplot() +
#     geom_histogram(aes(x= auc),binwidth = 0.02)
#   
#   if (add_title== T){
#     title <- prism_nononcology_df %>% 
#     filter(drug==drug_id) %>% select(drug, name, bi_coef) %>% 
#     mutate(bi_coef= round(bi_coef,digits = 3)) %>% 
#     unlist() %>% paste(collapse = ";")
#    fig <- fig+ ggtitle(title)
#   }
#   return(fig)
# }
# 
# # plot_hist_sen(drug_id = "BRD-K37865504") 
# # plot_hist_sen(drug_id = "BRD-K72815923")+xlim(c(0,2.4))
# plot_hist_sen(drug_id = "BRD-K69726342")+xlim(c(0,2.2))
# # for (drug in prism_good_fitted_nononcologydrugs){
# #   fig <- plot_hist_sen(drug_id = drug)
# #   ggsave(
# #     device = "tiff",
# #     plot = fig,
# #     # width = 3,
# #     # height = 3,
# #     filename = paste("~/cluster_wrk/drug_moa/predicting_prism/fig_sen_distribution/", drug, ".tiff",collapse = "",sep="")
# #   )
# #   }
```

