---
title: "Non-oncology drug validation"
output: html_notebook
---

```{r }
# knitr::opts_chunk$set(echo = TRUE)
library(furrr)
library(tidyverse)
library(ggsci)
```


```{r}
load("~/cluster_scratch/forward_modelling/targetpred_output_simplefiltering.RData")
rm(get_target_mat)
rm(no_tunning_weighted_averaging)
rm(get_target_pred_accuracy_batch)
rm(return_acc_estimate_cv)
# note the unsupervised auc is precalculated in get_unsupervised_target_prediction_auc.R code
```


```{r}
load("~/cluster_scratch/unsupervised_target_pred/unsupervised_target_pred_ConSenSig.RData")

cell_line_info <- data.table::fread("~/cluster_scratch/depmap_21q1/sampleinfo")
targetpanel_dtc <- data.table::fread("~/cluster_scratch/prior/DTC_data_all.csv",
                                 select = c("gene_names")) %>% distinct() %>% pull(gene_names)

cell_line_info <- data.table::fread("~/cluster_scratch/depmap_21q1/sampleinfo")

targetpanel_drh <- read_tsv("~/cluster_scratch/prior/repurposing_drugs_20200324.txt") %>% 
  select(-disease_area, -indication) %>% 
  drop_na() %>% 
  separate_rows(target) %>% 
  distinct() 

targetpanel_drh_genelevel <- targetpanel_drh %>% 
  select(pert_iname, target) %>% 
  group_by(target) %>% 
  summarise(drug= paste(pert_iname,collapse = ","))
cellline_hgsoc <- cell_line_info %>% 
  filter(primary_disease== "Ovarian Cancer") %>% 
  filter(Subtype== "Adenocarcinoma, high grade serous")
```


```{r}
res_prism2_long <- res_prism2
res_prism2 <- res_prism2_long %>%
  select(-variance) %>% 
  filter(.metric== "spearman coef") %>%
  pivot_wider(names_from = input, values_from= estimate) %>%
  mutate(acc_sen= (ceres+ces+demeter2)/3) %>%
  distinct() 
prism_good_fitted_drugs <- res_prism2 %>%
  filter(sample_size>100) %>%
  filter(acc_sen>0.2) %>%
  arrange(BROAD_ID)
# n=312, 199 targeted cancer drugs, 50 chemo drugs and 63 noncancer drugs.

# how many non-oncology drugs? N= 63
prism_good_fitted_nononcologydrugs <-  prism_good_fitted_drugs %>% 
  filter(drug_category== "noncancer") %>% 
  arrange(BROAD_ID ) %>% 
  pull(BROAD_ID) %>% 
  unique()


# drh annotation include both MOA and target info N=268, this will be my train set
prism_good_fitted_drugs_drhannotated <- prism_good_fitted_drugs %>% 
  select(BROAD_ID, moa) %>% 
  drop_na() %>% 
  filter(BROAD_ID %in% prism_target_binary$drug) %>% 
  pull(BROAD_ID)
  
# DTC only care about target gene but not moa annotation: N= 52
prism_good_fitted_drugs_dtcannotated <- prism_good_fitted_drugs %>% 
  filter(BROAD_ID %in% prism_target_dtc$drug) %>% 
  pull(BROAD_ID)

# 46 = 58-13 +1 1 drug no moa but have target.
# prism_good_fitted_nononcologydrugs_drhannotated <- intersect(prism_good_fitted_drugs_drhannotated, prism_good_fitted_nononcologydrugs)
# 
# prism_good_fitted_nononcologydrugs_drhnotannotated <- setdiff(prism_good_fitted_drugs_drhannotated, prism_good_fitted_nononcologydrugs)

# prism_good_fitted_nononcologydrugs <-  prism_good_fitted_drugs %>% 
#   filter(drug_category== "noncancer") %>% 
#   arrange(BROAD_ID ) %>% 
#   filter(is.na(moa))

save(list = c("prism_data", "prism_target_binary", "prism_target_dtc"), file= "./fig_res/putative_targetinfo.RData")
```

get hgsoc sensitivity for all 63 noncancer drugs
```{r}
prism_63_sen <- prism_data %>% 
  filter(BROAD_ID %in%  prism_good_fitted_nononcologydrugs) %>% 
  select(BROAD_ID ,sensitivity) %>% 
  unnest(cols=sensitivity) %>% 
  drop_na()


# list auc of HGSOC, and the number of sen HGSOC cells for that drugs
prism_63_sen_hgsoc <- full_join(
    x= prism_63_sen %>% filter(depmap_id %in% cellline_hgsoc$DepMap_ID),
    y= cellline_hgsoc %>% select(DepMap_ID, cell_line_name), 
    by=c("depmap_id"= "DepMap_ID")
  ) %>% 
  select(-ec50) %>% 
  # filter(auc< 0.8) %>%
  group_by(BROAD_ID) %>% 
  summarise(n_total= n(),n_0.8= sum(auc<0.8)  ) %>% 
  drop_na() %>% 
  ungroup() %>% 
  full_join(
  y = prism_63_sen %>% filter(depmap_id == "ACH-000524")
    )
# write_csv(prism_63_sen_hgsoc, path = "~/cluster_wrk/drug_moa/predicting_prism/prism_63_sen_hgsoc.csv")

# tmp <- prism_data %>% filter(BROAD_ID %in% prism_good_fitted_nononcologydrugs) %>% 
#   filter(!(BROAD_ID  %in% prism_good_fitted_drugs_drhannotated )) %>%  select(BROAD_ID, moa)
```



Now use the 268 drugs as the training set to predict the targets for the drugs of interest
```{r}
# source("~/cluster_wrk/drug_moa/supervised_target_pred/function/get_target_pred_supervised.R")
# source('~/cluster_wrk/drug_moa/supervised_target_pred/function/return_acc_estimate_loocv.R')
# prism_drh_predictions <- get_predictions(
#   sig_data=feature_imp_ridge_prism_comb1,
#   train_drugs=prism_good_fitted_drugs_drhannotated,
#   pred_drugs=prism_good_fitted_drugs$BROAD_ID, 
#   train_label= prism_target_binary) %>% 
#   as_tibble(rownames= "target")
# 
# prism_unsupervised <- feature_imp_ridge_prism_comb1 %>% 
#   filter(drug %in% prism_good_fitted_drugs$BROAD_ID) %>% 
#   pivot_longer(-drug, names_to= "target", values_to= "pred") %>% 
#   pivot_wider(id_cols = target, names_from= drug, values_from= pred)
# 
# setwd("~/cluster_wrk/drug_moa/predicting_prism")
# write_csv(prism_drh_predictions, "./fig_res/prism312_drh_predictions.csv")
# write_csv(prism_unsupervised,path = "./fig_res/prism312_unsupervised.csv")
```
y

```{r}
rm(list= ls())
load("./fig_res/putative_targetinfo.RData")
prism_drh_predictions <- read_csv("../predicting_prism/fig_res/prism312_drh_predictions.csv")
prism_unsupervised <- read_csv("../predicting_prism/fig_res/prism312_unsupervised.csv")

senvalid_20drugs <- read_csv("../predicting_prism/fig_res/res_final.csv")
PISA_summary <- read_csv( "~/cluster_wrk/sen_tar_validation/data/inputdata/pisa_summary.csv")

# intersect(senvalid_20drugs$Drug_name, unique(PISA_summary$drug_name) )
# setdiff(senvalid_20drugs$Drug_name, unique(PISA_summary$drug_name))
# setdiff(unique(PISA_summary$drug_name),senvalid_20drugs$Drug_name)

PISA_summary <- PISA_summary %>% 
  janitor::clean_names() %>% 
  select(-one_of(c("biological_process", "cellular_component", "molecular_function"))) %>% 
  filter(!is.na(gene_symbol))%>%  
  inner_join(senvalid_20drugs %>% select(Drug_name, drugid),  by=c("drug_name"="Drug_name")) %>% 
  group_by(drugid, drug_name, gene_symbol) %>%
  slice_min(p_value) %>%
  ungroup() %>% 
  mutate(p_adj=p.adjust(p_value, method = "fdr")) %>% 
  mutate(log10_padj= -log10(p_adj))

cor(PISA_summary$log10_padj, PISA_summary$log10_p,use = "complete.obs")

hist(PISA_summary$log2_fc)
hist(PISA_summary$log10_p)
hist(PISA_summary$log10_padj)

prism_drh_pred20 <- prism_drh_predictions %>% 
  select(one_of(c("BROAD_ID", senvalid_20drugs$drugid))) %>% 
  pivot_longer(cols= 2:21,names_to="drug_id", values_to="sup_pred_score") %>% 
  rename(target=BROAD_ID)

prism_unsupervised_pred20 <- prism_unsupervised %>% 
  select(one_of(c("target", senvalid_20drugs$drugid))) %>% 
  pivot_longer(cols= 2:21,names_to="drug_id", values_to="unsup_pred_score")
```


```{r}
# log2(TPM+1) psedo count
exp_seq_kuramochi <- read_csv("~/cluster_scratch/ces_21q1_io/exp_seq_tidy.csv") %>% 
  filter(DepMap_ID== 'ACH-000524') %>% 
  pivot_longer(cols = - DepMap_ID, names_to= "gene", values_to="exp_tpm_rsem") 

exp_seq_kuramochi %>% 
  filter(gene %in% unique(PISA_summary$gene_symbol)) %>% 
  ggplot()+
  geom_histogram(aes(exp_tpm_rsem))+
  xlab("log2(TPM+1)")
exp_gene_c2 <- exp_seq_kuramochi%>% 
  filter(exp_tpm_rsem>2) %>% 
  pull(gene)
```

Check PISA result with expression
```{r}
# filter out the non expressing genes from PISA as they are false positive result.
# use threshold 2 for log2(TPM+1) play with this threshold to get better results.

# in general pisa result is not correlated with gene expression
inner_join(exp_seq_kuramochi, PISA_summary, by=c("gene"= "gene_symbol")) %>% 
  nest_by(drug_name, drugid) %>% 
  ungroup() %>% 
  mutate(cor= map_dbl(.x = data, 
                      .f = function(df){cor(df$exp_tpm_rsem, df$score, use = "complete.obs")})) %>% 
  select(-data) %>%
  mutate(cor= round(cor,2)) %>% 
  arrange(desc(cor)) %>% 
  View()

#however there is still false positive result which should be removed.

inner_join(exp_seq_kuramochi,  <- , by=c("gene"= "gene_symbol")) %>% 
  mutate(exp_status= (exp_tpm_rsem>2)) %>% 
  ggplot(aes(exp_status, log10(score)))+
  geom_violin()+
  ggpubr::stat_compare_means(method = "t.test")
```


check whether PISA result recapulate putative targets
```{r}
pisa_drh <- prism_target_binary %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol"))

t.test(pisa_drh$score, PISA_summary$score)

prism_target_binary %>% 
  mutate(binding_score=1) %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  right_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= !(is.na(binding_score))) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
 
pisa_dtc <- prism_target_dtc %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol"))

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

pisa_dtc %>% 
  drop_na() %>% 
  ggplot(aes(score, binding_score))+
  geom_point()+
  ylab("dtc_score")+
  xlab("pisa_score")

# only one drug are widely avaliable BMS-387032

prism_target_dtc %>% 
  filter(drug == "BRD-K43389698") %>%
  # filter(drug %in% pisa_dtc$drug) %>%  
  right_join(PISA_summary, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= case_when(binding_score>0.4~ "yes",
                             (binding_score <= 0.4)|(is.na(binding_score))~ "no")) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "kendall")

# whether the primary targets are  prioritized in PISA result
# cannot do enrichment analysis since there are too little
```

what if I filter out false positive PISA result?
```{r}
PISA_summary_expfiltered <- PISA_summary %>% filter(gene_symbol %in% exp_gene_c2) 
pisa_drh <- prism_target_binary %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol"))

t.test(pisa_drh$score, PISA_summary_expfiltered$score)

prism_target_binary %>% 
  mutate(binding_score=1) %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  right_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= !(is.na(binding_score))) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")
  
pisa_dtc <- prism_target_dtc %>% 
  filter(drug %in% prism_drh_pred20$drug_id) %>% 
  left_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol"))

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

pisa_dtc %>% 
  drop_na() %>% 
  ggplot(aes(score, binding_score))+
  geom_point()+
  ylab("dtc_score")+
  xlab("pisa_score")

# only one drug are widely avaliable BMS-387032

prism_target_dtc %>% 
  filter(drug == "BRD-K43389698") %>%
  # filter(drug %in% pisa_dtc$drug) %>%  
  right_join(PISA_summary_expfiltered, by= c("drug"="drugid", "target"= "gene_symbol")) %>% 
  mutate(putative= case_when(binding_score>0.4~ "yes",
                             (binding_score <= 0.4)|(is.na(binding_score))~ "no")) %>% 
  ggplot(aes(putative, log10(score)))+
  geom_boxplot()+
  ggpubr::stat_compare_means(method = "t.test")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "pearson")

cor.test(pisa_dtc$score, pisa_dtc$binding_score, use="complete.obs", method = "kendall")
```


```{r}
# tmp <- full_join(
#   prism_drh_pred20, 
#   PISA_summary  %>% 
#     select(drug_name, gene_symbol, drugid, score),
#   by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
#   filter(!is.na(drug_name)) %>% 
#   nest_by(drug_id, drug_name) %>% 
#   ungroup() %>% 
#   mutate(cor= map_dbl(.x = data, 
#                       .f = function(df){
#                         df= df %>% filter(_c2)
#                         cor(df$sup_pred_score, df$score, use = "complete.obs")}))
# 
# tmp1 <- full_join(
#   prism_unsupervised_pred20, 
#   PISA_summary  %>% 
#     select(drug_name, gene_symbol, drugid, score),
#   by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
#   filter(!is.na(drug_name)) %>% 
#   nest_by(drug_id, drug_name) %>% 
#   ungroup() %>% 
#   mutate(cor= map_dbl(.x = data, 
#                       .f = function(df){
#                         df= df %>% filter(exp_gene_c2)
#                         cor(df$unsup_pred_score, df$score, use = "complete.obs")}))
# 
# 
# tmp2 <- full_join(
#   prism_drh_pred20, 
#   PISA_summary_expfiltered  %>% 
#     # filter(log2_fc>0) %>%
#     select(drug_name, gene_symbol, drugid, score)
#   ,
#   by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
#   filter(!is.na(drug_name)) %>% 
#   nest_by(drug_id, drug_name) %>% 
#   ungroup() %>% 
#   mutate(cor= map_dbl(.x = data, 
#                       .f = function(df){cor(df$sup_pred_score, df$score, use = "complete.obs")}))
# 
# tmp2_filtered <- full_join(
#   prism_drh_pred20, 
#   PISA_summary_expfiltered  %>% 
#     filter(log2_fc>0) %>%
#     select(drug_name, gene_symbol, drugid, score)
#   ,
#   by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
#   filter(!is.na(drug_name)) %>% 
#   nest_by(drug_id, drug_name) %>% 
#   ungroup() %>% 
#   mutate(cor= map_dbl(.x = data, 
#                       .f = function(df){cor(df$sup_pred_score, df$score, use = "complete.obs")}))
# 
# tmp3 <- full_join(
#   prism_unsupervised_pred20, 
#   PISA_summary_expfiltered  %>% 
#         filter(log2_fc>0) %>% 
#     select(drug_name, gene_symbol, drugid, score),
#   by=c("drug_id"="drugid", "target"="gene_symbol")) %>% 
#   filter(!is.na(drug_name)) %>% 
#   nest_by(drug_id, drug_name) %>% 
#   ungroup() %>% 
#   mutate(cor= map_dbl(.x = data, 
#                       .f = function(df){cor(df$unsup_pred_score, df$score, use = "complete.obs")}))
```

Whether the top predicted targets are prioritized in the pisa result vector?
```{r}
# # generate pathway object
# generate_pathway <- function(df= prism_drh_pred20, gene_number= 30){
#   
#   res <- df %>% 
#   rename("score"=ends_with("score")) %>% 
#   group_by(drug_id) %>% 
#   slice_max(n= gene_number,order_by=score) %>% 
#   ungroup() %>% 
#   select(drug_id, target) %>% 
#   nest_by(drug_id,.key= "genelist") %>% ungroup() %>% 
#   mutate(genelist= map(.x = genelist, ~.x$target)) 
#   res1 <- res$genelist
#   names(res1) <- res$drug_id
# 
#   candidate_gene <- df %>% 
#     select(target) %>% 
#     distinct() %>% 
#     pull(target)
#   res2 <- map(1:100, function(i){
#     set.seed(i)
#     res= sample(candidate_gene, size = gene_number)
#     return(res)} )
#   names(res2) <- paste("geneset_rdm", 1:100, sep= "_")
#   res3 <- c(res1, res2)
#   return(res3)
# }
# 
# # generate 99 random pathways to be shared for all the drugs
# # the total number of pathways for each drug will be 101.
# prism_drh_pred20_pathway50 <- generate_pathway(prism_drh_pred20, 50)
# prism_unsupervised_pathway50 <- generate_pathway(prism_unsupervised_pred20, 50)
# 
# save.image("~/cluster_wrk/drug_moa/noncancer_drug_validation/tmp.RData")
# library(future)
# plan(multisession)
# res2 <- tmp %>%
#   mutate(pathway_res=
#            furrr::future_map(
#              .x= data,
#              .f= function(df){
#                 df <- df %>% select(c(1,3)) %>% drop_na()
#                 rank <- df %>% pull(2)
#                 names(rank) <-  df %>% pull(1)
#                 # pathway= 
#                 fgseaRes <- fgsea(prism_drh_pred20_pathway50, rank,scoreType = "pos")
#                 fgseaRes <- fgseaRes %>% arrange(pval)
#                 return(fgseaRes)}
#              ,
#              .options = furrr::furrr_options(seed = TRUE)
#              ))
# 
# plan(sequential)
# res2_flat <- res2 %>% select(-data) %>% unnest(pathway_res) %>% 
#   mutate(matched_pathway= (drug_id==pathway)
# 
# res2_flat %>% 
#   ggplot(aes(matched_pathway, ES))+
#   geom_boxplot()+
#   ggpubr::stat_compare_means(method = "t.test")
#          
# 
# plan(multisession)
# res3 <- tmp %>%
#   mutate(pathway_res=
#            furrr::future_map(
#              .x= data,
#              .f= function(df){
#                 df <- df %>% select(c(1,3)) %>% drop_na()
#                 rank <- df %>% pull(2)
#                 names(rank) <-  df %>% pull(1)
#                 fgseaRes <- fgsea(prism_unsupervised_pathway50, rank,scoreType = "pos")
#                 fgseaRes <- fgseaRes %>% arrange(pval)
#                 return(fgseaRes)}
#              ,
#              .options = furrr::furrr_options(seed = TRUE)
#              ))
# plan(sequential)
# 
# res3_flat <- res3 %>% select(-data) %>% unnest(pathway_res) %>% 
#   mutate(matched_pathway= (drug_id==pathway))
# 
# res3_flat %>% 
#   ggplot(aes(matched_pathway, ES))+
#   geom_boxplot()+
#   ggpubr::stat_compare_means(method = "t.test")
# 
# plan(multisession)
# res4 <- tmp2 %>%
#   mutate(pathway_res=
#            furrr::future_map(
#              .x= data,
#              .f= function(df){
#                 df <- df %>% select(c(1,3)) %>% drop_na()
#                 rank <- df %>% pull(2)
#                 names(rank) <-  df %>% pull(1)
#                 # pathway= 
#                 fgseaRes <- fgsea(prism_drh_pred20_pathway50, rank,scoreType = "pos")
#                 fgseaRes <- fgseaRes %>% arrange(pval)
#                 return(fgseaRes)}
#              ,
#              .options = furrr::furrr_options(seed = TRUE)
#              ))
# 
# plan(sequential)
# res4_flat <- res4 %>% select(-data) %>% unnest(pathway_res) %>% 
#   mutate(matched_pathway= (drug_id==pathway))
# 
# res4_flat %>% 
#   ggplot(aes(matched_pathway, ES))+
#   geom_boxplot()+
#   ggpubr::stat_compare_means(method = "t.test")
#          
# 
# plan(multisession)
# res5 <- tmp2 %>%
#   mutate(pathway_res=
#            furrr::future_map(
#              .x= data,
#              .f= function(df){
#                 df <- df %>% select(c(1,3)) %>% drop_na()
#                 rank <- df %>% pull(2)
#                 names(rank) <-  df %>% pull(1)
#                 fgseaRes <- fgsea(prism_unsupervised_pathway50, rank,scoreType = "pos")
#                 fgseaRes <- fgseaRes %>% arrange(pval)
#                 return(fgseaRes)}
#              ,
#              .options = furrr::furrr_options(seed = TRUE)
#              ))
# plan(sequential)
# 
# res5_flat <- res5 %>% select(-data) %>% unnest(pathway_res) %>% 
#   mutate(matched_pathway= (drug_id==pathway))
# 
# res5_flat %>% 
#   ggplot(aes(matched_pathway, ES))+
#   geom_boxplot()+
#   ggpubr::stat_compare_means(method = "t.test")
```


```{r}
PISA_summary_augmented= PISA_summary %>%
  mutate(exp_status= gene_symbol %in% exp_gene_c2) %>%
  mutate(score1= log10_p*abs(log2_fc)) %>% 
  mutate(score2= log10_p) %>%
  mutate(score3= abs(log2_fc)) %>% 
  select(exp_id:gene_symbol,drugid,p_value,p_adj, exp_status,score1:score3) %>% 
  full_join(prism_drh_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
  full_join(prism_unsupervised_pred20, by=c("drugid"="drug_id", "gene_symbol"="target")) %>% 
  filter(!is.na(exp_id))

PISA_summary_augmented_drug_level <- PISA_summary_augmented %>% 
  nest_by(drug_id,drug_name,drugid, exp_id) %>% 
  ungroup()
```



evaluate sample number
```{r}
# list the number of observations for all the drugs under different threshold
cor_res_num_sup <- tibble(score_type=1:3) %>% 
  mutate(res= map(
  .x=1:3, 
  .f= function(x){
    # x=1
    df= PISA_summary_augmented %>% 
      select(exp_id, drug_name, drug_id, gene_symbol,exp_status,p_value,one_of(paste0("score", x)),"sup_pred_score")
    colnames(df)[which(colnames(df)==(paste0("score", x)))] <- "score"
  
    df1 <- df %>% 
      nest_by(exp_id,drug_id, drug_name) %>%
      ungroup() %>%
      mutate(data= map(
        .x= data,
        .f = function(df2){
          df_row <- nrow(df2) 
          df2 %>%
            arrange(desc(score)) %>%
            # filter(exp_status) %>%
            mutate(scoreb1= score>nth(score,n = df_row*(0.05))) %>% 
            mutate(scoreb2= score>nth(score,n = df_row*(0.1))) %>%  
            mutate(scoreb3= score>nth(score,n = df_row*(0.15))) %>% 
            mutate(scoreb4= score>nth(score,n = df_row*(0.2))) %>%  
            mutate(scoreb5= score>nth(score,n = df_row*(0.25))) %>% 
            mutate(scoreb6= score>nth(score,n = df_row*(0.3))) %>%
            mutate(scoreb7= score>nth(score,n = df_row*(0.4))) %>%
            mutate(scoreb8= score>nth(score,n = df_row*(0.5))) %>%
            mutate(scoreb0= T) %>% 
            pivot_longer(cols= scoreb1:scoreb0, names_to="threshold_type", values_to= "binaryvalue") %>% 
            nest_by(threshold_type) %>% 
            ungroup() %>%
            mutate(res= map(data, .f=function(df){
              df1= df %>%
                filter(binaryvalue) 
              
              num_sup=  tryCatch(
                  expr = df1 %>% select(sup_pred_score,score) %>% drop_na() %>% nrow(),
                  error= function(err) NA)
              
              res= tibble(cor_type= c("cor_sup"), corobs=c(num_sup))
              
              return(res)
              
            })) %>%
            select(-data) %>%
            unnest(res)
        })) %>% 
      unnest(data)
    }
  )) %>% 
  unnest(res) %>% 
  filter(score_type==3) %>% 
  pivot_wider(names_from=threshold_type,values_from=corobs)

cor_res_num_unsup <- tibble(score_type=1:3) %>% 
  mutate(res= map(
  .x=1:3, 
  .f= function(x){
    # x=1
    df= PISA_summary_augmented %>% 
      select(exp_id, drug_name, drug_id, gene_symbol,exp_status,p_value,one_of(paste0("score", x)), "unsup_pred_score")
    colnames(df)[which(colnames(df)==(paste0("score", x)))] <- "score"
  
    df1 <- df %>% 
      nest_by(exp_id,drug_id, drug_name) %>%
      ungroup() %>%
      mutate(data= map(
        .x= data,
        .f = function(df2){
          df_row <- nrow(df2) 
          df2 %>%
            arrange(desc(score)) %>%
            # filter(exp_status) %>%
            mutate(scoreb1= score>nth(score,n = df_row*(0.05))) %>% 
            mutate(scoreb2= score>nth(score,n = df_row*(0.03))) %>%  
            mutate(scoreb3= score>nth(score,n = df_row*(0.025))) %>% 
            mutate(scoreb4= score>nth(score,n = df_row*(0.02))) %>%  
            mutate(scoreb5= score>nth(score,n = df_row*(0.01))) %>% 
            mutate(scoreb6= score>nth(score,n = df_row*(0.005))) %>%
            mutate(scoreb0= T) %>% 
            pivot_longer(cols= scoreb1:scoreb0, names_to="threshold_type", values_to= "binaryvalue") %>% 
            nest_by(threshold_type) %>% 
            ungroup() %>%
            mutate(res= map(data, .f=function(df){
              df1= df %>%
                filter(binaryvalue) 
              
              num_unsup=  tryCatch(
                  expr = df1 %>% select(unsup_pred_score,score) %>% drop_na() %>% nrow(),
                  error= function(err) NA)
              
              res= tibble(cor_type= c("cor_unsup"), corobs=c( num_unsup))
              
              return(res)
              
            })) %>%
            select(-data) %>%
            unnest(res)
        })) %>% 
      unnest(data)
    }
  )) %>% 
  unnest(res) %>% 
  filter(score_type==3) %>% 
  pivot_wider(names_from=threshold_type,values_from=corobs)


cor_res_sigbased_num <- tibble(score_type=1:3) %>% 
  mutate(res= map(
  .x=1:3, 
  .f= function(x){
    # x=1
    df= PISA_summary_augmented %>% 
      select(exp_id, drug_name, drug_id, gene_symbol,exp_status,p_value,p_adj,one_of(paste0("score", x)),"sup_pred_score", "unsup_pred_score")
    colnames(df)[which(colnames(df)==(paste0("score", x)))] <- "score"
  
    df1 <- df %>% 
      nest_by(exp_id,drug_id, drug_name) %>%
      ungroup() %>%
      mutate(data= map(
        .x= data,
        .f = function(df2){
          df_row <- nrow(df2) 
          df2 %>%
            mutate(scoreb0= (p_value<0.05)) %>% #7
            mutate(scoreb1= (p_adj<0.25)) %>% 
            pivot_longer(cols= scoreb0:scoreb1, names_to="threshold_type", values_to= "binaryvalue") %>% 
            nest_by(threshold_type) %>% 
            ungroup() %>%
            mutate(res= map(data, .f=function(df){
              df1= df %>%
                filter(binaryvalue)
              
              num_sup=  tryCatch(
                  expr = df1 %>% select(sup_pred_score,score) %>% drop_na() %>% nrow(),
                  error= function(err) NA)
              
              num_unsup=  tryCatch(
                  expr = df1 %>% select(unsup_pred_score,score) %>% drop_na() %>% nrow(),
                  error= function(err) NA)
              
              res= tibble(cor_type= c("cor_sup","cor_unsup"), corobs=c(num_sup, num_unsup))
              
              return(res)
              
            })) %>%
            select(-data) %>%
            unnest(res)
        })) %>% 
      unnest(data)
    }
  )) %>% 
  unnest(res) %>% 
  filter(score_type==3) %>% 
  filter(cor_type=="cor_sup") %>% 
  pivot_wider(names_from=threshold_type,values_from=corobs)
```

score rank based filtering

supervised prediction
```{r}
cor_res_sup <- tibble(score_type=1:3) %>% 
  mutate(res= map(
  .x=1:3, 
  .f= function(x){
    # x=1
    df= PISA_summary_augmented %>% 
      select(exp_id, drug_name, drug_id, gene_symbol,exp_status,p_value,one_of(paste0("score", x)),"sup_pred_score")
    colnames(df)[which(colnames(df)==(paste0("score", x)))] <- "score"
  
    df1 <- df %>% 
      nest_by(exp_id,drug_id, drug_name) %>%
      ungroup() %>%
      mutate(data= map(
        .x= data,
        .f = function(df2){
          df_row <- nrow(df2) 
          df2 %>%
            arrange(desc(score)) %>%
            mutate(scoreb1= score>nth(score,n = df_row*(0.05))) %>% 
            mutate(scoreb2= score>nth(score,n = df_row*(0.1))) %>%  
            mutate(scoreb3= score>nth(score,n = df_row*(0.15))) %>% 
            mutate(scoreb4= score>nth(score,n = df_row*(0.2))) %>%  
            mutate(scoreb5= score>nth(score,n = df_row*(0.25))) %>% 
            mutate(scoreb6= score>nth(score,n = df_row*(0.3))) %>%
            mutate(scoreb7= score>nth(score,n = df_row*(0.4))) %>%
            mutate(scoreb8= score>nth(score,n = df_row*(0.5))) %>%
            mutate(scoreb0= T) %>% 
            pivot_longer(cols= scoreb1:scoreb0, names_to="threshold_type", values_to= "binaryvalue") %>%
            nest_by(threshold_type) %>% 
            ungroup() %>%
            mutate(res= map(data, .f=function(df){
              df1= df %>%
                filter(binaryvalue) 

              cor_sup=  tryCatch(
                  expr = cor(df1$sup_pred_score, df1$score, use = "complete.obs", method= "pearson"),
                  error= function(err) NA)
              res= tibble(cor_type= c("cor_sup"), corvalue=c(cor_sup))
              return(res)
            })) %>%
            select(-data) %>%
            unnest(res)
        })) %>% 
      unnest(data)
    }
  )) %>% unnest(res)

  
cor_res1_sup <- cor_res_sup %>% 
  mutate(across(c(threshold_type),as.factor)) 

levels(cor_res1_sup$threshold_type) <- c(1,0.05, 0.1, 0.15, 0.2, 0.25,0.3,0.4, 0.5)
cor_res1_sup$threshold_type <- fct_relevel(cor_res1_sup$threshold_type, "1", after = Inf)
cor_res1_sup <- cor_res1_sup %>% 
  mutate(threshold_prop= as.numeric(levels(threshold_type))[as.numeric(threshold_type)]) #%>%
  # mutate(score_type_num= as.numeric(str_split(score_type,pattern  = "core", n = 2,simplify = T)[,2]))

cor_res1_sup %>% 
  # group_by(threshold_type,score_type,exp_id) %>% 
  # summarise(median_corvalue=median(corvalue, na.rm = T)) %>% 
  # ungroup() %>% 
  ggplot(aes(x= threshold_type,y= corvalue))+
  geom_boxplot()+
  geom_hline(yintercept=0)+
  facet_grid(cols = vars(score_type),scale= "free_y")

tmp <- cor_res1_sup %>% 
  group_by(threshold_type,score_type) %>%
  summarise(mean_corvalue=mean(corvalue, na.rm = T), median_corvalue=median(corvalue, na.rm = T)) %>%
  ungroup() 
```

unsupervised prediction
```{r}
cor_res_unsup <- tibble(score_type=1:3) %>% 
  mutate(res= map(
  .x=1:3, 
  .f= function(x){
    # x=1
    df= PISA_summary_augmented %>% 
      select(exp_id, drug_name, drug_id, gene_symbol,exp_status,p_value,one_of(paste0("score", x)),"unsup_pred_score")
    colnames(df)[which(colnames(df)==(paste0("score", x)))] <- "score"
  
    df1 <- df %>% 
      nest_by(exp_id,drug_id, drug_name) %>%
      ungroup() %>%
      mutate(data= map(
        .x= data,
        .f = function(df2){
          df_row <- nrow(df2) 
          df2 %>%
            arrange(desc(score)) %>%
            mutate(scoreb1= score>nth(score,n = df_row*(0.05))) %>% 
            mutate(scoreb2= score>nth(score,n = df_row*(0.03))) %>%  
            mutate(scoreb3= score>nth(score,n = df_row*(0.025))) %>% 
            mutate(scoreb4= score>nth(score,n = df_row*(0.02))) %>%  
            mutate(scoreb5= score>nth(score,n = df_row*(0.01))) %>% 
            mutate(scoreb6= score>nth(score,n = df_row*(0.005))) %>%
            mutate(scoreb0= T) %>% 
            pivot_longer(cols= scoreb1:scoreb0, names_to="threshold_type", values_to= "binaryvalue") %>%
            nest_by(threshold_type) %>% 
            ungroup() %>%
            mutate(res= map(data, .f=function(df){
              df1= df %>%
                filter(binaryvalue) 

              cor_unsup=  tryCatch(
                  expr = cor(df1$unsup_pred_score, df1$score, use = "complete.obs", method= "pearson"),
                  error= function(err) NA)
              res= tibble(cor_type= c("cor_unsup"), corvalue=c(cor_unsup))
              return(res)
            })) %>%
            select(-data) %>%
            unnest(res)
        })) %>% 
      unnest(data)
    }
  )) %>% unnest(res)

  
cor_res1_unsup <- cor_res_unsup %>% 
  mutate(across(c(threshold_type),as.factor)) 

levels(cor_res1_unsup$threshold_type) <- c(1,0.05, 0.03, 0.025, 0.02, 0.01,0.005)
cor_res1_unsup$threshold_type <- fct_relevel(cor_res1_unsup$threshold_type, "1", after = Inf)
cor_res1_unsup <- cor_res1_unsup %>% 
  mutate(threshold_prop= as.numeric(levels(threshold_type))[as.numeric(threshold_type)]) #%>%

cor_res1_unsup %>% 
  ggplot(aes(x= threshold_type,y= corvalue))+
  geom_boxplot()+
  geom_hline(yintercept=0)+
  facet_grid(cols = vars(score_type),scale= "free_y")

tmp1 <- cor_res1_unsup %>%
  group_by(threshold_type,score_type) %>%
  summarise(mean_corvalue=mean(corvalue, na.rm = T), median_corvalue=median(corvalue, na.rm = T)) %>%
  ungroup()
```

significance base filtering
```{r}
# cor_res_sigbased <- tibble(score_type=1:3) %>%
#   mutate(res= map(
#   .x=1:3,
#   .f= function(x){
# 
#     df= PISA_summary_augmented %>%
#       select(exp_id, drug_name, drug_id, gene_symbol,exp_status,p_value,p_adj,
#              one_of(paste0("score", x)),"sup_pred_score", "unsup_pred_score")
#     colnames(df)[which(colnames(df)==(paste0("score", x)))] <- "score"
# 
#     df1 <- df %>%
#       nest_by(exp_id,drug_id, drug_name) %>%
#       ungroup() %>%
#       mutate(data= map(
#         .x= data,
#         .f = function(df2){
#           df_row <- nrow(df2)
#           df2 %>%
#             mutate(scoreb0= (p_value<0.05)) %>% #7
#             mutate(scoreb1= (p_adj<0.25)) %>%
#             pivot_longer(cols= scoreb0:scoreb1, names_to="threshold_type", values_to= "binaryvalue") %>%
#             nest_by(threshold_type) %>%
#             ungroup() %>%
#             mutate(res= map(data, .f=function(df){
#               df1= df %>%
#                 filter(binaryvalue)
#                 # filter(exp_status) %>%
#               cor_sup=  tryCatch(
#                   expr = cor(df1$sup_pred_score, df1$score, use = "complete.obs", method= "pearson"),
#                   error= function(err) NA)
#               cor_unsup=  tryCatch(
#                   expr = cor(df1$unsup_pred_score, df1$score, use = "complete.obs", method= "pearson"),
#                   error= function(err) NA)
#               res= tibble(cor_type= c("cor_sup","cor_unsup"), corvalue=c(cor_sup, cor_unsup))
#               return(res)
#             })) %>%
#             select(-data) %>%
#             unnest(res)
#         })) %>%
#       unnest(data)
#     }
#   )) %>%
#   unnest(res) %>%
#   mutate(across(c(score_type, exp_id, drug_id, drug_name, cor_type,threshold_type),as.factor))
# 
# 
# tmp <- cor_res_sigbased %>%
#     group_by(threshold_type,score_type,cor_type) %>%
#   summarise(mean_corvalue=mean(corvalue, na.rm = T), 
#             median_corvalue=median(corvalue, na.rm = T)) %>%
#   ungroup() 
#   
# 
# cor_res_sigbased %>%
#   ggplot(aes(x= threshold_type,y= corvalue))+
#   geom_boxplot()+
#   geom_hline(yintercept = 0)+
#   facet_grid(rows = vars(cor_type), cols = vars(score_type),scale= "free_y")
```


generate random prediction based on permutation
```{r}
# set.seed(1234)
# prism_drh_pred20_rdm_idx <- map(
#   .x= 1:10000,
#   .f= function(x){
#     seed=x
#     ridx=sample(1:6020)
#   }
#   )
# 
# prism_drh_pred20_rdm <- tibble(sample_id=1:1000) %>% 
#   mutate(sample_df= map(
#     .x= 1:1000,
#     .f= function(x){
#       idx <- prism_drh_pred20_rdm_idx[[x]]
#       prism_drh_pred20_rdm <- prism_drh_pred20 %>% 
#         mutate(sup_pred_score= prism_drh_pred20$sup_pred_score[idx])} 
#     ))        
# 
# prism_unsup_pred20_rdm_idx <- map(
#   .x= 1:1000,
#   .f= function(x){
#     seed=x
#     ridx=sample(1:212460)
#   }
#   )
# 
# prism_unsup_pred20_rdm <- tibble(sample_id=1:1000) %>% 
#   mutate(sample_df= map(
#     .x= 1:1000,
#     .f= function(x){
#       idx <- prism_unsup_pred20_rdm_idx[[x]]
#       prism_unsup_pred20_rdm <- prism_unsupervised_pred20 %>%
#         mutate(unsup_pred_score= prism_unsupervised_pred20$unsup_pred_score[idx])} 
#     ))    
# 
# # a function to get random corr object given a fixed score_type, threshold_type and number of permutations
# # perm_num=10
# # score_type=1
# # threshold_prop=0.25
# 
# get_cor_res_rdm <- function(perm_num, score_type, threshold_prop,cor_type= "cor_unsup"){
#   tibble(sample_df_idx=1:perm_num) %>% 
#   mutate(res= map(
#   .x=sample_df_idx, 
#   .f= function(x){
#     PISA_summary_augmented_rdm <-  PISA_summary %>%
#       mutate(score_new= case_when(
#         score_type==1~ log10_p*abs(log2_fc),
#         score_type==2~ log10_p,
#         score_type==3~ abs(log2_fc)
#         )) %>% 
#       full_join(prism_drh_pred20_rdm$sample_df[[x]], 
#                 by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
#       full_join(prism_unsup_pred20_rdm$sample_df[[x]], 
#                 by=c("drugid"="drug_id", "gene_symbol"="target")) %>%
#       filter(!is.na(exp_id)) %>% 
#       select(exp_id:gene_symbol,drugid,p_value,score_new,sup_pred_score,unsup_pred_score)
#     
#     df= PISA_summary_augmented_rdm %>% 
#       nest_by(exp_id,drug_id, drug_name) %>%
#       ungroup() 
#     
#     df1 <- df %>%
#       mutate(data= map(
#         .x= data,
#         .f = function(df2){
#           df_row <- nrow(df2) 
#           score_threshold= nth(x = sort(df2$score_new,decreasing = T),
#                                n = df_row*(threshold_prop))
#           scoreb1= df2$score_new > score_threshold
#         
#           df2 <- filter(df2, scoreb1)
#           
#           if(cor_type== "cor_sup"){
#             cor_value=  tryCatch(
#               expr = cor(df2$sup_pred_score, df2$score_new,
#                          use = "complete.obs", method= "pearson"),
#               error= function(err) NA)}
# 
#           if(cor_type== "cor_unsup"){ 
#             cor_value=  tryCatch(
#               expr = cor(df2$unsup_pred_score, df2$score_new,
#                          use = "complete.obs", method= "pearson"),
#               error= function(err) NA)
#             }
# 
#           
#           res= tibble(cor_type= cor_type, corvalue=cor_value )
#           return(res)
#             })) %>% 
#       unnest(data)
#     }
#   )) %>% 
#   mutate(mean_cor=map_dbl(res, .f= function(df){mean(df$corvalue, na.rm = T)})) %>% 
#   mutate(median_cor=map_dbl(res, .f= function(df){median(df$corvalue, na.rm = T)})) 
# }
# 
# tictoc::tic()
# cor_res_rdm_perm_score3_prop0.25 <- get_cor_res_rdm(1000, 3,0.025, cor_type= "cor_unsup" )
# tictoc::toc()
# 
# #get overall p-value and mean estimates for the following grid.
# tictoc::tic()
# plan(multisession,workers=6)
# par_grid_sup <- expand_grid( 
#   perm_num=1000,
#   score_type=c(1,2,3),
#   threshold_prop=c(0.05*1:10, 1)) %>% 
#   # slice(1:6) %>% 
#   mutate(res= future_pmap(
#     .l = list(perm_num, score_type, threshold_prop), 
#     .f = get_cor_res_rdm,
#     .options = furrr_options(seed=0000)
#           )) 
# plan(sequential)
# tictoc::toc()
# 
# # changed the default parameter of the function to generate the null distribution for unsupervised predictions
# save(list=c("PISA_summary", "get_cor_res_rdm", 
#             "prism_unsup_pred20_rdm", "prism_drh_pred20_rdm"),
#      file="./fig_res/null_dist_input.RData")
# tictoc::tic()
# plan(multicore,workers= 6)
# par_grid_unsup <- expand_grid( 
#   perm_num=10,
#   score_type=c(1,2,3),
#   threshold_prop=c(1,0.05, 0.03, 0.025, 0.02, 0.01,0.005)) %>% 
#   mutate(res= future_pmap(
#     .l = list(perm_num, score_type, threshold_prop), 
#     .f = get_cor_res_rdm,
#     .options = furrr_options(seed=0000)
#           )) 
# plan(sequential)
# tictoc::toc()
# getwd()
# save(list = c("par_grid_sup"), file = "~/cluster_scratch/forward_modelling/noncancer_drugtarget_validation/null_dist_sup.RData")
# save(list = c("par_grid_sup"), file = "~/cluster_scratch/forward_modelling/noncancer_drugtarget_validation/null_dist_unsup.RData")
```

calculate overall p-value and drug specific p-values
```{r}
# load("~/cluster_scratch/forward_modelling/noncancer_drugtarget_validation/null_dist_sup.RData")
# load("~/cluster_scratch/forward_modelling/noncancer_drugtarget_validation/null_dist_unsup.RData")

overall_sup <- cor_res1_sup %>% 
  select( -threshold_type) %>% 
  nest_by(score_type, threshold_prop) %>% 
  ungroup() %>% 
  inner_join(par_grid_sup, by=c("threshold_prop", "score_type")) %>% 
  mutate(median_real= map(data, .f= function(x){median(x$corvalue,na.rm = T)})) %>% 
  mutate(mean_real= map(data, .f= function(x){mean(x$corvalue,na.rm = T)})) %>% 
  mutate(median_perm_vector=map(res, .f= function(x){x %>% pull(median_cor)})) %>% 
  mutate(mean_perm_vector=map(res, .f= function(x){x %>% pull(mean_cor)}))  %>% 
  mutate(median_perm= map_dbl(median_perm_vector, mean)) %>%
  mutate(meam_perm= map_dbl(mean_perm_vector, mean)) %>%
  mutate(p_mean=pmap_dbl(.l = list(mean_real, mean_perm_vector,perm_num), 
                         .f= function(x,y,z){sum(y>x)/z})) %>% 
  mutate(p_median=pmap_dbl(.l= list(median_real, median_perm_vector,perm_num), 
                           .f= function(x,y,z){sum(y>x)/z})) %>% 
  unnest(median_real) %>% 
  unnest(mean_real) %>% 
  arrange(p_mean) %>% 
  select(-median_perm_vector, -mean_perm_vector,-data, -res)
write_csv(overall_sup, "./fig_res/foverall_p_value_supervised_prediction.csv")

overall_unsup <- cor_res1_unsup %>% 
  select( -threshold_type) %>% 
  nest_by(score_type, threshold_prop) %>% 
  ungroup() %>% 
  inner_join(par_grid_unsup, by=c("threshold_prop", "score_type")) %>% 
  mutate(median_real= map(data, .f= function(x){median(x$corvalue,na.rm = T)})) %>% 
  mutate(mean_real= map(data, .f= function(x){mean(x$corvalue,na.rm = T)})) %>% 
  mutate(median_perm_vector=map(res, .f= function(x){x %>% pull(median_cor)})) %>% 
  mutate(mean_perm_vector=map(res, .f= function(x){x %>% pull(mean_cor)}))  %>% 
  mutate(median_perm= map_dbl(median_perm_vector, mean)) %>%
  mutate(meam_perm= map_dbl(mean_perm_vector, mean)) %>%
  mutate(p_mean=pmap_dbl(.l = list(mean_real, mean_perm_vector,perm_num), 
                         .f= function(x,y,z){sum(y>x)/z})) %>% 
  mutate(p_median=pmap_dbl(.l= list(median_real, median_perm_vector,perm_num), 
                           .f= function(x,y,z){sum(y>x)/z})) %>% 
  unnest(median_real) %>% 
  unnest(mean_real) %>% 
  arrange(p_mean) %>% 
  select(-median_perm_vector, -mean_perm_vector,-data, -res)
write_csv(overall_unsup, "./fig_res/foverall_p_value_unsupervised_prediction.csv")
```

get drug specific p-value
```{r}
drugspecfic_sup <- inner_join(
  x= cor_res1_sup %>% 
    select( -threshold_type, -cor_type) #%>% 
    # filter(score_type==1, threshold_prop== 0.25 )
  ,
  y= par_grid_sup %>% 
    # filter(score_type==1, threshold_prop==0.25) %>% 
    unnest(res) %>% 
    unnest(res) %>% 
    select(drug_id, drug_name,score_type, threshold_prop, corvalue)%>% 
    nest_by(drug_id, drug_name,score_type, threshold_prop) %>% 
    ungroup() %>% 
    mutate(cor_null= map(data, ~.x$corvalue)) %>% 
    select(-data),
  by= c("drug_id", "drug_name","score_type", "threshold_prop")
) %>% 
  mutate(mean_perm= map_dbl(cor_null,~mean(.x,na.rm = T))) %>% 
  mutate(p_perm= map2_dbl(corvalue, cor_null, 
                          .f=function(x,y){sum(y>x,na.rm = T)/length(na.omit(y))})) 

all_sup <- drugspecfic_sup %>% 
  select(-cor_null) %>% 
  nest_by(score_type, threshold_prop) %>% 
  ungroup() %>% 
  inner_join(overall_sup,by=c("score_type", "threshold_prop")) %>% 
  arrange(p_mean) %>% 
  mutate(data= map(.x = data, .f= function(x){
                     x$p_adj <- p.adjust(x$p_perm,method="fdr")
                     x= as_tibble(x) %>% arrange(p_adj)
                     return(x)}
                   ))
```


```{r}
drugspecfic_unsup <- inner_join(
  x= cor_res1_unsup %>% 
    select( -threshold_type, -cor_type) #%>% 
    # filter(score_type==1, threshold_prop== 0.25 )
  ,
  y= par_grid_unsup %>% 
    # filter(score_type==1, threshold_prop==0.25) %>% 
    unnest(res) %>% 
    unnest(res) %>% 
    select(drug_id, drug_name,score_type, threshold_prop, corvalue)%>% 
    nest_by(drug_id, drug_name,score_type, threshold_prop) %>% 
    ungroup() %>% 
    mutate(cor_null= map(data, ~.x$corvalue)) %>% 
    select(-data),
  by= c("drug_id", "drug_name","score_type", "threshold_prop")
) %>% 
  mutate(mean_perm= map_dbl(cor_null,~mean(.x,na.rm = T))) %>% 
  mutate(p_perm= map2_dbl(corvalue, cor_null, 
                          .f=function(x,y){sum(y>x,na.rm = T)/length(na.omit(y))})) 

all_unsup <- drugspecfic_unsup %>% 
  select(-cor_null) %>% 
  nest_by(score_type, threshold_prop) %>% 
  ungroup() %>% 
  inner_join(overall_unsup,by=c("score_type", "threshold_prop")) %>% 
  arrange(p_mean) %>% 
  mutate(data= map(.x = data, .f= function(x){
                     x$p_adj <- p.adjust(x$p_perm,method="fdr")
                     x= as_tibble(x) %>% arrange(p_adj)
                     return(x)}
                   ))

save(all_sup,all_unsup,PISA_summary_augmented_drug_level, prism_target_dtc, prism_target_binary, file = "file_to_jing_20221230.RData")
```



```{r}
# tibble(id=1:1000,
#        COR=cor_res_sup_true %>% 
#          filter(drug_id=="Pod") %>% 
#          pull(corvalue_perm) %>% unlist()) %>% 
#   ggplot(aes(x = COR))+
#   geom_density()+
#   geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis,
#                    colour="black", fill="white") +
#     geom_density(alpha=.2, fill="#FF6666")+
#   geom_vline(xintercept = 0.519,lty=2,color="red")+
#   theme_classic()
# 
# tmp <- cor_res_sup_true %>% 
#   filter(exp_id %in% c("PISA_2", "PISA_4")) %>% 
#   select(exp_id, drug_name,corvalue, corvalue_perm) %>% 
#   arrange(exp_id, drug_name) %>% 
#   mutate(corvalue_perm= map(corvalue_perm, function(x){tibble(corperm=x, id=as.character(1:1000))})) %>% 
#   unnest(corvalue_perm)  
#   
# ggplot(data=tmp, aes(x= tidytext::reorder_within(id,corperm, drug_name),y= corperm))+
#   geom_point(size=0.5)+
#   facet_wrap(~drug_name,nrow = 2,ncol = 5)+
#   geom_hline(data=tmp %>% select(drug_name, corvalue) %>% distinct(),
#              aes(yintercept= corvalue),
#              color= "red",lty=2)+
#   theme_classic()+
#   theme(axis.title.x = element_blank(),axis.text.x = element_blank(), axis.ticks.x = element_blank())
# 
# cor_res_sup_true %>%
#   # filter(exp_id %in% )
#   select(drug_name,  exp_id, corvalue, corvalue_perm_med, p_perm) %>% 
#   mutate(corvalue_perm_med=round(corvalue_perm_med,3)) %>% 
#   mutate(corvalue=round(corvalue,3))
# 
# cor_res_sup_true %>%
#   select(exp_id, drug_name, corvalue, corvalue_perm_med) %>% 
#   pivot_longer(one_of("corvalue", "corvalue_perm_med"), names_to="cor_type", values_to="cor") %>% 
#   ggplot(aes(x= cor_type, y=cor, fill= cor_type))+
#   geom_boxplot()+
#   geom_point(aes(color= exp_id))+
#   geom_line(aes(group=drug_name))+
#   theme_classic()+
#   theme(axis.title.x = element_blank(),axis.text.x = element_blank(), axis.ticks.x = element_blank())
```


Case study
```{r}
tmp <- PISA_summary_augmented %>% 
  filter(drug_name=="Podophyllotoxin") %>% 
  select(-unsup_pred_score) %>%
  arrange(desc(score1)) %>% 
  drop_na() %>% 
  slice(1:37) %>%
  arrange(desc(sup_pred_score))

tmp %>%   
  ggplot(aes(x=score1, y=sup_pred_score,label= gene_symbol))+
  geom_point()+
  geom_text(data=tmp %>% slice(1:5), color="red")+
  xlab("PISA score)")+
  ylab("Supervised predicion score")+
  theme_classic()+
  ggtitle("Podophyllotoxin")
```


```{r}
tmp <- PISA_summary_augmented %>% 
  filter(drug_name=="Fluvastatin") %>% 
  select(-unsup_pred_score) %>%
  arrange(desc(score1)) %>% 
  drop_na() %>% 
  slice(1:37) %>% 
  arrange(desc(sup_pred_score))
tmp %>%   
  ggplot(aes(x=score1, y= sup_pred_score,label= gene_symbol))+
  geom_point()+
  geom_text(data=tmp %>% slice(1:5), color="red")+
  xlab("PISA score)")+
  ylab("Supervised predicion score")+
  theme_classic()  +
  ggtitle("Fluvastatin")
```


```{r}
tmp <- PISA_summary_augmented %>% 
  filter(drug_name=="Pitavastatin") %>% 
  select(-unsup_pred_score) %>%
  arrange(desc(score1)) %>% 
  drop_na() %>% 
  slice(1:37) %>% 
  arrange(desc(sup_pred_score))
tmp %>%   
  ggplot(aes(x=score1, y= sup_pred_score,label= gene_symbol))+
  geom_point()+
  geom_text(data=tmp %>% slice(1:5), color="red")+
  xlab("PISA log2(abs(fc))")+
  ylab("Supervised predicion score")+
  theme_classic()  +
  ggtitle("Pitavastatin")
```

```{r}
tmp <- PISA_summary_augmented %>% 
  filter(drug_name=="Harringtonine") %>% 
  select(-unsup_pred_score) %>%
  arrange(desc(score1)) %>% 
  drop_na() %>% 
  slice(1:37) %>% 
  arrange(desc(sup_pred_score))

tmp %>%   
  ggplot(aes(x=score1, y= sup_pred_score,label= gene_symbol))+
  geom_point()+
  geom_text(data=tmp %>% slice(1:5), color="red")+
  xlab("PISA log2(abs(fc))")+
  ylab("Supervised predicion score")+
  theme_classic()  +
  ggtitle("Harringtonine")
```

```{r}
tmp <- PISA_summary_augmented %>% 
  filter(drug_name=="Fluvastatin") %>% 
  arrange(desc(score1)) %>% 
  # drop_na() %>% 
  arrange(desc(unsup_pred_score))


tmp %>%   
  ggplot(aes(x=score1, y= sup_pred_score,label= gene_symbol))+
  geom_point()+
  geom_text(data=tmp %>% slice(1:5), color="red")+
  xlab("PISA log2(abs(fc))")+
  ylab("Supervised predicion score")+
  theme_classic()  +
  ggtitle("Puromycin")
```


gene-level is not working well.
let's try pathway level instead

get pathway for pisa
```{r}
library(fgsea)

pathway_go <- gmtPathways("~/cluster_scratch/prior/c5.go.v7.4.symbols.gmt")
pathway_kegg <- gmtPathways("~/cluster_scratch/prior/c2.cp.kegg.v7.4.symbols.gmt")
prism_go <- read_csv("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/GO_df_prism.csv")
prism_kegg <- read_csv("~/cluster_wrk/drug_moa/unsupervised_target_exploration/fig_res/pathways_df_prism.csv")

plan(multisession,workers=5)
PISA_pathway <- PISA_summary_augmented %>% 
   filter(exp_status==1) %>%
  select(exp_id,drug_name, drugid, gene_symbol, drugid,exp_status,score, score2,log10_p) %>% 
  filter(!is.na(drug_name)) %>% 
  nest_by(exp_id,drugid, drug_name) %>% 
  ungroup() %>% 
  mutate(kegg_scorebased =  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score) %>% drop_na()
      rank <- df$score
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_kegg, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)} )) %>% 
  mutate(kegg_score2based=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score2) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_kegg, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>%
  mutate(kegg_pbased=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,log10_p) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_kegg, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>%
  mutate(go_scorebased=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score) %>% drop_na()
      rank <- df$score
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_go, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>%
  mutate(go_score2based=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,score2) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_go, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)})) %>% 
  mutate(go_score2based=  furrr::future_map(
    .options = furrr::furrr_options(seed = 1),
    .x = data,
    .f = function(x){
      df <- df %>% select(target,log10_p) %>% drop_na()
      rank <- df$score2
      names(rank) <-  df$target
      fgseaRes <- fgsea(pathway_go, rank, minSize=15, maxSize=500) %>% 
        filter(pval<0.05)
      return(fgseaRes)}))
plan(sequential)  
```


lets get the overlapping go and kegg pathways for ess_sig and pisa
```{r}
# n=319 for 16 drugs
prism_go <- prism_go %>% 
  filter(drug %in% PISA_pathway$drugid)

#n= 45 for 14 drugs 
prism_kegg <- prism_kegg %>% 
  filter(drug %in% PISA_pathway$drugid)
```


```{r}
# n= 1033 for 20 drugs
PISA_sig_GO <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, go_scorebased) %>%
  unnest(go_scorebased) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(padj<0.05) %>%
  inner_join(prism_go %>% select(drug, pathway),
                   by=c("drugid"="drug", "pathway"="pathway"))
# n= 205 for 20 drugs
PISA_sig_KEGG <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, kegg_scorebased) %>%
  unnest(kegg_scorebased) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(pval<0.05) %>%
  inner_join(prism_kegg %>% select(drug, pathway),
                   by=c("drugid"="drug", "pathway"="pathway"))


PISA_sig_GO2 <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, go_score2based) %>%
  unnest(go_score2based) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(padj<0.05) %>% 
  inner_join(prism_go %>% select(drug, pathway), 
                   by=c("drugid"="drug", "pathway"="pathway"))

PISA_sig_KEGG2 <- PISA_pathway %>% 
  select(exp_id,drugid,drug_name, kegg_score2based) %>%
  unnest(kegg_score2based) %>%
  # select(drugid, go_score2based) %>% 
  # unnest(go_score2based) %>% 
  filter(padj<0.05) %>% 
  inner_join(prism_kegg %>% select(drug, pathway), 
                   by=c("drugid"="drug", "pathway"="pathway"))
```

save an RData for Jing
```{r}
supervised_pred <- prism_drh_pred20
unsupervised_pred <- prism_unsupervised_pred20
PISA <- PISA_summary %>% 
  mutate(exp_status= gene_symbol %in% exp_gene_c2)
PISA_supervised <- tmp4 
PISA_unsupervised <- tmp5
save(supervised_pred,unsupervised_pred, PISA, PISA_supervised,PISA_unsupervised, 
     file = "~/cluster_wrk/drug_moa/noncancer_drug_validation/res_to_Jing.RData")
```



```{r}
# train_consen_sig <- bind_rows(
#     feature_imp_ridge_prism_comb1 %>%
#       filter(drug %in% prism_good_fitted_drugs_drhannotated) %>%
#       arrange(drug),
# 
#     feature_imp_ridge_prism_comb1 %>%
#       filter(drug %in% prism_good_fitted_nononcologydrugs) %>%
#       arrange(drug)
# )
# 
# train_cor_mat <- cor(t(train_consen_sig %>% select(-drug)))
# colnames(train_cor_mat) <- train_consen_sig$drug
# row.names(train_cor_mat) <- train_consen_sig$drug
# target_mat_268 <- get_target_mat(
#   target_tibble = prism_target_binary %>%
#     filter(drug %in% prism_good_fitted_drugs_drhannotated) %>%
#     arrange(drug))
# 
# pred_63_supervised <- no_tunning_weighted_averaging(
#   target_mat = target_mat_268,
#   cor_mat = train_cor_mat,
#   test_idx = 269:331,pred_new = T)
# pred_63_supervised <- t(pred_63_supervised)
# 
# pred_268_supervised <- map_dfc(
#   .x = 1:268,
#   .f = ~no_tunning_weighted_averaging(
#     target_mat = target_mat_268,
#     cor_mat = train_cor_mat[1:268,1:268],
#     test_idx = .x,
#     pred_all = T)
#   )
# # pred_268_supervised <- t(pred_268_supervised)
# 
# colnames(pred_268_supervised) <- row.names(target_mat_268)
# rownames(pred_268_supervised) <-colnames(target_mat_268)
```


```{r}
# pred_58_supervised <- 
#   tibble(
#     target= colnames(pred_58_supervised),
#     as.data.frame(t(pred_58_supervised))
#   ) %>%
#   arrange(target)
# 
# colnames(pred_58_supervised )[2:59] <-  sort(prism_good_fitted_nononcologydrugs)

# write_csv(pred_58_supervised, "~/cluster_wrk/drug_moa/pred_58_supervised.csv")
# also write out the unsupervised prediction for the 58 drugs
# pred_58_unsupervised <- feature_imp_ridge_prism_comb1 %>% 
#   filter(drug %in% prism_good_fitted_nononcologydrugs) %>% 
#   pivot_longer(-drug, names_to= "target", values_to= "pred") %>% 
#   pivot_wider(id_cols = target, names_from= drug, values_from= pred)
# write_csv(pred_58_unsupervised, "~/cluster_wrk/drug_moa/pred_58_unsupervised.csv")
```


The following analysis asked by Jing in answering Krister's question
```{r}
# cor_df_predicted_target <- 
#   cor(pred_268_supervised, use = "pairwise.complete.obs", method = "spearman") %>%
#   as_tibble() %>% 
#   mutate(drug1=row.names(target_mat_268)) %>%
#   pivot_longer(cols = -drug1,names_to= "drug2") %>% 
#   arrange(drug1, drug2)
# 
# cor_df_unpred_target <- 
#   train_cor_mat[1:268,1:268] %>% 
#   as_tibble() %>% 
#   mutate(drug1=row.names(target_mat_268)) %>%
#   pivot_longer(cols = -drug1,names_to= "drug2") %>% 
#   arrange(drug1, drug2)
# 
# 
# cor_df_sen <- prism_data %>% filter(BROAD_ID %in% row.names(target_mat_268)) %>% 
#   select(BROAD_ID, sensitivity) %>% 
#   unnest(sensitivity) %>% 
#   select(-ec50) %>% 
#   drop_na() %>% 
#   pivot_wider(id_cols = depmap_id,names_from= BROAD_ID, values_from=auc) %>% 
#   select(-depmap_id) %>% 
#   cor(use = "pairwise.complete.obs",method = "spearman") 
# 
# colnames(cor_df_sen) <- row.names(cor_df_sen)
# cor_df_sen <- as_tibble(cor_df_sen)  %>% 
#   # rowid_to_column()
#   mutate(drug1= row.names(cor_df_sen)) %>% 
#   pivot_longer(cols = -drug1,names_to= "drug2") %>% arrange(drug1,drug2)
# 
# tmp <- inner_join(cor_df_predicted_target,cor_df_sen,by=c("drug1", "drug2")) 
# fig1 <- tmp %>% 
#   ggplot(aes(x=value.x, y=value.y)) +
#   geom_point(size=0.2)+
#   xlab("Supervised prediction target similiarity")+
#   ylab("Sensitivity similiarity")+
#   theme_classic()
#   # ggtitle("COR 0.74, p<2.2e-16")
# # cor.test(tmp$value.x, tmp$value.y) 
# 
# tmp1 <- inner_join(cor_df_unpred_target,cor_df_sen,by=c("drug1", "drug2")) 
# fig2 <- tmp1 %>% 
#   ggplot(aes(x=value.x, y=value.y)) +
#   geom_point(size=0.2)+
#   xlab("Unsupervised prediction target similiarity")+
#   ylab("Sensitivity similiarity")+
#   theme_classic()
#   # ggtitle("COR 0.88, p<2.2e-16")
#   
# # cor.test(tmp1$value.x, tmp1$value.y)
# fig1 
# fig2
# setwd("~/cluster_wrk/drug_moa/predicting_prism/fig_res")
# ggsave(filename = "figs3.tiff",plot = fig1,device = "tiff",width = 10,height = 10,units = "cm")
# ggsave(filename = "figs4.tiff",plot = fig2,device = "tiff",width = 10,height = 10,units = "cm")
```



Combine the incorrectly predicted drugs and drugs without target info together
include the average sensitivity (perhaps also the number of sensitive cell lines)
as an indicator.

Think about how accurate is accurate? for an AUC of 0.8 /0.9 is quite high but the
putative target is still not the top one prediction.

now we have both supervised and unsupervised prediction accuracy! Despite there are some 
NA due to the lack of cover of existing target from ConSen-sig gene. 
(only 8 drugs so not so worrying)

report statistics in the manuscript
```{r}
# get_auc_mean <- function(df){mean(df$auc, na.rm = T)}
# get_auc_variance <- function(df){sd(df$auc, na.rm = T)}
# get_nub_sencell <- function(df,thre){sum(df$auc<thre, na.rm = T)}
# Sen_sum <- prism_data %>% 
#   select(BROAD_ID, sensitivity) %>% 
#   mutate(
#     sen_mean=map_dbl(.x = sensitivity, .f = get_auc_mean),
#     sen_sd=map_dbl(.x = sensitivity, .f = get_auc_variance),
#     nub_sencell_0.8=map_dbl(.x = sensitivity, .f = ~get_nub_sencell(df = .x, thre = 0.8)),
#     nub_sencell_0.7=map_dbl(.x = sensitivity, .f = ~get_nub_sencell(df = .x, thre = 0.7))
#          ) %>% 
#   select(-sensitivity)
```


for non-oncology drugs listed in the 305 prism
```{r}
# prism_good_fitted_nononcologydrugs_notannotated_df <- prism_sc_drug %>% 
#   filter(broad_id %in% setdiff(prism_good_fitted_drugs, prism_good_fitted_drugs_annotated)) %>% 
#   filter(drug_category== "noncancer") %>% 
#   inner_join(
#     prism_data %>% 
#       select(-target, - sensitivity, -moa, -drug_category), by=c("broad_id"= "BROAD_ID") 
#     ) %>% 
#   mutate(acc=NaN) %>% 
#   mutate(auc=NaN) %>% 
#   mutate(target=NA) %>% 
#   # rename(drug_category=Drug_category) %>% 
#   rename(drug=broad_id)
# 
# 
# prism_good_fitted_nononcologydrugs_annotated_df <- prism_268_all %>% 
#   filter(drug_category=="noncancer") %>% 
#   select(-Drug_category) %>% 
#   select(-test_idx) %>% 
#   left_join(prism_sc_drug %>% select(broad_id, target), by= c("drug" = "broad_id")) 
# 
# prism_nononcology_df <- union(prism_good_fitted_nononcologydrugs_notannotated_df,
#                               prism_good_fitted_nononcologydrugs_annotated_df) %>% 
#   inner_join(Sen_sum,by=c("drug"= "BROAD_ID")) %>% 
#   # inner_join(bimodality ,by="drug") %>% 
#   select(-drug_category, -smiles) %>% 
#   relocate(name)
```


```{r}
# get the combined table for 58 nononcology drugs

# get_top_n_target <- function(pred_tibble, res_type="short_table", n_pred= 5){
#   
#   tmp <- pred_tibble %>% 
#     pivot_longer(cols = -target, values_to= "pred", names_to= "drug") %>% 
#     group_by(drug) %>% 
#     slice_max(order_by = pred, n= n_pred) %>% 
#     ungroup() %>% 
#     select(-pred)
#     
#   tmp1 <- tmp %>% 
#     group_by(drug) %>%
#     summarise(target=paste(target,collapse = ",")) %>% 
#     ungroup() 
#   
#   if (res_type== "long_table"){return(tmp)}
#   if (res_type== "short_table"){return(tmp1)}
#   
# }
# 
# 
# # supervised_top5 <- get_top_n_target(pred_tibble = pred_58_supervised)
# # unsupervised_top5 <- get_top_n_target(pred_tibble = pred_58_unsupervised)
# # 
# # prism_nononcology_df <- prism_nononcology_df %>% 
# #   inner_join(supervised_top5 %>% rename(supervised_target= target)) %>% 
# #   inner_join(unsupervised_top5 %>% rename(unsupervised_target= target)) %>% 
# #   inner_join(bimodality_df, by=c("drug"= "BROAD_ID")) %>% 
# #   rename(putative_target=target) %>% 
# #   rename(supervised_pred_accuracy= acc) %>% 
# #   rename(unsupervised_pred_accuracy= auc) 
# # write_csv(prism_nononcology_df, "prism_nononcology_df.csv")  
```

plot the sensitivity distributions for the 58 drugs!
```{r,fig.width=10,fig.height=1.5}
# plot_hist_sen <- function(drug_id, add_title= T){
#   df <- prism_data %>% 
#     filter(BROAD_ID %in%  drug_id) %>% 
#     pull(sensitivity)
# 
#   df <- df[[1]]
#   
#   fig <- df %>% 
#     ggplot() +
#     geom_histogram(aes(x= auc),binwidth = 0.02)
#   
#   if (add_title== T){
#     title <- prism_nononcology_df %>% 
#     filter(drug==drug_id) %>% select(drug, name, bi_coef) %>% 
#     mutate(bi_coef= round(bi_coef,digits = 3)) %>% 
#     unlist() %>% paste(collapse = ";")
#    fig <- fig+ ggtitle(title)
#   }
#   return(fig)
# }
# 
# # plot_hist_sen(drug_id = "BRD-K37865504") 
# # plot_hist_sen(drug_id = "BRD-K72815923")+xlim(c(0,2.4))
# plot_hist_sen(drug_id = "BRD-K69726342")+xlim(c(0,2.2))
# # for (drug in prism_good_fitted_nononcologydrugs){
# #   fig <- plot_hist_sen(drug_id = drug)
# #   ggsave(
# #     device = "tiff",
# #     plot = fig,
# #     # width = 3,
# #     # height = 3,
# #     filename = paste("~/cluster_wrk/drug_moa/predicting_prism/fig_sen_distribution/", drug, ".tiff",collapse = "",sep="")
# #   )
# #   }
```
