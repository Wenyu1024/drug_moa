---
title: "reverse_modelling_analysis"
author: "Wenyu"
date: "5/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
fig_res  <- "~/cluster_wrk/drug_moa/sensitivity_fitting/fig_res"

```

```{r}
library(tidyverse)
library(tidymodels)
load("~/cluster_scratch/ctrp/ctrpv2_data.RData")

ces <- read_csv("~/cluster_scratch/impute_ess_20q4/ces1_478.csv")
ceres <- read_csv("~/cluster_scratch/impute_ess_20q4/ceres_478.csv")
demeter2 <- read_csv("~/cluster_scratch/impute_ess_20q4/demeter2_478.csv")
```


```{r}
ctrpv2_reverse_modeling <- ctrpv2_data %>% 
  mutate(reverse_modelling_data = map2(.x = sensitivity, .y = target,
                                       .f = function(x,y){
                                         tmp <- x %>% select(area_under_curve, DepMap_ID) 
                                         
                                         tmp1 <- ceres %>% 
                                           select(one_of(c("DepMap_ID",y$gene_symbol_of_protein_target))) %>% 
                                           rename_if(.predicate = !(names(.) %in% "DepMap_ID"),
                                                     .fun= ~paste0(.,"_ceres"))
                                         
                                         tmp2 <- demeter2 %>% 
                                           select(one_of(c("DepMap_ID",y$gene_symbol_of_protein_target))) %>% 
                                           rename_if(.predicate = !(names(.) %in% "DepMap_ID"),
                                                     .fun= ~paste0(.,"_demeter2"))
                                         tmp3 <- ces %>%
                                           select(one_of(c("DepMap_ID",y$gene_symbol_of_protein_target))) %>%
                                           rename_if(.predicate = !(names(.) %in% "DepMap_ID"),
                                                     .fun= ~paste0(.,"_ces"))

                                         
                                         tmp %>% 
                                           inner_join(tmp1, by="DepMap_ID") %>%
                                           inner_join(tmp2, by="DepMap_ID") %>%
                                           inner_join(tmp3, by="DepMap_ID") %>%
                                           select(-DepMap_ID) %>% 
                                           drop_na()
                                       }
  )
  )
```


characterize availability and sample size, generate the cv structure
```{r}
# ctrpv2_reverse_modeling <- ctrpv2_reverse_modeling %>% 
#   mutate(avaliable_obs= map_int(reverse_modelling_data, nrow))

#mark those whose target is not avaliable from ess data
set.seed(0000)
get_train_test <- 
  function(df){
    df <- df %>% 
      mutate(training_data = map(splits, ~analysis(.x))) %>% 
      mutate(testing_data = map(splits, ~assessment(.x))) 
  }


reverse_modeling_CV <- ctrpv2_reverse_modeling %>%
  ungroup() %>% 
  mutate(avaliable_obs= map_int(reverse_modelling_data, nrow)) %>% 
  mutate(model_possibility= map_lgl(.x = reverse_modelling_data, 
                               .f = function(x){
                                 # length(intersect(x %>% pull(DepMap_ID), ces$DepMap_ID))
                                 ncol(x) > 2
                                 }
                               )) %>% 
  select(master_cpd_id, reverse_modelling_data,  model_possibility) %>%
  filter(model_possibility) %>%
  select(-model_possibility) %>%
  mutate(cv_split =
           map(reverse_modelling_data, ~vfold_cv(.x, v = 5) ) ) %>%
  select(-reverse_modelling_data)%>%
  mutate(cv_split = map(cv_split, get_train_test))

# what is the difference between training&testing function and analysis&assessment function?
# I found no difference...
# tmp <- df %>% mutate(training_data = map(splits, ~training(.x)))
# tmp1 <- df %>% mutate(training_data = map(splits, ~analysis(.x)))
# identical(tmp, tmp1)
save.image("~/cluster_scratch/reverse_modelling/reverse_serverinput.RData")
```


Now I have a deeply nested df:
in reverse_modeling_cv, each line is a drug, 
in the cv_split column, each element is a dataframe with 5 rows, 
each row corresponding to 5 fold training data and 5 fold testing data


I desiged a deep function termed train_and_test to return a result df for each drug (15 rows for 3 matrics* 5 fold for three modeling strategy(3 columns)) 

analysis is moved to server to accelerate.
```{r}
#testing the function
# data = reverse_modeling_CV %>% filter(master_cpd_id== "687954") %>% pull(cv_split) 
# data <- data[[1]]
# 
# tmp <- train_and_pred(df = data)


######################### debugging code
# res_list <- vector("list", length = 358)
# for (i in 1:358){
#   # i=2
#   print(i)
#   data <- reverse_modeling_CV$cv_split[[i]]
#   # res_list[[i]] <- train_and_pred(data)
#   tryCatch(
#     # expr = res_list[[i]] <- train_and_pred(data),
#     expr =    res_list[[i]] <- train_and_pred(data),
#     error = function(e){ skip_to_next <<- TRUE}
#     )
#   if(skip_to_next) {
#     # messange= str_c(c("problem in",i),collapse = " ")
#     # print(message)
#     next } 
#   # else {res_list[[i]] <- train_and_pred(data)}
# }

############## analysis is moved to server to accelerate.

# res_list <- vector("list", length = 354)
# for (i in 1:354){
#   # i=2
#   print(i)
#   data <- reverse_modeling_CV$cv_split[[i]]
#   res_list[[i]] <- train_and_pred(data)}
```

now I have list with each element being the df I mentioned earlier
Lets pull the result out so that it would be easier to check/compute the summary level statistics

```{r}
load("~/cluster_scratch/reverse_modelling/reverse_serverinput.RData")
load("~/cluster_scratch/reverse_modelling/reverse_modelling_res.RData")
reverse_modeling_result <- reverse_modeling_CV %>% 
  mutate(res= res_list) %>% 
  select(master_cpd_id,res) %>% 
  unnest() %>% 
  group_by(master_cpd_id, method) %>% 
  summarise(mean_cor_estimate= median(cor)) %>% 
  ungroup()

reverse_modeling_result %>% 
  group_by(method) %>% 
  summarise(mean_perf= median(mean_cor_estimate))
```
check which data point is actually drug pair rather than single drug
```{r}
drugpair_data <- ctrpv2_data %>% filter(str_detect(cpd_smiles, "\\."))
drugpair_idlist <- drugpair_data$master_cpd_id

# drugpair_data %>% filter(cpd_name %in% "BRD-M00053801") %>% pull(cpd_smiles)
```


now  generate the images using the result
```{r, fig.width=2.5,fig.height=2}
fig  <- reverse_modeling_result %>% 
  filter(master_cpd_id %in% drugpair_idlist) %>% 
  ggplot(aes(x= method, y= mean_cor_estimate))+
  geom_boxplot(outlier.size = 0.3) +
  theme_classic() +
  coord_flip()+
  scale_x_discrete(labels=c("DEMETER", "CES", "CERES"))+
  # xlab("Essentiality scoring metric")+
  ylab("Accuracy (Spearman Cor)")
fig
```


```{r}
ggsave(fig, filename = "fig2b.pdf",path = fig_res,width = 2.5,height = 2.5,units = "in")  
```


Several EGFR inhibitors for

BRD-K70401845 52928
```{r}

ess <- ces %>% select(one_of("DepMap_ID", "EGFR", "ERBB2"))
	
erlotinib <- ctrpv2_data %>% filter(master_cpd_id== "52928") %>% pull(sensitivity) 
	
erlotinib <- 	erlotinib[[1]]

data <- inner_join(ess, erlotinib)#,by=c("Depmap ID"="DepMap_ID")) 
```


```{r,fig.width=3,fig.height=2.5}
cor.test(x = data$EGFR, y = data$area_under_curve)#,method = "spearman")
fig  <- data %>% ggplot(aes(x= EGFR, y = area_under_curve/15)) +
  geom_point(size=0.2)+
  theme_classic()+
  xlab("EGFR inhibition effect (CES)")+
  ylab("Drug sensitivity (AUC)")+
  ggtitle("Erlotinib cor  0.48")


fig

ggsave(fig, filename = "fig2d.pdf",path = fig_res,width = 2.5,height = 2.5,units = "in")  
```


HDAC3 	
Repligen 136
BRD-K47503321
628408
```{r}

ess <- ces %>% select(one_of("DepMap_ID", "HDAC3"))
	
repligen136 <- ctrpv2_data %>% filter(master_cpd_id== "628408") %>% pull(sensitivity) 
	
repligen136 <- 	repligen136[[1]]

data <- inner_join(ess, repligen136)#,by=c("Depmap ID"="DepMap_ID")) 
```


```{r,fig.width=3,fig.height=2.5}
cor.test(x = data$HDAC3, y = data$area_under_curve)#,method = "spearman")
fig  <- data %>% ggplot(aes(x= HDAC3, y = area_under_curve/15)) +
  geom_point(size=0.2)+
  theme_classic()+
  xlab("HDAC3 inhibition effect (CES)")+
  ylab("Drug sensitivity (AUC)")+
  ggtitle("Repligen136 cor  -0.01")

fig

ggsave(fig, filename = "fig2d.pdf",path = fig_res,width = 2.5,height = 2.5,units = "in")  
```




